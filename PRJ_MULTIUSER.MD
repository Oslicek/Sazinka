# Podpora v√≠ce u≈æivatel≈Ø ‚Äì Anal√Ωza a implementaƒçn√≠ pl√°n

> **Vytvo≈ôeno:** 2026-02-04
> **Posledn√≠ aktualizace:** 2026-02-07
> **Status:** ‚úÖ Implementov√°no (F√°ze 1‚Äì4)

---

## 1. Souƒçasn√Ω stav

Aplikace je **architektonicky p≈ôipravena na v√≠ce u≈æivatel≈Ø**, ale autentizace nen√≠ implementov√°na. V≈°ude se pou≈æ√≠v√° hardcoded `TEMP_USER_ID = '00000000-0000-0000-0000-000000000001'`.

### Co u≈æ existuje

| Oblast | Stav | Detail |
|--------|------|--------|
| DB sch√©ma | ‚úÖ P≈ôipraveno | V≈°echny tabulky maj√≠ `user_id` s FK na `users`, kask√°dov√© maz√°n√≠ |
| Tabulka `users` | ‚úÖ Existuje | `email`, `password_hash`, `name`, nastaven√≠, adresa |
| DB dotazy pro u≈æivatele | ‚úÖ Existuj√≠ | `get_user(id)`, `get_user_by_email(email)` |
| Typ `User` / `UserPublic` | ‚úÖ Existuje | `worker/src/types/user.rs` |
| NATS `Request<T>` | ‚úÖ Obsahuje `userId` | `packages/shared-types/src/messages.ts`, `worker/src/types/messages.rs` |
| Backend handlery | ‚úÖ Validuj√≠ `user_id` | Vrac√≠ `UNAUTHORIZED` pokud chyb√≠ |
| SQL dotazy | ‚úÖ Filtruj√≠ podle `user_id` | Data izolov√°na |
| Job status subscriptions | ‚úÖ User-scoped | `sazinka.user.${userId}.jobs.>` |

### Co bylo implementov√°no

| Oblast | Stav |
|--------|------|
| Auth handler na backendu (register, login, verify) | ‚úÖ `worker/src/handlers/auth.rs` |
| Login / registraƒçn√≠ str√°nka | ‚úÖ `apps/web/src/pages/Login.tsx`, `Register.tsx` |
| JWT generov√°n√≠ a validace | ‚úÖ `worker/src/auth.rs` (jsonwebtoken + argon2) |
| Auth store ve frontendu (Zustand) | ‚úÖ `apps/web/src/stores/authStore.ts` |
| Protected routes + role guards | ‚úÖ `ProtectedRoute` component, updated `routes/index.tsx` |
| Hashov√°n√≠ hesel (Argon2) | ‚úÖ `worker/src/auth.rs` |
| Rate limiting (in-memory) | ‚úÖ `worker/src/handlers/auth.rs` (RateLimiter) |
| Sloupec `role` a `owner_id` v `users` | ‚úÖ `worker/migrations/002_add_auth_fields.sql` |
| V≈°echny handlery ‚Üí `extract_auth()` | ‚úÖ 13 handler soubor≈Ø aktualizov√°no |
| Odstranƒõn√≠ TEMP_USER_ID (22 soubor≈Ø) | ‚úÖ V≈°echny nahrazeny `getToken()` |
| Worker management (backend + frontend) | ‚úÖ Backend + Settings tab "Pracovn√≠ci" |
| Admin hardening (role check) | ‚úÖ Admin handler vy≈æaduje `role == "admin"` |
| Settings page role guard | ‚úÖ Pouze customer/admin |

### Rozsah hardcoded `TEMP_USER_ID` (22 soubor≈Ø)

**Str√°nky (11):** `Dashboard`, `Calendar`, `Customers`, `CustomerDetail`, `CustomerSummary`, `RevisionDetail`, `Settings`, `Planner`, `PlanningInbox`, `Admin`, `CallQueue`

**Slu≈æby (7):** `jobService`, `geometryService`, `routeService`, `exportService`, `visitService`, `communicationService`, `crewService`

**Komponenty (2):** `CustomerPreviewPanel`, `ImportModal`

**Import (2):** `ImportCustomersModal`, `importBatchService`

**Backend (1):** `admin.rs` ‚Äì `handle_db_reset()`

---

## 2. Rozhodnut√≠ (MVP)

| Ot√°zka | Rozhodnut√≠ |
|--------|-----------|
| Token storage | `localStorage` (JS) ‚Äì NATS.ws nem√° HTTP headers |
| NATS subjects | Nemƒõnit. `user_id` se odvozuje z JWT na backendu |
| Job subjects | Ponechat `sazinka.user.${userId}.jobs.>` ‚Äì userId z auth store |
| Rate limiting | Jednoduch√Ω in-memory limiter v auth handleru |
| Password reset | Zat√≠m neimplementovat |
| Email confirmation | Zat√≠m neimplementovat |

---

## 3. Role-based access (RBAC)

| Role | K√≥d | P≈ô√≠stup | Kdo vytv√°≈ô√≠ |
|------|-----|---------|-------------|
| **Admin** | `admin` | Cel√Ω syst√©m vƒçetnƒõ str√°nky Admin | Syst√©m / seed |
| **Customer** | `customer` | Sv√° data + Settings + Workers | Registrace |
| **Worker** | `worker` | V≈°echny str√°nky kromƒõ Admin a Settings | Customer |

### Matice p≈ô√≠stupu ke str√°nk√°m

| Str√°nka | Admin | Customer | Worker |
|---------|-------|----------|--------|
| Dashboard | ‚úÖ | ‚úÖ | ‚úÖ |
| Z√°kazn√≠ci | ‚úÖ | ‚úÖ | ‚úÖ |
| Detail z√°kazn√≠ka | ‚úÖ | ‚úÖ | ‚úÖ |
| Kalend√°≈ô | ‚úÖ | ‚úÖ | ‚úÖ |
| Fronta | ‚úÖ | ‚úÖ | ‚úÖ |
| Pl√°n dne | ‚úÖ | ‚úÖ | ‚úÖ |
| √ölohy | ‚úÖ | ‚úÖ | ‚úÖ |
| **Nastaven√≠** | ‚úÖ | ‚úÖ | ‚ùå |
| **Admin** | ‚úÖ | ‚ùå | ‚ùå |
| Login / Register | üîì | üîì | üîì |

### Matice p≈ô√≠stupu k backend akc√≠m

| Akce | Admin | Customer | Worker |
|------|-------|----------|--------|
| CRUD z√°kazn√≠k≈Ø, za≈ô√≠zen√≠, reviz√≠ | ‚úÖ | ‚úÖ | ‚úÖ |
| Pl√°nov√°n√≠ tras | ‚úÖ | ‚úÖ | ‚úÖ |
| Import / Export CSV | ‚úÖ | ‚úÖ | ‚ùå |
| Spr√°va pos√°dek, dep | ‚úÖ | ‚úÖ | ‚ùå |
| Zmƒõna nastaven√≠ firmy | ‚úÖ | ‚úÖ | ‚ùå |
| DB reset, syst√©mov√© √∫lohy | ‚úÖ | ‚ùå | ‚ùå |
| Spr√°va Workers | ‚ùå | ‚úÖ | ‚ùå |

### Datov√° izolace

- **Customer** vid√≠ jen sv√° data (filtr `user_id`).
- **Worker** pat≈ô√≠ ke Customeru ‚Äì vid√≠ data sv√©ho Customera.
- **Admin** vid√≠ v≈°e (bez filtru `user_id`, nebo p≈ôes speci√°ln√≠ query).

**D≈Øsledek pro DB:**
- P≈ôidat sloupec `role` do tabulky `users`: `VARCHAR(20) NOT NULL DEFAULT 'customer'`
- Pro Workers: p≈ôidat sloupec `owner_id UUID REFERENCES users(id)` ‚Äì FK na Customer, kter√Ω Workera vytvo≈ôil
- Worker dƒõd√≠ `user_id` sv√©ho ownera pro datov√© dotazy (vid√≠ stejn√° data jako jeho Customer)

---

## 4. Implementaƒçn√≠ pl√°n

### F√°ze 1: DB migrace + backend auth

**C√≠l:** Backend podporuje register/login, vrac√≠ JWT s rol√≠, validuje tokeny ve v≈°ech handlerech.

#### 1.1 DB migrace

**Soubor:** `worker/migrations/NNN_add_auth_fields.sql`

```sql
-- Role a owner (pro Workers)
ALTER TABLE users ADD COLUMN role VARCHAR(20) NOT NULL DEFAULT 'customer';
ALTER TABLE users ADD COLUMN owner_id UUID REFERENCES users(id) ON DELETE CASCADE;
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_owner ON users(owner_id);

-- Aktualizovat existuj√≠c√≠ho dev u≈æivatele
UPDATE users SET role = 'admin' WHERE id = '00000000-0000-0000-0000-000000000001';
```

#### 1.2 Nov√© Rust crates

**Soubor:** `worker/Cargo.toml` ‚Äì p≈ôidat:

```toml
argon2 = "0.5"
jsonwebtoken = "9"
```

#### 1.3 JWT modul

**Nov√Ω soubor:** `worker/src/auth.rs`

```
- struct Claims { sub: Uuid, email: String, role: String, exp: usize, iat: usize }
- fn generate_token(user_id, email, role, secret) -> Result<String>
- fn validate_token(token, secret) -> Result<Claims>
- fn hash_password(password) -> Result<String>
- fn verify_password(password, hash) -> Result<bool>
```

`JWT_SECRET` se naƒçte v `Config` z env var.

#### 1.4 Auth handler

**Nov√Ω soubor:** `worker/src/handlers/auth.rs`

| NATS subject | Funkce | Vstup | V√Ωstup | Auth? |
|-------------|--------|-------|--------|-------|
| `sazinka.auth.register` | `handle_register` | email, password, name, business_name | JWT + UserPublic | NE |
| `sazinka.auth.login` | `handle_login` | email, password | JWT + UserPublic | NE |
| `sazinka.auth.verify` | `handle_verify` | token | UserPublic | ANO (token) |

**Rate limiting:**
- In-memory `HashMap<String, Vec<Instant>>` (kl√≠ƒç = email nebo IP-like identifik√°tor)
- Max 5 ne√∫spƒõ≈°n√Ωch login pokus≈Ø / 5 minut / email
- Po p≈ôekroƒçen√≠: `ErrorResponse` s k√≥dem `RATE_LIMITED`
- Cleanup star√Ωch z√°znam≈Ø periodicky

#### 1.5 Roz≈°√≠≈ôen√≠ `Request<T>`

**Soubor:** `worker/src/types/messages.rs`

```rust
pub struct Request<T> {
    pub id: Uuid,
    pub timestamp: DateTime<Utc>,
    pub user_id: Option<Uuid>,   // DEPRECATED ‚Äì ignorovat na backendu
    pub token: Option<String>,   // NOV√â ‚Äì JWT access token
    pub payload: T,
}
```

**Soubor:** `packages/shared-types/src/messages.ts`

```typescript
export interface Request<T> {
  id: string;
  timestamp: string;
  userId?: string;    // DEPRECATED
  token?: string;     // NOV√â
  payload: T;
}
```

#### 1.6 Helper pro extrakci user_id z tokenu

**Soubor:** `worker/src/auth.rs` (roz≈°√≠≈ôen√≠)

```rust
/// Extrahuje user_id z requestu:
/// 1. Pokud je token ‚Üí validovat ‚Üí user_id z claims
/// 2. Pokud je jen user_id (legacy dev) ‚Üí pou≈æ√≠t p≈ô√≠mo (jen v dev mode)
/// 3. Jinak ‚Üí UNAUTHORIZED
pub fn extract_user_id(request: &Request<T>, jwt_secret: &str) -> Result<(Uuid, String)>
// Vrac√≠ (user_id, role)
```

#### 1.7 Aktualizace handler≈Ø

Ka≈æd√Ω handler aktu√°lnƒõ dƒõl√°:
```rust
let user_id = match request.user_id {
    Some(id) => id,
    None => { /* UNAUTHORIZED */ }
};
```

Nahradit za:
```rust
let (user_id, role) = match auth::extract_user_id(&request, &jwt_secret) {
    Ok(result) => result,
    Err(_) => { /* UNAUTHORIZED */ }
};
```

Handlery, kter√© vy≈æaduj√≠ specifickou roli (settings, admin, import), p≈ôidaj√≠ kontrolu:
```rust
if role != "admin" && role != "customer" {
    /* FORBIDDEN */
}
```

**Pozn.:** `jwt_secret` se mus√≠ p≈ôedat jako `Arc<String>` do ka≈æd√©ho handleru. To vy≈æaduje √∫pravu signatur v≈°ech `handle_*` funkc√≠ a `start_handlers`.

#### 1.8 Rust typy pro User

**Soubor:** `worker/src/types/user.rs` ‚Äì roz≈°√≠≈ôen√≠:

```rust
pub struct User {
    // ... existuj√≠c√≠ pole ...
    pub role: String,
    pub owner_id: Option<Uuid>,
}

pub struct UserPublic {
    // ... existuj√≠c√≠ pole ...
    pub role: String,
}
```

#### 1.9 DB query pro registraci

**Soubor:** `worker/src/db/queries/user.rs` ‚Äì p≈ôidat:

```rust
pub async fn create_user(pool, email, password_hash, name, business_name, role) -> Result<User>
```

#### 1.10 Worker user_id resolution

Kdy≈æ se p≈ôihl√°s√≠ Worker, jeho re√°ln√© `user_id` pro datov√© dotazy je `owner_id` (Customer, kter√Ω ho vytvo≈ôil). Helper:

```rust
pub async fn resolve_data_user_id(pool, user_id, role, owner_id) -> Uuid {
    if role == "worker" { owner_id.unwrap() } else { user_id }
}
```

#### 1.11 Testy (TDD)

**Soubory:**
- `worker/src/auth.rs` ‚Äì unit testy pro `generate_token`, `validate_token`, `hash_password`, `verify_password`
- `worker/src/handlers/auth.rs` ‚Äì testy pro register, login, verify, rate limiting

---

### F√°ze 2: Frontend auth flow

**C√≠l:** Login str√°nka, auth store, protected routes, role-based navigace.

#### 2.1 Shared types

**Soubor:** `packages/shared-types/src/auth.ts` (nov√Ω)

```typescript
export interface LoginRequest { email: string; password: string; }
export interface RegisterRequest { email: string; password: string; name: string; businessName?: string; }
export interface AuthResponse { token: string; user: UserPublic; }
export interface UserPublic { id: string; email: string; name: string; role: string; phone?: string; businessName?: string; }
```

#### 2.2 Auth store

**Nov√Ω soubor:** `apps/web/src/stores/authStore.ts`

```typescript
interface AuthState {
  user: UserPublic | null;
  token: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  
  login: (email: string, password: string) => Promise<void>;
  register: (data: RegisterRequest) => Promise<void>;
  logout: () => void;
  verify: () => Promise<void>;     // ovƒõ≈ôit token z localStorage p≈ôi startu
  getToken: () => string | null;
  getUserId: () => string;          // pro NATS subscriptions
  getRole: () => string;
}
```

Persistence: `localStorage.setItem('sazinka_token', token)`

#### 2.3 Roz≈°√≠≈ôen√≠ `createRequest`

**Soubor:** `packages/shared-types/src/messages.ts`

```typescript
export function createRequest<T>(token: string | undefined, payload: T): Request<T> {
  return {
    id: crypto.randomUUID(),
    timestamp: new Date().toISOString(),
    token,      // JWT token m√≠sto userId
    payload,
  };
}
```

#### 2.4 Auth helper

**Nov√Ω soubor:** `apps/web/src/utils/auth.ts`

```typescript
import { useAuthStore } from '@/stores/authStore';

/** Vr√°t√≠ aktu√°ln√≠ token pro NATS requesty */
export function getToken(): string {
  const token = useAuthStore.getState().token;
  if (!token) throw new Error('Not authenticated');
  return token;
}

/** Vr√°t√≠ userId pro NATS subscriptions (job status) */
export function getUserId(): string {
  const user = useAuthStore.getState().user;
  if (!user) throw new Error('Not authenticated');
  return user.id;
}

/** Kontrola role */
export function hasRole(...roles: string[]): boolean {
  const role = useAuthStore.getState().user?.role;
  return role ? roles.includes(role) : false;
}
```

#### 2.5 Login str√°nka

**Nov√© soubory:** `apps/web/src/pages/Login.tsx` + `Login.module.css`

- Formul√°≈ô: email + heslo
- Vol√° `authStore.login()` ‚Üí `sazinka.auth.login`
- Redirect na `/` po √∫spƒõ≈°n√©m p≈ôihl√°≈°en√≠
- Zobrazen√≠ chybov√© hl√°≈°ky (≈°patn√© heslo, rate limited)
- Odkaz na registraci

#### 2.6 Registraƒçn√≠ str√°nka

**Nov√© soubory:** `apps/web/src/pages/Register.tsx` + `Register.module.css`

- Formul√°≈ô: jm√©no, email, heslo, n√°zev firmy
- Validace (unik√°tn√≠ email, min d√©lka hesla)
- Auto-login po registraci
- Odkaz na login

#### 2.7 Protected routes

**Soubor:** `apps/web/src/routes/index.tsx`

```typescript
// Nov√© routes
const loginRoute = createRoute({ path: '/login', component: Login });
const registerRoute = createRoute({ path: '/register', component: Register });

// beforeLoad guard na rootRoute:
const rootRoute = createRootRoute({
  beforeLoad: () => {
    const { isAuthenticated } = useAuthStore.getState();
    if (!isAuthenticated && location.pathname !== '/login' && location.pathname !== '/register') {
      throw redirect({ to: '/login' });
    }
  },
  component: () => <Layout><Outlet /></Layout>,
});

// Role guards:
const adminRoute = createRoute({
  path: '/admin',
  beforeLoad: () => {
    if (!hasRole('admin')) throw redirect({ to: '/' });
  },
  component: Admin,
});

const settingsRoute = createRoute({
  path: '/settings',
  beforeLoad: () => {
    if (!hasRole('admin', 'customer')) throw redirect({ to: '/' });
  },
  component: Settings,
});
```

#### 2.8 Layout ‚Äì u≈æivatelsk√© menu

**Soubor:** `apps/web/src/components/Layout.tsx`

- Zobrazit jm√©no p≈ôihl√°≈°en√©ho u≈æivatele + roli
- Skr√Ωt navigaƒçn√≠ polo≈æky podle role (Admin, Nastaven√≠)
- P≈ôidat tlaƒç√≠tko Odhl√°sit se
- Po odhl√°≈°en√≠ redirect na `/login`

#### 2.9 Testy

- `apps/web/src/stores/authStore.test.ts` ‚Äì login, logout, verify, persistence
- `apps/web/src/pages/Login.test.tsx` ‚Äì render, submit, error states
- `apps/web/src/routes/guards.test.ts` ‚Äì protected routes, role redirects

---

### F√°ze 3: Odstranƒõn√≠ TEMP_USER_ID

**C√≠l:** ≈Ω√°dn√Ω hardcoded UUID v k√≥du. V≈°echny requesty pos√≠laj√≠ JWT token.

#### 3.1 Refaktor slu≈æeb (services)

V≈°echny slu≈æby aktu√°lnƒõ p≈ôij√≠maj√≠ `userId` jako prvn√≠ parametr:
```typescript
export async function listCustomersExtended(userId: string, options: ...) { ... }
```

**Zmƒõna:** Slu≈æby budou internƒõ volat `getToken()`:
```typescript
export async function listCustomersExtended(options: ...) {
  const req = createRequest(getToken(), options);
  // ...
}
```

**Alternativa (jednodu≈°≈°√≠, doporuƒçen√°):** Ponechat `userId` parametr, ale str√°nky ho budou br√°t z `getUserId()` m√≠sto konstanty. To minimalizuje diff.

#### 3.2 √öprava 22 soubor≈Ø

V ka≈æd√©m souboru:
1. Smazat `const TEMP_USER_ID = '...'` / `const USER_ID = '...'`
2. Importovat `getToken` / `getUserId` z `@/utils/auth`
3. Nahradit `TEMP_USER_ID` za `getUserId()` v callech
4. Pro `createRequest` vol√°n√≠: p≈ôedat `getToken()` m√≠sto `userId`

#### 3.3 Ovƒõ≈ôen√≠ √∫plnosti

```bash
rg "TEMP_USER_ID|00000000-0000-0000-0000-000000000001" apps/ packages/
# Mus√≠ vr√°tit 0 v√Ωsledk≈Ø (kromƒõ test≈Ø a seed soubor≈Ø)
```

#### 3.4 Aktualizace test≈Ø

St√°vaj√≠c√≠ testy (nap≈ô. `Customers.test.tsx`) mockuj√≠ `TEMP_USER_ID`. Aktualizovat na mock auth store:

```typescript
vi.mock('@/stores/authStore', () => ({
  useAuthStore: { getState: () => ({ user: { id: 'test-user-id', role: 'customer' }, token: 'test-jwt' }) },
}));
```

#### 3.5 Dev seed aktualizace

**Soubor:** `infra/seed-dev.sql`
- Zmƒõnit `password_hash` na re√°ln√Ω argon2 hash pro dev heslo (nap≈ô. `password123`)
- P≈ôidat `role = 'admin'`

---

### F√°ze 4: Worker management (Customer vytv√°≈ô√≠ Workers)

**C√≠l:** Customer m≈Ø≈æe ve Settings vytvo≈ôit Workers, kte≈ô√≠ vid√≠ jeho data.

#### 4.1 Backend

- `sazinka.auth.create_worker` ‚Äì Customer vytvo≈ô√≠ Worker √∫ƒçet (email, heslo, jm√©no)
  - Backend nastav√≠ `role = 'worker'`, `owner_id = customer.user_id`
- `sazinka.auth.list_workers` ‚Äì Customer vid√≠ sv√© Workers
- `sazinka.auth.delete_worker` ‚Äì Customer sma≈æe sv√©ho Workera

#### 4.2 Frontend ‚Äì Settings tab

- Nov√Ω tab ‚ÄûPracovn√≠ci" v Settings (viditeln√Ω jen pro Customer)
- CRUD: seznam, p≈ôidat, smazat Worker
- Formul√°≈ô: jm√©no, email, heslo

#### 4.3 Data resolution

Worker p≈ôihl√°≈°en√≠ ‚Üí backend resolvuje `owner_id` ‚Üí v≈°echny dotazy filtruj√≠ podle `owner_id` m√≠sto `user_id`.

---

## 5. Soubory k √∫pravƒõ ‚Äì kompletn√≠ seznam

### Nov√© soubory

| Soubor | F√°ze | √öƒçel |
|--------|------|------|
| `worker/migrations/NNN_add_auth_fields.sql` | 1 | P≈ôidat `role`, `owner_id` do `users` |
| `worker/src/auth.rs` | 1 | JWT + password hashing |
| `worker/src/handlers/auth.rs` | 1 | Register, login, verify handlers |
| `packages/shared-types/src/auth.ts` | 2 | Auth typy |
| `apps/web/src/stores/authStore.ts` | 2 | Auth store (Zustand) |
| `apps/web/src/utils/auth.ts` | 2 | Helpers: `getToken()`, `getUserId()`, `hasRole()` |
| `apps/web/src/pages/Login.tsx` | 2 | Login str√°nka |
| `apps/web/src/pages/Login.module.css` | 2 | Login styly |
| `apps/web/src/pages/Register.tsx` | 2 | Registrace |
| `apps/web/src/pages/Register.module.css` | 2 | Registrace styly |

### Existuj√≠c√≠ soubory k √∫pravƒõ

| Soubor | F√°ze | Zmƒõna |
|--------|------|-------|
| `worker/Cargo.toml` | 1 | P≈ôidat `argon2`, `jsonwebtoken` |
| `worker/src/main.rs` | 1 | P≈ôidat `mod auth`, naƒç√≠st `JWT_SECRET` |
| `worker/src/config.rs` | 1 | P≈ôidat `jwt_secret: String` |
| `worker/src/types/messages.rs` | 1 | P≈ôidat `token: Option<String>` do `Request<T>` |
| `worker/src/types/user.rs` | 1 | P≈ôidat `role`, `owner_id` |
| `worker/src/db/queries/user.rs` | 1 | P≈ôidat `create_user`, upravit `get_user` |
| `worker/src/handlers/mod.rs` | 1 | Registrovat auth handler, p≈ôedat `jwt_secret` |
| **V≈°echny handlery** (~15 soubor≈Ø) | 1 | `extract_user_id` m√≠sto `request.user_id` |
| `packages/shared-types/src/messages.ts` | 2 | P≈ôidat `token`, upravit `createRequest` |
| `apps/web/src/routes/index.tsx` | 2 | Login/register routes, guards |
| `apps/web/src/components/Layout.tsx` | 2 | User menu, role-based nav, logout |
| **22 frontend soubor≈Ø** | 3 | Nahradit `TEMP_USER_ID` |
| `infra/seed-dev.sql` | 3 | Re√°ln√Ω hash, `role = 'admin'` |
| `infra/docker-compose.yml` | 1 | Env var `JWT_SECRET` |

### Dokumentace

| Soubor | Zmƒõna |
|--------|-------|
| `PROJECT_CONTEXT.MD` | Auth sekce, NATS subjects |
| `PROJECT_ROADMAP.MD` | Phase 3.1 ‚Üí implementov√°no |
| `PROJECT_UX.MD` | Login/register flow, role-based UI |

---

## 6. Bezpeƒçnostn√≠ po≈æadavky p≈ôed ostr√Ωm provozem

| # | Po≈æadavek | Popis |
|---|-----------|-------|
| 1 | **TLS v≈°ude** | NATS s TLS + credentials, HTTPS pro web |
| 2 | **JWT secret management** | `JWT_SECRET` mimo repo, rotace kl√≠ƒç≈Ø, min 256 bit≈Ø |
| 3 | **Edge rate limiting** | Reverse proxy (Cloudflare / Nginx / Traefik), IP throttling, bot protection |
| 4 | **Audit log** | Logovat login pokusy, zmƒõny nastaven√≠, importy/exporty |
| 5 | **Admin endpoint hardening** | `handle_db_reset` pouze pro roli Admin, chr√°nƒõno tokeny |
| 6 | **Password policy** | Argon2 hash, min 8 znak≈Ø, brute-force ochrana (rate limit) |
| 7 | **Secrets** | Secrets v `.env` / vault, nikdy v Gitu |
| 8 | **DB backup** | Pravideln√© z√°lohy, test obnovy |
| 9 | **Monitoring** | Error rate, auth failures, job queue backlogs |
| 10 | **CORS** | Omezit povolen√© origins pro NATS.ws |

---

## 7. Odhad slo≈æitosti

| F√°ze | Popis | Rozsah | Riziko |
|------|-------|--------|--------|
| 1 | DB + backend auth | St≈ôedn√≠ (~15 soubor≈Ø) | N√≠zk√© ‚Äì p≈ô√≠moƒçar√° logika |
| 2 | Frontend auth flow | St≈ôedn√≠ (~8 soubor≈Ø) | N√≠zk√© ‚Äì standardn√≠ pattern |
| 3 | Odstranƒõn√≠ TEMP_USER_ID | Velk√© (22 soubor≈Ø) | **St≈ôedn√≠** ‚Äì mechanick√©, ale vynech√°n√≠ = bezp. d√≠ra |
| 4 | Worker management | Mal√© (~5 soubor≈Ø) | N√≠zk√© |

**Po≈ôad√≠ implementace je d≈Øle≈æit√©:** F√°ze 1 ‚Üí 2 ‚Üí 3 ‚Üí 4 (ka≈æd√° z√°vis√≠ na p≈ôedchoz√≠).

Nejvƒõt≈°√≠ riziko: **F√°ze 3** ‚Äì p≈ôi nahrazov√°n√≠ `TEMP_USER_ID` nesm√≠ z≈Østat ≈æ√°dn√Ω hardcoded UUID. Doporuƒçuji TDD + grep kontrolu po dokonƒçen√≠.

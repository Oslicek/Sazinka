# PRJ_SOLVER â€” Rezerva pÅ™Ã­jezdu jako vlastnost trasy

## Stav: NÃVRH

Tento dokument popisuje pÅ™esun parametrÅ¯ â€rezerva pÅ™Ã­jezdu" (arrival buffer) z posÃ¡dky na trasu. Rezerva se stane vlastnostÃ­ konkrÃ©tnÃ­ trasy uloÅ¾enÃ© v DB, s automatickÃ½m pÅ™edvyplnÄ›nÃ­m z poslednÃ­ch pouÅ¾itÃ½ch hodnot uÅ¾ivatele.

---

## 1. Motivace

Dnes je rezerva pÅ™Ã­jezdu (`arrival_buffer_percent`, `arrival_buffer_fixed_minutes`) nastavena na posÃ¡dce. To je nepraktickÃ©:

- UÅ¾ivatel nemÅ¯Å¾e mÃ­t rÅ¯znÃ© rezervy pro rÅ¯znÃ© trasy tÃ©Å¾e posÃ¡dky.
- ZmÄ›na na posÃ¡dce zpÄ›tnÄ› ovlivnÃ­ interpretaci vÅ¡ech starÃ½ch tras.
- Rezerva je logicky vlastnost konkrÃ©tnÃ­ trasy, ne posÃ¡dky.

### CÃ­lovÃ½ stav

- Rezerva pÅ™Ã­jezdu je **vlastnost trasy** (`routes` tabulka).
- PÅ™i tvorbÄ› novÃ© trasy se automaticky pouÅ¾ije **poslednÃ­ pouÅ¾itÃ¡ hodnota** danÃ©ho uÅ¾ivatele (z `users` tabulky).
- Na timeline detailu trasy je rezerva **viditelnÄ› uvedena drobnÃ½m pÃ­smem** a **editovatelnÃ¡** po rozkliknutÃ­.
- Z posÃ¡dky se pole `arrival_buffer_percent` a `arrival_buffer_fixed_minutes` **odstranÃ­**.

---

## 2. InventÃ¡Å™ dotÄenÃ½ch mÃ­st

### 2.1 OdstranÄ›nÃ­ z posÃ¡dky (crew)

| Soubor | Co odebrat |
|---|---|
| `worker/src/types/crew.rs` | Pole `arrival_buffer_percent` a `arrival_buffer_fixed_minutes` ze struct `Crew`, `CreateCrewRequest`, `UpdateCrewRequest` + testy |
| `worker/src/db/queries/crew.rs` | Sloupce z INSERT/UPDATE/SELECT dotazÅ¯ |
| `worker/migrations/001_initial_schema.sql` | Odebrat sloupce z `crews` tabulky |
| `worker/migrations/004_add_crew_buffer.sql` | Smazat celÃ½ soubor |
| `worker/migrations/005_fix_crew_buffer_type.sql` | Smazat celÃ½ soubor |
| `worker/migrations/014_add_crew_fixed_buffer.sql` | Smazat celÃ½ soubor |
| `apps/web/src/services/crewService.ts` | Pole z `Crew`, `CreateCrewRequest`, `UpdateCrewRequest` |
| `apps/web/src/pages/Settings.tsx` | Odebrat buffer inputy z `CrewForm` + `CrewFormData` + create/update volÃ¡nÃ­ |
| `apps/web/public/locales/{cs,en,sk}/settings.json` | KlÃ­Äe `crew_arrival_buffer_*` (4 klÃ­Äe Ã— 3 jazyky) |

### 2.2 PÅ™idÃ¡nÃ­ na trasu (route)

| Soubor | Co pÅ™idat |
|---|---|
| `worker/migrations/001_initial_schema.sql` | Sloupce `arrival_buffer_percent` a `arrival_buffer_fixed_minutes` do `routes` tabulky |
| `worker/src/types/route.rs` | Pole do struct `Route` |
| `worker/src/db/queries/route.rs` | Sloupce do `upsert_route` (INSERT + UPDATE + SELECT) |
| `worker/src/handlers/route.rs` | Pole do `SaveRouteRequest`, `RecalculateRequest` Äte buffer z payloadu (beze zmÄ›ny â€” uÅ¾ to dÄ›lÃ¡) |
| `worker/src/handlers/jobs.rs` | ÄŒtenÃ­ bufferu z trasy mÃ­sto z posÃ¡dky |
| `packages/shared-types/src/route.ts` | Pole do `Route` interface |
| `apps/web/src/services/routeService.ts` | Pole do `SaveRouteRequest`, `SavedRoute` |

### 2.3 UÅ¾ivatelskÃ© preference (last-used default)

| Soubor | Co pÅ™idat |
|---|---|
| `worker/migrations/001_initial_schema.sql` | Sloupce `last_arrival_buffer_percent` a `last_arrival_buffer_fixed_minutes` do `users` tabulky |
| `worker/src/types/settings.rs` | Pole do `UserPreferences` |
| `worker/src/db/queries/settings.rs` | ÄŒtenÃ­ a zÃ¡pis novÃ½ch preferencÃ­ |
| `worker/src/handlers/route.rs` | Po uloÅ¾enÃ­ trasy aktualizovat uÅ¾ivatelskÃ© preference |
| `packages/shared-types/src/settings.ts` | Pole do `UserPreferences` |
| `apps/web/src/services/settingsService.ts` | Pole do `UserPreferences` |

### 2.4 Frontend â€” zobrazenÃ­ a editace na timeline

| Soubor | Co pÅ™idat |
|---|---|
| `apps/web/src/components/planner/RouteDetailTimeline.tsx` | NovÃ½ props, zobrazenÃ­ drobnÃ½m pÃ­smem, inline editor |
| `apps/web/src/components/planner/RouteDetailTimeline.module.css` | Styly pro buffer info + editor |
| `apps/web/src/pages/PlanningInbox.tsx` | PÅ™edÃ¡nÃ­ buffer props do timeline, handler pro zmÄ›nu, pÅ™eÄtenÃ­ defaultu z preferences |
| `apps/web/public/locales/{cs,en,sk}/planner.json` | PÅ™eklady pro buffer label, editor |

---

## 3. DatovÃ½ model

### 3.1 Tabulka `routes` â€” novÃ© sloupce

```sql
arrival_buffer_percent         DOUBLE PRECISION NOT NULL DEFAULT 10.0,
arrival_buffer_fixed_minutes   DOUBLE PRECISION NOT NULL DEFAULT 0.0
```

### 3.2 Tabulka `users` â€” novÃ© sloupce (preference)

```sql
last_arrival_buffer_percent         DOUBLE PRECISION NOT NULL DEFAULT 10.0,
last_arrival_buffer_fixed_minutes   DOUBLE PRECISION NOT NULL DEFAULT 0.0
```

### 3.3 Tabulka `crews` â€” odebranÃ© sloupce

```
arrival_buffer_percent         -- ODEBRAT
arrival_buffer_fixed_minutes   -- ODEBRAT
```

### 3.4 Rust structs

```rust
// Route â€” pÅ™idat pole:
pub struct Route {
    // ... existujÃ­cÃ­ ...
    pub arrival_buffer_percent: f64,
    pub arrival_buffer_fixed_minutes: f64,
}

// SaveRouteRequest â€” pÅ™idat pole:
pub struct SaveRouteRequest {
    // ... existujÃ­cÃ­ ...
    pub arrival_buffer_percent: f64,
    pub arrival_buffer_fixed_minutes: f64,
}

// UserPreferences â€” pÅ™idat pole:
pub struct UserPreferences {
    // ... existujÃ­cÃ­ ...
    pub last_arrival_buffer_percent: f64,
    pub last_arrival_buffer_fixed_minutes: f64,
}
```

### 3.5 TypeScript types

```typescript
// Route â€” pÅ™idat pole:
export interface Route {
  // ... existujÃ­cÃ­ ...
  arrivalBufferPercent: number;
  arrivalBufferFixedMinutes: number;
}

// SaveRouteRequest â€” pÅ™idat pole:
export interface SaveRouteRequest {
  // ... existujÃ­cÃ­ ...
  arrivalBufferPercent: number;
  arrivalBufferFixedMinutes: number;
}

// SavedRoute â€” pÅ™idat pole:
export interface SavedRoute {
  // ... existujÃ­cÃ­ ...
  arrivalBufferPercent: number;
  arrivalBufferFixedMinutes: number;
}

// UserPreferences â€” pÅ™idat pole:
export interface UserPreferences {
  // ... existujÃ­cÃ­ ...
  lastArrivalBufferPercent: number;
  lastArrivalBufferFixedMinutes: number;
}
```

---

## 4. ChovÃ¡nÃ­

### 4.1 VytvoÅ™enÃ­ novÃ© trasy

1. Frontend naÄte `settings.preferences.lastArrivalBufferPercent` a `lastArrivalBufferFixedMinutes`.
2. Tyto hodnoty se drÅ¾Ã­ v lokÃ¡lnÃ­m stavu `PlanningInbox` (state `routeBufferPercent`, `routeBufferFixedMinutes`).
3. PÅ™i kaÅ¾dÃ©m `recalculateRoute()` se poÅ¡lou jako `arrivalBufferPercent` / `arrivalBufferFixedMinutes`.
4. PÅ™i kaÅ¾dÃ©m `saveRoute()` se poÅ¡lou v `SaveRouteRequest`.
5. Backend `handle_save_route` uloÅ¾Ã­ buffer do `routes` tabulky.
6. Backend po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­ aktualizuje `users.last_arrival_buffer_percent` a `users.last_arrival_buffer_fixed_minutes`.

### 4.2 NaÄtenÃ­ existujÃ­cÃ­ trasy

1. `getRoute()` vracÃ­ `SavedRoute` s `arrivalBufferPercent` a `arrivalBufferFixedMinutes`.
2. Frontend z tÄ›chto hodnot inicializuje lokÃ¡lnÃ­ stav.

### 4.3 Editace bufferu na timeline

1. Pod hlaviÄkou timeline (pod depot departure) je drobnÃ½ text: â€Rezerva: 10 % + 0 min".
2. Po kliknutÃ­ se text zmÄ›nÃ­ na inline editor (dva malÃ© inputy: `%` a `min`).
3. Po potvrzenÃ­ (Enter / blur) se:
   a. Aktualizuje lokÃ¡lnÃ­ stav.
   b. SpustÃ­ `recalculateRoute()` s novÃ½mi hodnotami.
   c. Autosave uloÅ¾Ã­ trasu (vÄetnÄ› novÃ©ho bufferu).

### 4.4 Route planning job (async)

`handle_route_plan_job` v `handlers/jobs.rs` dnes Äte buffer z posÃ¡dky. NovÄ›:

1. PÅ™ijme buffer jako parametr v `RoutePlanJobRequest`.
2. Frontend buffer pÅ™edÃ¡ pÅ™i submitu jobu.
3. AlternativnÄ›: job naÄte buffer z existujÃ­cÃ­ trasy v DB (pokud trasa uÅ¾ existuje).

---

## 5. UI mockup (RouteDetailTimeline)

```
ğŸ“ Sklad Brno                              â† depot card
   Odjezd: 07:24
   â”€â”€â”€ Rezerva: 10 % + 0 min âœï¸ â”€â”€â”€        â† novÃ½ Å™Ã¡dek, drobnÃ© pÃ­smo
   â–¼ 12.3 km â€¢ 18 min
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 1. NovÃ¡k s.r.o.                â”‚      â† stop card
   â”‚    PÅ™Ã­jezd: 07:42 â†’ Odjezd: ... â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â–¼ 8.1 km â€¢ 12 min
   ...
```

Po kliknutÃ­ na âœï¸:

```
   â”€â”€â”€ Rezerva: [10] % + [0] min  âœ“ âœ• â”€â”€â”€ â† inline edit
```

---

## 6. ImplementaÄnÃ­ plÃ¡n (TDD)

DatabÃ¡zi nemigrujeme â€” bude vytvoÅ™ena znovu. UpravÃ­me pÅ™Ã­mo `001_initial_schema.sql` a smaÅ¾eme starÃ© buffer migrace.

KaÅ¾dÃ½ krok se Å™Ã­dÃ­ cyklem RED â†’ GREEN â†’ REFACTOR:
1. Napsat failing test (RED)
2. Napsat minimÃ¡lnÃ­ implementaci, aby test proÅ¡el (GREEN)
3. Refaktorovat pokud potÅ™eba (REFACTOR)
4. OdÅ¡krtnout krok v tomto souboru

### FÃ¡ze 1: DatabÃ¡ze a migrace (scaffold)

- [x] **1.1** V `001_initial_schema.sql` pÅ™idat do tabulky `routes`:
  - `arrival_buffer_percent DOUBLE PRECISION NOT NULL DEFAULT 10.0`
  - `arrival_buffer_fixed_minutes DOUBLE PRECISION NOT NULL DEFAULT 0.0`
- [x] **1.2** V `001_initial_schema.sql` pÅ™idat do tabulky `users`:
  - `last_arrival_buffer_percent DOUBLE PRECISION NOT NULL DEFAULT 10.0`
  - `last_arrival_buffer_fixed_minutes DOUBLE PRECISION NOT NULL DEFAULT 0.0`
- [x] **1.3** V `001_initial_schema.sql` odebrat z tabulky `crews`: nebyly v base schema (pÅ™idÃ¡ny migracÃ­) âœ…
- [x] **1.4** Smazat migrace: `004_add_crew_buffer.sql`, `005_fix_crew_buffer_type.sql`, `014_add_crew_fixed_buffer.sql` âœ…

### FÃ¡ze 2: Rust typy â€” crew (odebrat buffer) + testy

- [x] **2.1** TEST: `test_crew_no_buffer_fields` â€” `CreateCrewRequest` bez `arrivalBufferPercent` se deserializuje OK; serializovanÃ½ `Crew` neobsahuje klÃ­Ä `arrivalBufferPercent`. âœ…
  - GREEN: OdebrÃ¡no ze struct `Crew`, `CreateCrewRequest`, `UpdateCrewRequest`. Testy pÅ™epsÃ¡ny.
- [x] **2.2** `db/queries/crew.rs` â€” odebrÃ¡ny buffer sloupce z INSERT, UPDATE, SELECT dotazÅ¯ âœ…
- [x] **2.3** `cargo check` â€” handlers doÄasnÄ› defaultujÃ­ buffer na 10.0/0.0 (TODO pro fÃ¡zi 6) âœ…

### FÃ¡ze 3: Rust typy â€” route (pÅ™idat buffer) + TDD

- [x] **3.1** TEST: `test_route_serializes_buffer_fields` â€” Route serializuje `arrivalBufferPercent` a `arrivalBufferFixedMinutes` âœ…
  - GREEN: PÅ™idÃ¡na pole do `types/route.rs` â†’ struct `Route`.
- [x] **3.2** TEST: `test_save_route_request_deserializes_buffer` â€” SaveRouteRequest deserializuje buffer z JSON âœ…
  - GREEN: PÅ™idÃ¡na pole do `SaveRouteRequest` v `handlers/route.rs`.
- [x] **3.3** TEST: `test_save_route_request_buffer_defaults` â€” bez buffer polÃ­ defaultuje na 10.0 / 0.0 âœ…
  - GREEN: `#[serde(default = "default_buffer_percent")]` a `#[serde(default)]`.
- [x] **3.4** `cargo check` âœ…

### FÃ¡ze 4: Rust typy â€” user preferences (pÅ™idat last-used buffer) + TDD

- [x] **4.1** TEST: `test_user_preferences_has_last_buffer` â€” serializace/deserializace buffer polÃ­ v `UserPreferences` âœ…
  - GREEN: PÅ™idÃ¡na pole do `UserPreferences`, `UserWithSettings`, `to_preferences()`.
- [x] **4.2** `cargo check` âœ…

### FÃ¡ze 5: DB dotazy â€” route upsert + TDD

- [x] **5.1** `upsert_route` â€” pÅ™idÃ¡ny `arrival_buffer_percent` a `arrival_buffer_fixed_minutes` do INSERT, UPDATE, RETURNING + parametry funkce âœ…
- [x] **5.2** `get_route_for_date`, `get_route_by_id`, `RouteWithCrewInfo`, `list_routes*` â€” pÅ™idÃ¡ny buffer sloupce do SELECT âœ…
- [x] **5.3** `db/queries/settings.rs` â€” pÅ™idÃ¡no ÄtenÃ­ buffer z `get_user_settings`, novÃ¡ funkce `update_last_arrival_buffer` âœ…
- [x] **5.4** `cargo check` âœ…

### FÃ¡ze 6: Handlery â€” save route uklÃ¡dÃ¡ buffer a aktualizuje preferences + TDD

- [x] **6.1** `SaveRouteRequest` buffer pole fungujÃ­ (ovÄ›Å™eno v fÃ¡zi 3) âœ…
- [x] **6.2** `handle_save_route` â€” pÅ™edÃ¡vÃ¡ buffer do `upsert_route`, po uloÅ¾enÃ­ volÃ¡ `update_last_arrival_buffer` âœ…
- [x] **6.3** `handle_get_route` â€” buffer pole v response automaticky dÃ­ky fÃ¡zi 5 âœ…
- [x] **6.4** `handle_recalculate` â€” beze zmÄ›ny âœ…
- [x] **6.5** `RoutePlanJobRequest` â€” pÅ™idÃ¡na `arrival_buffer_percent` a `arrival_buffer_fixed_minutes` s serde defaults âœ…
- [x] **6.6** `RoutePlanRequest` â€” pÅ™idÃ¡na buffer pole, handler Äte z requestu mÃ­sto crew âœ…
- [x] **6.7** `handlers/jobs.rs` â€” Äte buffer z `request.arrival_buffer_percent` mÃ­sto crew âœ…
- [x] **6.8** `cargo check` âœ…
- [x] **6.9** `cargo test` â€” 282 passed, 0 failed âœ…

### FÃ¡ze 7: TypeScript shared types

- [x] **7.1** `packages/shared-types/src/route.ts` â€” pÅ™idÃ¡no `arrivalBufferPercent` a `arrivalBufferFixedMinutes` do `Route` âœ…
- [x] **7.2** `packages/shared-types/src/settings.ts` â€” pÅ™idÃ¡no `lastArrivalBufferPercent` a `lastArrivalBufferFixedMinutes` do `UserPreferences` âœ…

### FÃ¡ze 8: Frontend services

- [x] **8.1** `routeService.ts` â€” pÅ™idÃ¡no `arrivalBufferPercent` a `arrivalBufferFixedMinutes` do `SaveRouteRequest`, `SavedRoute`, `RoutePlanJobRequest` âœ…
- [x] **8.2** `crewService.ts` â€” odebrÃ¡no `arrivalBufferPercent` a `arrivalBufferFixedMinutes` z `Crew`, `CreateCrewRequest`, `UpdateCrewRequest` âœ…
- [x] **8.3** `settingsService.ts` â€” pÅ™idÃ¡no `lastArrivalBufferPercent` a `lastArrivalBufferFixedMinutes` do `UserPreferences` âœ…
- [ ] **8.4** `tsc --noEmit` â€” oÄekÃ¡vÃ¡me chyby v PlanningInbox a Settings (opravÃ­me v dalÅ¡Ã­ch fÃ¡zÃ­ch)

### FÃ¡ze 9: Frontend â€” PlanningInbox (buffer state + flow)

- [x] **9.1** PÅ™idÃ¡n lokÃ¡lnÃ­ stav `routeBufferPercent` a `routeBufferFixedMinutes`, init z preferences, override ze savedRoute âœ…
- [x] **9.2** `triggerRecalculate` â€” Äte z `routeBufferPercent` / `routeBufferFixedMinutes` mÃ­sto crew âœ…
- [x] **9.3** `autoSaveFn` â€” pÅ™edÃ¡vÃ¡ buffer v `SaveRouteRequest` âœ…
- [x] **9.4** `handleBufferChange` handler â†’ update stavu â†’ `triggerRecalculate()` âœ…
- [x] **9.5** Buffer props + `onBufferChange` pÅ™edÃ¡ny do `RouteDetailTimeline`, buffer do `submitRoutePlanJob` âœ…
- [ ] **9.6** `tsc --noEmit` â€” ovÄ›Å™it kompilaci.

### FÃ¡ze 10: Frontend â€” RouteDetailTimeline (zobrazenÃ­ a editace)

- [x] **10.1** Props `arrivalBufferPercent`, `arrivalBufferFixedMinutes`, `onBufferChange` pÅ™idÃ¡ny âœ…
- [x] **10.2** Buffer info zobrazeno drobnÃ½m pÃ­smem pod depot, kliknutÃ­m se rozbalÃ­ editor âœ…
- [x] **10.3** Inline editor: dva number inputy, UloÅ¾it/ZruÅ¡it tlaÄÃ­tka âœ…
- [x] **10.4** CSS styly `.bufferBar`, `.bufferEdit`, `.bufferEditRow`, `.bufferEditActions` âœ…
- [x] **10.5** `tsc --noEmit` â€” ovÄ›Å™eno ve fÃ¡zi 13 âœ…

### FÃ¡ze 11: Frontend â€” Settings crew form (odebrat buffer)

- [x] **11.1** `Settings.tsx` â€” odebrÃ¡no buffer z `CrewFormData`, `createCrew`, `updateCrew`, crew list display, form inputs âœ…
- [x] **11.2** OdebrÃ¡ny pÅ™eklad. klÃ­Äe `crew_arrival_buffer_*` a `crew_buffer` z `{cs,en,sk}/settings.json` âœ…
- [ ] **11.3** `tsc --noEmit`

### FÃ¡ze 12: Frontend â€” pÅ™eklady (novÃ© klÃ­Äe)

- [x] **12.1** PÅ™idÃ¡ny pÅ™eklady `buffer_info`, `buffer_percent_label`, `buffer_fixed_label`, `buffer_save`, `buffer_cancel` do `{cs,en,sk}/planner.json` âœ…
- [x] **12.2** OdebrÃ¡ny starÃ© crew buffer klÃ­Äe z `{cs,en,sk}/settings.json` âœ…

### FÃ¡ze 13: FinÃ¡lnÃ­ ovÄ›Å™enÃ­

- [x] **13.1** `cargo check` â€” backend kompiluje bez chyb âœ…
- [x] **13.2** `cargo test` â€” 282 passed, 0 failed âœ…
- [x] **13.3** `tsc` â€” opraven test `RouteListPanel.test.tsx` (chybÄ›jÃ­cÃ­ povinnÃ¡ pole v `SavedRoute`). OstatnÃ­ chyby jsou pre-existujÃ­cÃ­ (unused imports) âœ…
- [ ] **13.4** ManuÃ¡lnÃ­ QA:
  - VytvoÅ™it novou trasu â†’ buffer se pÅ™edvyplnÃ­ z user preferences (10 % + 0 min).
  - OvÄ›Å™it zobrazenÃ­ bufferu na timeline drobnÃ½m pÃ­smem.
  - Kliknout na buffer â†’ editovat â†’ potvrdit â†’ ovÄ›Å™it pÅ™epoÄet ETA.
  - UloÅ¾it trasu â†’ buffer se uloÅ¾Ã­ do DB.
  - VytvoÅ™it druhou trasu â†’ ovÄ›Å™it, Å¾e se pÅ™edvyplnÃ­ poslednÄ› pouÅ¾itÃ¡ hodnota.
  - OtevÅ™Ã­t nastavenÃ­ posÃ¡dky â†’ buffer tam uÅ¾ nenÃ­.

---

## 8. Inline editace timeline + sdÃ­lenÃ½ ArrivalBufferBar

### 8.1 Motivace

Po pÅ™esunu bufferu na trasu pÅ™ichÃ¡zÃ­ dalÅ¡Ã­ krok: umoÅ¾nit dispeÄerovi **pÅ™Ã­mo v timeline** ruÄnÄ› upravit trvÃ¡nÃ­ libovolnÃ© poloÅ¾ky â€” zastÃ¡vky (servis), Ãºseky cesty a pauzy. Jde o Å™eÅ¡enÃ­ mimoÅ™Ã¡dnÃ½ch situacÃ­ (zÃ¡cpa, prodlouÅ¾enÃ½ servis). Tyto overridem â€natvrdo" nastavenÃ© hodnoty pÅ™epÃ­Å¡Ã­ vypoÄÃ­tanÃ©/dohodnutÃ© a uloÅ¾Ã­ se do DB.

SouÄasnÄ› se `ArrivalBufferBar` stane sdÃ­lenou komponentou pouÅ¾itou v `PlanningInbox` i `Planner`.

### 8.2 ChovÃ¡nÃ­

1. **KaÅ¾dÃ¡ poloÅ¾ka timeline** (zastÃ¡vka, Ãºsek cesty, pauza) bude mÃ­t v pravÃ© ÄÃ¡sti **editovatelnÃ½ Ãºdaj trvÃ¡nÃ­**.
2. Po ruÄnÃ­m pÅ™epsÃ¡nÃ­ hodnoty se pole vizuÃ¡lnÄ› odliÅ¡Ã­: **vÃ½straÅ¾nÃ¡ ikona âš ï¸** + tooltip â€RuÄnÄ› upraveno".
3. KliknutÃ­m na ikonu âš ï¸ se hodnota **vrÃ¡tÃ­ na pÅ¯vodnÃ­** (vypoÄÃ­tanou / dohodnutou).
4. **PÅ™epoÄet shora dolÅ¯**: zmÄ›na na pozici N pÅ™epoÄÃ­tÃ¡ Äasy od pozice N+1 dolÅ¯. UdÃ¡losti pÅ™ed N se nemÄ›nÃ­. Pokud buffery po trase absorbujÃ­ rozdÃ­l, pÅ™epoÄet se neprojevÃ­.
5. **Drag & drop reorder** zastÃ¡vek â€” uÅ¾ funguje (DnD kit), zachovÃ¡me.
6. ChovÃ¡nÃ­ je identickÃ© v `PlanningInbox` i `Planner`.

### 8.3 DatovÃ½ model â€” override sloupce v `route_stops`

```sql
-- PÅ™idat do tabulky route_stops v 001_initial_schema.sql:
override_service_duration_minutes  INTEGER,   -- NULL = pouÅ¾ij vypoÄÃ­tanou, non-NULL = manuÃ¡lnÃ­ override
override_travel_duration_minutes   INTEGER,   -- NULL = pouÅ¾ij Valhalla Äas, non-NULL = manuÃ¡lnÃ­ override
```

Logika:
- `effectiveServiceDuration = override_service_duration_minutes ?? service_duration_minutes ?? default`
- `effectiveTravelDuration = override_travel_duration_minutes ?? duration_from_previous_minutes`
- VzdÃ¡lenost (`distance_from_previous_km`) se overridem nemÄ›nÃ­.

### 8.4 Rust structs â€” rozÅ¡Ã­Å™enÃ­

```rust
// RouteStop (existujÃ­cÃ­) â€” pÅ™idat:
pub override_service_duration_minutes: Option<i32>,
pub override_travel_duration_minutes: Option<i32>,
```

### 8.5 TypeScript types â€” rozÅ¡Ã­Å™enÃ­

```typescript
// SavedRouteStop â€” pÅ™idat:
overrideServiceDurationMinutes?: number | null;
overrideTravelDurationMinutes?: number | null;
```

### 8.6 RecalcStopInput â€” rozÅ¡Ã­Å™enÃ­

```typescript
// PÅ™idat do RecalcStopInput:
overrideServiceDurationMinutes?: number | null;
overrideTravelDurationMinutes?: number | null;
```

Backend `handle_recalculate`:
- Pokud `overrideTravelDurationMinutes` je nastaveno, pouÅ¾ije ho mÃ­sto Valhalla doby jÃ­zdy.
- Pokud `overrideServiceDurationMinutes` je nastaveno, pouÅ¾ije ho mÃ­sto defaultu/scheduled.

### 8.7 UI mockup â€” inline editace

```
ğŸ“ Depo D1                                   07:30
   Rezerva pÅ™Ã­jezdu: 10 % + 0 min            â† ArrivalBufferBar
   â–¼ 45.5 km â€¢ [41 min] âš ï¸                   â† editovatelnÃ½ Ãºsek cesty, override indikÃ¡tor
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 1  KomÃ­nServis trade k.s.  08:41â€“09:11 â”‚
   â”‚    [30 min] âš ï¸                         â”‚ â† editovatelnÃ¡ doba servisu
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â–¼ 12.3 km â€¢ 18 min                        â† normÃ¡lnÃ­ (bez override)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 2  Radek ÄŒernÃ½           09:29â€“09:59 â”‚
   â”‚    30 min                              â”‚ â† normÃ¡lnÃ­
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- `[41 min]` â€” inline input (number), editovatelnÃ½ kliknutÃ­m.
- `âš ï¸` â€” indikÃ¡tor override. Klik â†’ reset na vypoÄÃ­tanou hodnotu.
- Pole bez override se zobrazujÃ­ normÃ¡lnÄ› (bez ikony).

---

## 9. ImplementaÄnÃ­ plÃ¡n â€” Inline editace timeline (TDD)

DatabÃ¡zi nemigrujeme â€” bude vytvoÅ™ena znovu (`001_initial_schema.sql`).

KaÅ¾dÃ½ krok se Å™Ã­dÃ­ cyklem RED â†’ GREEN â†’ REFACTOR.

### FÃ¡ze A: SdÃ­lenÃ¡ komponenta ArrivalBufferBar

- [x] **A.1** PÅ™esunout `ArrivalBufferBar` z `PlanningInbox.tsx` do `apps/web/src/components/planner/ArrivalBufferBar.tsx` jako exportovanou komponentu.
- [x] **A.2** CSS styly `.bufferBar`, `.bufferBarExpanded`, `.bufferEditRow`, `.bufferEditActions`, `.bufferLabel` pÅ™esunout do `ArrivalBufferBar.module.css`.
- [x] **A.3** V `PlanningInbox.tsx` importovat `ArrivalBufferBar` ze sdÃ­lenÃ© komponenty, odebrat lokÃ¡lnÃ­ definici a CSS.
- [x] **A.4** V `Planner.tsx` pÅ™idat buffer state (`routeBufferPercent`, `routeBufferFixedMinutes`), inicializaci z user preferences, `handleBufferChange` handler.
- [x] **A.5** V `Planner.tsx` vloÅ¾it `<ArrivalBufferBar>` mezi akce a timeline (stejnÃ¡ pozice jako v PlanningInbox).
- [x] **A.6** Exportovat `ArrivalBufferBar` z `components/planner/index.ts`.
- [x] **A.7** OvÄ›Å™it zobrazenÃ­ v obou pohledech (`PlanningInbox` + `Planner`).

### FÃ¡ze B: DB schÃ©ma â€” override sloupce

- [x] **B.1** V `001_initial_schema.sql` pÅ™idat do `route_stops`:
  - `override_service_duration_minutes INTEGER` (nullable)
  - `override_travel_duration_minutes INTEGER` (nullable)
- [x] **B.2** OvÄ›Å™it, Å¾e schema je validnÃ­ (`psql -f`).

### FÃ¡ze C: Rust typy â€” route stop overrides + TDD

- [x] **C.1** RED: Test `test_route_stop_override_fields_serialize` â€” struct s `override_service_duration_minutes: Some(45)` se serializuje s klÃ­Äem `overrideServiceDurationMinutes`.
  - GREEN: PÅ™idat `override_service_duration_minutes: Option<i32>` a `override_travel_duration_minutes: Option<i32>` do struct v `types/route.rs` (nebo pÅ™Ã­sluÅ¡nÃ½ stop struct).
- [x] **C.2** RED: Test `test_route_stop_override_null_skipped` â€” struct s `None` neobsahuje klÃ­Ä v JSON (skip_serializing_if).
  - GREEN: `#[serde(skip_serializing_if = "Option::is_none")]`.
- [x] **C.3** `cargo check` â€” ovÄ›Å™it kompilaci.

### FÃ¡ze D: DB dotazy â€” route stops s overrides + TDD

- [ ] **D.1** PÅ™idat `override_service_duration_minutes` a `override_travel_duration_minutes` do SELECT dotazÅ¯ v `db/queries/route.rs` (vÅ¡echny funkce vracejÃ­cÃ­ route stops).
- [ ] **D.2** PÅ™idat override pole do INSERT/UPDATE dotazu pro route stops (v `upsert_route` nebo `save_route_stops`).
- [ ] **D.3** `cargo check`.

### FÃ¡ze E: Backend recalculate â€” respektovat overrides

- [ ] **E.1** RED: Test `test_recalculate_uses_override_travel_duration` â€” vstup s `override_travel_duration_minutes: Some(60)` vrÃ¡tÃ­ ETA liÅ¡Ã­cÃ­ se od Valhalla vÃ½poÄtu.
  - GREEN: V `sequential_schedule.rs` (nebo `handle_recalculate`): pokud stop mÃ¡ `override_travel_duration_minutes`, pouÅ¾Ã­t mÃ­sto matice.
- [ ] **E.2** RED: Test `test_recalculate_uses_override_service_duration` â€” vstup s `override_service_duration_minutes: Some(45)` vrÃ¡tÃ­ departure = arrival + 45 min.
  - GREEN: V scheduling logice: pokud stop mÃ¡ `override_service_duration_minutes`, pouÅ¾Ã­t mÃ­sto default/scheduled.
- [ ] **E.3** `cargo test`.

### FÃ¡ze F: Frontend shared types â€” override pole

- [ ] **F.1** `packages/shared-types/src/route.ts` â€” pÅ™idat `overrideServiceDurationMinutes?: number | null` a `overrideTravelDurationMinutes?: number | null` do `RouteStop` interface (pokud existuje).
- [ ] **F.2** `apps/web/src/services/routeService.ts` â€” pÅ™idat override pole do `SavedRouteStop`, `RecalcStopInput`.

### FÃ¡ze G: Frontend â€” inline editace Ãºseku cesty (travel duration) + TDD

- [ ] **G.1** `RouteDetailTimeline.tsx` â€” segment (Ãºsek cesty) zobrazÃ­ dobu jÃ­zdy jako `<input type="number">` (inline, malÃ½). Po zmÄ›nÄ› volÃ¡ novÃ½ callback `onUpdateTravelDuration(stopId, minutes)`.
- [ ] **G.2** Pokud `overrideTravelDurationMinutes != null`, zobrazit vedle inputu ikonu âš ï¸. Klik na ikonu â†’ reset (`onResetTravelDuration(stopId)`).
- [ ] **G.3** CSS styly pro inline input v segmentu + override indikÃ¡tor.
- [ ] **G.4** `PlanningTimeline.tsx` â€” stejnÃ¡ logika jako G.1â€“G.3 (travel segment editace).
- [ ] **G.5** Props: pÅ™idat `onUpdateTravelDuration` a `onResetTravelDuration` do obou timeline komponent.

### FÃ¡ze H: Frontend â€” inline editace zastÃ¡vky (service duration) + TDD

- [ ] **H.1** `RouteDetailTimeline.tsx` â€” zastÃ¡vka zobrazÃ­ dobu servisu jako `<input type="number">` (inline). Po zmÄ›nÄ› volÃ¡ `onUpdateServiceDuration(stopId, minutes)`.
- [ ] **H.2** Pokud `overrideServiceDurationMinutes != null`, zobrazit vedle inputu ikonu âš ï¸. Klik na ikonu â†’ reset (`onResetServiceDuration(stopId)`).
- [ ] **H.3** CSS styly pro inline input u zastÃ¡vky + override indikÃ¡tor.
- [ ] **H.4** `PlanningTimeline.tsx` â€” stejnÃ¡ logika jako H.1â€“H.3.
- [ ] **H.5** Props: pÅ™idat `onUpdateServiceDuration` a `onResetServiceDuration` do obou timeline komponent.

### FÃ¡ze I: Frontend â€” handlery v PlanningInbox + Planner

- [ ] **I.1** `PlanningInbox.tsx` â€” implementovat:
  - `handleUpdateTravelDuration(stopId, minutes)` â€” nastavÃ­ `overrideTravelDurationMinutes` na danÃ©m stopu, spustÃ­ pÅ™epoÄet shora dolÅ¯.
  - `handleResetTravelDuration(stopId)` â€” nastavÃ­ `overrideTravelDurationMinutes = null`, spustÃ­ pÅ™epoÄet.
  - `handleUpdateServiceDuration(stopId, minutes)` â€” nastavÃ­ `overrideServiceDurationMinutes`, spustÃ­ pÅ™epoÄet.
  - `handleResetServiceDuration(stopId)` â€” nastavÃ­ `overrideServiceDurationMinutes = null`, spustÃ­ pÅ™epoÄet.
- [ ] **I.2** PÅ™edat vÅ¡echny 4 handlery jako props do `RouteDetailTimeline` a `PlanningTimeline`.
- [ ] **I.3** `triggerRecalculate` â€” pÅ™i budovÃ¡nÃ­ `RecalcStopInput[]` zahrnout override pole z aktuÃ¡lnÃ­ch route stops.
- [ ] **I.4** `autoSaveFn` â€” v `SaveRouteRequest` zahrnout override pole pro kaÅ¾dÃ½ stop.
- [ ] **I.5** `Planner.tsx` â€” implementovat totoÅ¾nÃ© handlery (I.1â€“I.4) pro Planner page.
- [ ] **I.6** OvÄ›Å™it, Å¾e DnD reorder zachovÃ¡vÃ¡ override hodnoty na pÅ™esunutÃ½ch stopech.

### FÃ¡ze J: Frontend â€” pÅ™eklady

- [ ] **J.1** `{cs,en,sk}/planner.json` â€” pÅ™idat klÃ­Äe:
  - `override_reset_tooltip` â€” â€VrÃ¡tit na vypoÄÃ­tanou hodnotu"
  - `override_indicator_tooltip` â€” â€RuÄnÄ› upraveno"
  - `travel_duration_label` â€” â€Doba jÃ­zdy"
  - `service_duration_label` â€” â€Doba servisu"

### FÃ¡ze K: FinÃ¡lnÃ­ ovÄ›Å™enÃ­

- [ ] **K.1** `cargo check` â€” backend kompiluje.
- [ ] **K.2** `cargo test` â€” vÅ¡echny testy prochÃ¡zÃ­.
- [ ] **K.3** `tsc --noEmit` â€” frontend kompiluje (opravit test fixtures).
- [ ] **K.4** ManuÃ¡lnÃ­ QA:
  - VytvoÅ™it trasu se 3+ zastÃ¡vkami.
  - Kliknout na dobu jÃ­zdy v segmentu â†’ zmÄ›nit na vyÅ¡Å¡Ã­ hodnotu â†’ ovÄ›Å™it pÅ™epoÄet ETA shora dolÅ¯.
  - OvÄ›Å™it âš ï¸ ikonu u overridnutÃ©ho segmentu.
  - Kliknout na âš ï¸ â†’ ovÄ›Å™it reset na pÅ¯vodnÃ­ hodnotu.
  - Kliknout na dobu servisu u zastÃ¡vky â†’ zmÄ›nit â†’ ovÄ›Å™it pÅ™epoÄet.
  - UloÅ¾it trasu â†’ reload â†’ ovÄ›Å™it, Å¾e overrides pÅ™etrvajÃ­.
  - OvÄ›Å™it identickÃ© chovÃ¡nÃ­ v Planner.
  - OvÄ›Å™it ArrivalBufferBar v Planner.
  - DnD reorder zastÃ¡vky s override â†’ override se zachovÃ¡.

---

## 10. Soubory dotÄenÃ© zmÄ›nami (inline editace)

### NovÃ© soubory
- `apps/web/src/components/planner/ArrivalBufferBar.tsx` â€” sdÃ­lenÃ¡ komponenta
- `apps/web/src/components/planner/ArrivalBufferBar.module.css` â€” styly

### ZmÄ›nÄ›nÃ© soubory â€” backend
- `worker/migrations/001_initial_schema.sql` â€” override sloupce v `route_stops`
- `worker/src/types/route.rs` â€” override pole ve struct
- `worker/src/db/queries/route.rs` â€” override v SELECT/INSERT/UPDATE
- `worker/src/handlers/route.rs` â€” override v recalculate/save
- `worker/src/services/sequential_schedule.rs` â€” respektovat overrides pÅ™i scheduling

### ZmÄ›nÄ›nÃ© soubory â€” shared types
- `packages/shared-types/src/route.ts` â€” override pole

### ZmÄ›nÄ›nÃ© soubory â€” frontend
- `apps/web/src/services/routeService.ts` â€” override v `SavedRouteStop`, `RecalcStopInput`
- `apps/web/src/pages/PlanningInbox.tsx` â€” odebrat lokÃ¡lnÃ­ `ArrivalBufferBar`, pÅ™idat override handlery
- `apps/web/src/pages/PlanningInbox.module.css` â€” odebrat buffer styly (pÅ™esunuty do sdÃ­lenÃ© komponenty)
- `apps/web/src/pages/Planner.tsx` â€” pÅ™idat buffer state + `ArrivalBufferBar` + override handlery
- `apps/web/src/components/planner/RouteDetailTimeline.tsx` â€” inline editace duration + override indikÃ¡tory
- `apps/web/src/components/planner/RouteDetailTimeline.module.css` â€” styly pro inline editing
- `apps/web/src/components/planner/PlanningTimeline.tsx` â€” inline editace duration + override indikÃ¡tory
- `apps/web/src/components/planner/PlanningTimeline.module.css` â€” styly pro inline editing
- `apps/web/src/components/planner/index.ts` â€” export `ArrivalBufferBar`
- `apps/web/public/locales/{cs,en,sk}/planner.json` â€” novÃ© pÅ™eklady

---

## 7. Soubory dotÄenÃ© zmÄ›nami (fÃ¡ze 1â€“13, buffer pÅ™esun â€” HOTOVO)

### SmazanÃ© soubory
- `worker/migrations/004_add_crew_buffer.sql`
- `worker/migrations/005_fix_crew_buffer_type.sql`
- `worker/migrations/014_add_crew_fixed_buffer.sql`

### ZmÄ›nÄ›nÃ© soubory â€” backend
- `worker/migrations/001_initial_schema.sql` â€” pÅ™idat buffer do `routes`, `users`; odebrat z `crews`
- `worker/src/types/crew.rs` â€” odebrat buffer pole + opravit testy
- `worker/src/types/route.rs` â€” pÅ™idat buffer pole
- `worker/src/types/settings.rs` â€” pÅ™idat `last_arrival_buffer_*`
- `worker/src/db/queries/crew.rs` â€” odebrat buffer z dotazÅ¯
- `worker/src/db/queries/route.rs` â€” pÅ™idat buffer do upsert/select
- `worker/src/db/queries/settings.rs` â€” ÄÃ­st/zapisovat `last_arrival_buffer_*`
- `worker/src/handlers/route.rs` â€” `handle_save_route` uklÃ¡dÃ¡ buffer + aktualizuje user prefs
- `worker/src/handlers/jobs.rs` â€” neÄÃ­st buffer z crew, pÅ™ijmout v payloadu

### ZmÄ›nÄ›nÃ© soubory â€” shared types
- `packages/shared-types/src/route.ts` â€” buffer pole
- `packages/shared-types/src/settings.ts` â€” `lastArrivalBufferPercent`, `lastArrivalBufferFixedMinutes`

### ZmÄ›nÄ›nÃ© soubory â€” frontend
- `apps/web/src/services/routeService.ts` â€” buffer v `SaveRouteRequest`, `SavedRoute`
- `apps/web/src/services/crewService.ts` â€” odebrat buffer z `Crew`
- `apps/web/src/services/settingsService.ts` â€” buffer preference
- `apps/web/src/pages/Settings.tsx` â€” odebrat buffer z `CrewForm`
- `apps/web/src/pages/PlanningInbox.tsx` â€” buffer stav, flow, `ArrivalBufferBar`
- `apps/web/src/components/planner/RouteDetailTimeline.tsx` â€” (buffer odebrÃ¡n, pÅ™esunut do PlanningInbox)
- `apps/web/src/components/planner/PlanningTimeline.tsx` â€” (buffer odebrÃ¡n, pÅ™esunut do PlanningInbox)
- `apps/web/src/components/common/TimeInput.tsx` â€” dropdown time picker
- `apps/web/public/locales/{cs,en,sk}/planner.json` â€” novÃ© pÅ™eklady buffer
- `apps/web/public/locales/{cs,en,sk}/settings.json` â€” odebrat crew buffer klÃ­Äe

# PRJ_SOLVER â€” Rezerva pÅ™Ã­jezdu jako vlastnost trasy

## Stav: NÃVRH

Tento dokument popisuje pÅ™esun parametrÅ¯ â€rezerva pÅ™Ã­jezdu" (arrival buffer) z posÃ¡dky na trasu. Rezerva se stane vlastnostÃ­ konkrÃ©tnÃ­ trasy uloÅ¾enÃ© v DB, s automatickÃ½m pÅ™edvyplnÄ›nÃ­m z poslednÃ­ch pouÅ¾itÃ½ch hodnot uÅ¾ivatele.

---

## 1. Motivace

Dnes je rezerva pÅ™Ã­jezdu (`arrival_buffer_percent`, `arrival_buffer_fixed_minutes`) nastavena na posÃ¡dce. To je nepraktickÃ©:

- UÅ¾ivatel nemÅ¯Å¾e mÃ­t rÅ¯znÃ© rezervy pro rÅ¯znÃ© trasy tÃ©Å¾e posÃ¡dky.
- ZmÄ›na na posÃ¡dce zpÄ›tnÄ› ovlivnÃ­ interpretaci vÅ¡ech starÃ½ch tras.
- Rezerva je logicky vlastnost konkrÃ©tnÃ­ trasy, ne posÃ¡dky.

### CÃ­lovÃ½ stav

- Rezerva pÅ™Ã­jezdu je **vlastnost trasy** (`routes` tabulka).
- PÅ™i tvorbÄ› novÃ© trasy se automaticky pouÅ¾ije **poslednÃ­ pouÅ¾itÃ¡ hodnota** danÃ©ho uÅ¾ivatele (z `users` tabulky).
- Na timeline detailu trasy je rezerva **viditelnÄ› uvedena drobnÃ½m pÃ­smem** a **editovatelnÃ¡** po rozkliknutÃ­.
- Z posÃ¡dky se pole `arrival_buffer_percent` a `arrival_buffer_fixed_minutes` **odstranÃ­**.

---

## 2. InventÃ¡Å™ dotÄenÃ½ch mÃ­st

### 2.1 OdstranÄ›nÃ­ z posÃ¡dky (crew)

| Soubor | Co odebrat |
|---|---|
| `worker/src/types/crew.rs` | Pole `arrival_buffer_percent` a `arrival_buffer_fixed_minutes` ze struct `Crew`, `CreateCrewRequest`, `UpdateCrewRequest` + testy |
| `worker/src/db/queries/crew.rs` | Sloupce z INSERT/UPDATE/SELECT dotazÅ¯ |
| `worker/migrations/001_initial_schema.sql` | Odebrat sloupce z `crews` tabulky |
| `worker/migrations/004_add_crew_buffer.sql` | Smazat celÃ½ soubor |
| `worker/migrations/005_fix_crew_buffer_type.sql` | Smazat celÃ½ soubor |
| `worker/migrations/014_add_crew_fixed_buffer.sql` | Smazat celÃ½ soubor |
| `apps/web/src/services/crewService.ts` | Pole z `Crew`, `CreateCrewRequest`, `UpdateCrewRequest` |
| `apps/web/src/pages/Settings.tsx` | Odebrat buffer inputy z `CrewForm` + `CrewFormData` + create/update volÃ¡nÃ­ |
| `apps/web/public/locales/{cs,en,sk}/settings.json` | KlÃ­Äe `crew_arrival_buffer_*` (4 klÃ­Äe Ã— 3 jazyky) |

### 2.2 PÅ™idÃ¡nÃ­ na trasu (route)

| Soubor | Co pÅ™idat |
|---|---|
| `worker/migrations/001_initial_schema.sql` | Sloupce `arrival_buffer_percent` a `arrival_buffer_fixed_minutes` do `routes` tabulky |
| `worker/src/types/route.rs` | Pole do struct `Route` |
| `worker/src/db/queries/route.rs` | Sloupce do `upsert_route` (INSERT + UPDATE + SELECT) |
| `worker/src/handlers/route.rs` | Pole do `SaveRouteRequest`, `RecalculateRequest` Äte buffer z payloadu (beze zmÄ›ny â€” uÅ¾ to dÄ›lÃ¡) |
| `worker/src/handlers/jobs.rs` | ÄŒtenÃ­ bufferu z trasy mÃ­sto z posÃ¡dky |
| `packages/shared-types/src/route.ts` | Pole do `Route` interface |
| `apps/web/src/services/routeService.ts` | Pole do `SaveRouteRequest`, `SavedRoute` |

### 2.3 UÅ¾ivatelskÃ© preference (last-used default)

| Soubor | Co pÅ™idat |
|---|---|
| `worker/migrations/001_initial_schema.sql` | Sloupce `last_arrival_buffer_percent` a `last_arrival_buffer_fixed_minutes` do `users` tabulky |
| `worker/src/types/settings.rs` | Pole do `UserPreferences` |
| `worker/src/db/queries/settings.rs` | ÄŒtenÃ­ a zÃ¡pis novÃ½ch preferencÃ­ |
| `worker/src/handlers/route.rs` | Po uloÅ¾enÃ­ trasy aktualizovat uÅ¾ivatelskÃ© preference |
| `packages/shared-types/src/settings.ts` | Pole do `UserPreferences` |
| `apps/web/src/services/settingsService.ts` | Pole do `UserPreferences` |

### 2.4 Frontend â€” zobrazenÃ­ a editace na timeline

| Soubor | Co pÅ™idat |
|---|---|
| `apps/web/src/components/planner/RouteDetailTimeline.tsx` | NovÃ½ props, zobrazenÃ­ drobnÃ½m pÃ­smem, inline editor |
| `apps/web/src/components/planner/RouteDetailTimeline.module.css` | Styly pro buffer info + editor |
| `apps/web/src/pages/PlanningInbox.tsx` | PÅ™edÃ¡nÃ­ buffer props do timeline, handler pro zmÄ›nu, pÅ™eÄtenÃ­ defaultu z preferences |
| `apps/web/public/locales/{cs,en,sk}/planner.json` | PÅ™eklady pro buffer label, editor |

---

## 3. DatovÃ½ model

### 3.1 Tabulka `routes` â€” novÃ© sloupce

```sql
arrival_buffer_percent         DOUBLE PRECISION NOT NULL DEFAULT 10.0,
arrival_buffer_fixed_minutes   DOUBLE PRECISION NOT NULL DEFAULT 0.0
```

### 3.2 Tabulka `users` â€” novÃ© sloupce (preference)

```sql
last_arrival_buffer_percent         DOUBLE PRECISION NOT NULL DEFAULT 10.0,
last_arrival_buffer_fixed_minutes   DOUBLE PRECISION NOT NULL DEFAULT 0.0
```

### 3.3 Tabulka `crews` â€” odebranÃ© sloupce

```
arrival_buffer_percent         -- ODEBRAT
arrival_buffer_fixed_minutes   -- ODEBRAT
```

### 3.4 Rust structs

```rust
// Route â€” pÅ™idat pole:
pub struct Route {
    // ... existujÃ­cÃ­ ...
    pub arrival_buffer_percent: f64,
    pub arrival_buffer_fixed_minutes: f64,
}

// SaveRouteRequest â€” pÅ™idat pole:
pub struct SaveRouteRequest {
    // ... existujÃ­cÃ­ ...
    pub arrival_buffer_percent: f64,
    pub arrival_buffer_fixed_minutes: f64,
}

// UserPreferences â€” pÅ™idat pole:
pub struct UserPreferences {
    // ... existujÃ­cÃ­ ...
    pub last_arrival_buffer_percent: f64,
    pub last_arrival_buffer_fixed_minutes: f64,
}
```

### 3.5 TypeScript types

```typescript
// Route â€” pÅ™idat pole:
export interface Route {
  // ... existujÃ­cÃ­ ...
  arrivalBufferPercent: number;
  arrivalBufferFixedMinutes: number;
}

// SaveRouteRequest â€” pÅ™idat pole:
export interface SaveRouteRequest {
  // ... existujÃ­cÃ­ ...
  arrivalBufferPercent: number;
  arrivalBufferFixedMinutes: number;
}

// SavedRoute â€” pÅ™idat pole:
export interface SavedRoute {
  // ... existujÃ­cÃ­ ...
  arrivalBufferPercent: number;
  arrivalBufferFixedMinutes: number;
}

// UserPreferences â€” pÅ™idat pole:
export interface UserPreferences {
  // ... existujÃ­cÃ­ ...
  lastArrivalBufferPercent: number;
  lastArrivalBufferFixedMinutes: number;
}
```

---

## 4. ChovÃ¡nÃ­

### 4.1 VytvoÅ™enÃ­ novÃ© trasy

1. Frontend naÄte `settings.preferences.lastArrivalBufferPercent` a `lastArrivalBufferFixedMinutes`.
2. Tyto hodnoty se drÅ¾Ã­ v lokÃ¡lnÃ­m stavu `PlanningInbox` (state `routeBufferPercent`, `routeBufferFixedMinutes`).
3. PÅ™i kaÅ¾dÃ©m `recalculateRoute()` se poÅ¡lou jako `arrivalBufferPercent` / `arrivalBufferFixedMinutes`.
4. PÅ™i kaÅ¾dÃ©m `saveRoute()` se poÅ¡lou v `SaveRouteRequest`.
5. Backend `handle_save_route` uloÅ¾Ã­ buffer do `routes` tabulky.
6. Backend po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­ aktualizuje `users.last_arrival_buffer_percent` a `users.last_arrival_buffer_fixed_minutes`.

### 4.2 NaÄtenÃ­ existujÃ­cÃ­ trasy

1. `getRoute()` vracÃ­ `SavedRoute` s `arrivalBufferPercent` a `arrivalBufferFixedMinutes`.
2. Frontend z tÄ›chto hodnot inicializuje lokÃ¡lnÃ­ stav.

### 4.3 Editace bufferu na timeline

1. Pod hlaviÄkou timeline (pod depot departure) je drobnÃ½ text: â€Rezerva: 10 % + 0 min".
2. Po kliknutÃ­ se text zmÄ›nÃ­ na inline editor (dva malÃ© inputy: `%` a `min`).
3. Po potvrzenÃ­ (Enter / blur) se:
   a. Aktualizuje lokÃ¡lnÃ­ stav.
   b. SpustÃ­ `recalculateRoute()` s novÃ½mi hodnotami.
   c. Autosave uloÅ¾Ã­ trasu (vÄetnÄ› novÃ©ho bufferu).

### 4.4 Route planning job (async)

`handle_route_plan_job` v `handlers/jobs.rs` dnes Äte buffer z posÃ¡dky. NovÄ›:

1. PÅ™ijme buffer jako parametr v `RoutePlanJobRequest`.
2. Frontend buffer pÅ™edÃ¡ pÅ™i submitu jobu.
3. AlternativnÄ›: job naÄte buffer z existujÃ­cÃ­ trasy v DB (pokud trasa uÅ¾ existuje).

---

## 5. UI mockup (RouteDetailTimeline)

```
ğŸ“ Sklad Brno                              â† depot card
   Odjezd: 07:24
   â”€â”€â”€ Rezerva: 10 % + 0 min âœï¸ â”€â”€â”€        â† novÃ½ Å™Ã¡dek, drobnÃ© pÃ­smo
   â–¼ 12.3 km â€¢ 18 min
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 1. NovÃ¡k s.r.o.                â”‚      â† stop card
   â”‚    PÅ™Ã­jezd: 07:42 â†’ Odjezd: ... â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â–¼ 8.1 km â€¢ 12 min
   ...
```

Po kliknutÃ­ na âœï¸:

```
   â”€â”€â”€ Rezerva: [10] % + [0] min  âœ“ âœ• â”€â”€â”€ â† inline edit
```

---

## 6. ImplementaÄnÃ­ plÃ¡n (TDD)

DatabÃ¡zi nemigrujeme â€” bude vytvoÅ™ena znovu. UpravÃ­me pÅ™Ã­mo `001_initial_schema.sql` a smaÅ¾eme starÃ© buffer migrace.

KaÅ¾dÃ½ krok se Å™Ã­dÃ­ cyklem RED â†’ GREEN â†’ REFACTOR:
1. Napsat failing test (RED)
2. Napsat minimÃ¡lnÃ­ implementaci, aby test proÅ¡el (GREEN)
3. Refaktorovat pokud potÅ™eba (REFACTOR)
4. OdÅ¡krtnout krok v tomto souboru

### FÃ¡ze 1: DatabÃ¡ze a migrace (scaffold)

- [x] **1.1** V `001_initial_schema.sql` pÅ™idat do tabulky `routes`:
  - `arrival_buffer_percent DOUBLE PRECISION NOT NULL DEFAULT 10.0`
  - `arrival_buffer_fixed_minutes DOUBLE PRECISION NOT NULL DEFAULT 0.0`
- [x] **1.2** V `001_initial_schema.sql` pÅ™idat do tabulky `users`:
  - `last_arrival_buffer_percent DOUBLE PRECISION NOT NULL DEFAULT 10.0`
  - `last_arrival_buffer_fixed_minutes DOUBLE PRECISION NOT NULL DEFAULT 0.0`
- [x] **1.3** V `001_initial_schema.sql` odebrat z tabulky `crews`: nebyly v base schema (pÅ™idÃ¡ny migracÃ­) âœ…
- [x] **1.4** Smazat migrace: `004_add_crew_buffer.sql`, `005_fix_crew_buffer_type.sql`, `014_add_crew_fixed_buffer.sql` âœ…

### FÃ¡ze 2: Rust typy â€” crew (odebrat buffer) + testy

- [x] **2.1** TEST: `test_crew_no_buffer_fields` â€” `CreateCrewRequest` bez `arrivalBufferPercent` se deserializuje OK; serializovanÃ½ `Crew` neobsahuje klÃ­Ä `arrivalBufferPercent`. âœ…
  - GREEN: OdebrÃ¡no ze struct `Crew`, `CreateCrewRequest`, `UpdateCrewRequest`. Testy pÅ™epsÃ¡ny.
- [x] **2.2** `db/queries/crew.rs` â€” odebrÃ¡ny buffer sloupce z INSERT, UPDATE, SELECT dotazÅ¯ âœ…
- [x] **2.3** `cargo check` â€” handlers doÄasnÄ› defaultujÃ­ buffer na 10.0/0.0 (TODO pro fÃ¡zi 6) âœ…

### FÃ¡ze 3: Rust typy â€” route (pÅ™idat buffer) + TDD

- [x] **3.1** TEST: `test_route_serializes_buffer_fields` â€” Route serializuje `arrivalBufferPercent` a `arrivalBufferFixedMinutes` âœ…
  - GREEN: PÅ™idÃ¡na pole do `types/route.rs` â†’ struct `Route`.
- [x] **3.2** TEST: `test_save_route_request_deserializes_buffer` â€” SaveRouteRequest deserializuje buffer z JSON âœ…
  - GREEN: PÅ™idÃ¡na pole do `SaveRouteRequest` v `handlers/route.rs`.
- [x] **3.3** TEST: `test_save_route_request_buffer_defaults` â€” bez buffer polÃ­ defaultuje na 10.0 / 0.0 âœ…
  - GREEN: `#[serde(default = "default_buffer_percent")]` a `#[serde(default)]`.
- [x] **3.4** `cargo check` âœ…

### FÃ¡ze 4: Rust typy â€” user preferences (pÅ™idat last-used buffer) + TDD

- [x] **4.1** TEST: `test_user_preferences_has_last_buffer` â€” serializace/deserializace buffer polÃ­ v `UserPreferences` âœ…
  - GREEN: PÅ™idÃ¡na pole do `UserPreferences`, `UserWithSettings`, `to_preferences()`.
- [x] **4.2** `cargo check` âœ…

### FÃ¡ze 5: DB dotazy â€” route upsert + TDD

- [ ] **5.1** TEST: `test_upsert_route_includes_buffer_columns` â€” ovÄ›Å™it, Å¾e SQL string v `upsert_route` obsahuje `arrival_buffer_percent` (grep/contains na generovanÃ©m dotazu, nebo integraÄnÃ­ test s DB).
  - RED: SQL neobsahuje buffer sloupce.
  - GREEN: PÅ™idat `arrival_buffer_percent` a `arrival_buffer_fixed_minutes` do INSERT, UPDATE, RETURNING v `db/queries/route.rs`.
- [ ] **5.2** TEST: `test_get_route_returns_buffer` â€” ovÄ›Å™it, Å¾e SELECT v `get_route` / `get_route_with_stops` vracÃ­ buffer sloupce.
  - RED: SELECT neobsahuje buffer.
  - GREEN: PÅ™idat sloupce do SELECT.
- [ ] **5.3** `db/queries/settings.rs` â€” pÅ™idat ÄtenÃ­ `last_arrival_buffer_percent`, `last_arrival_buffer_fixed_minutes` do `get_user_settings` a novou funkci `update_last_arrival_buffer(pool, user_id, percent, fixed)`.
- [ ] **5.4** `cargo check`

### FÃ¡ze 6: Handlery â€” save route uklÃ¡dÃ¡ buffer a aktualizuje preferences + TDD

- [ ] **6.1** TEST: `test_save_route_request_with_buffer_compiles` â€” vytvoÅ™it `SaveRouteRequest` s buffer poli, ovÄ›Å™it, Å¾e se serializuje/deserializuje.
  - RED/GREEN: MÄ›l by projÃ­t dÃ­ky fÃ¡zi 3. OvÄ›Å™enÃ­ konzistence.
- [ ] **6.2** `handlers/route.rs` â†’ `handle_save_route` â€” pÅ™edat `payload.arrival_buffer_percent` a `payload.arrival_buffer_fixed_minutes` do `upsert_route`. Po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­ zavolat `update_last_arrival_buffer(pool, user_id, ...)`.
- [ ] **6.3** `handlers/route.rs` â†’ `handle_get_route` â€” ovÄ›Å™it, Å¾e response struct obsahuje buffer pole (mÄ›lo by fungovat automaticky dÃ­ky fÃ¡zi 5.2).
- [ ] **6.4** `handlers/route.rs` â†’ `handle_recalculate` â€” beze zmÄ›ny (buffer uÅ¾ pÅ™ichÃ¡zÃ­ v payloadu).
- [ ] **6.5** TEST: `test_route_plan_job_accepts_buffer_in_payload` â€” `RoutePlanJobRequest` s buffer poli se deserializuje.
  - RED: Pole neexistujÃ­ v request typu.
  - GREEN: PÅ™idat pole do request struct.
- [ ] **6.6** `handlers/jobs.rs` â†’ `handle_route_plan_job` â€” neÄÃ­st buffer z `crew`, vzÃ­t z `payload.arrival_buffer_percent` / `payload.arrival_buffer_fixed_minutes`. Fallback na default `10.0` / `0.0`.
- [ ] **6.7** `cargo check`
- [ ] **6.8** `cargo test` â€” vÅ¡echny testy prochÃ¡zÃ­.

### FÃ¡ze 7: TypeScript shared types

- [ ] **7.1** `packages/shared-types/src/route.ts` â€” pÅ™idat `arrivalBufferPercent: number` a `arrivalBufferFixedMinutes: number` do `Route`.
- [ ] **7.2** `packages/shared-types/src/settings.ts` â€” pÅ™idat `lastArrivalBufferPercent: number` a `lastArrivalBufferFixedMinutes: number` do `UserPreferences`.

### FÃ¡ze 8: Frontend services

- [ ] **8.1** `routeService.ts` â€” pÅ™idat `arrivalBufferPercent` a `arrivalBufferFixedMinutes` do `SaveRouteRequest` a `SavedRoute`.
- [ ] **8.2** `crewService.ts` â€” odebrat `arrivalBufferPercent` a `arrivalBufferFixedMinutes` z `Crew`, `CreateCrewRequest`, `UpdateCrewRequest`.
- [ ] **8.3** `settingsService.ts` â€” ovÄ›Å™it, Å¾e `UserPreferences` interface (ze shared-types) reflektuje novÃ© buffer pole.
- [ ] **8.4** `tsc --noEmit` â€” ovÄ›Å™it kompilaci (oÄekÃ¡vÃ¡me chyby v PlanningInbox a Settings â€” opravÃ­me v dalÅ¡Ã­ch fÃ¡zÃ­ch).

### FÃ¡ze 9: Frontend â€” PlanningInbox (buffer state + flow)

- [ ] **9.1** PÅ™idat lokÃ¡lnÃ­ stav `routeBufferPercent` (init z `settings.preferences.lastArrivalBufferPercent ?? 10`) a `routeBufferFixedMinutes` (init z `settings.preferences.lastArrivalBufferFixedMinutes ?? 0`). PÅ™i naÄtenÃ­ existujÃ­cÃ­ trasy pÅ™epsat hodnotami z `savedRoute`.
- [ ] **9.2** `triggerRecalculate` â€” zmÄ›nit zdroj bufferu z `currentCrew?.arrivalBufferPercent` na lokÃ¡lnÃ­ `routeBufferPercent` / `routeBufferFixedMinutes`.
- [ ] **9.3** `autoSaveFn` â€” pÅ™edÃ¡vat `arrivalBufferPercent` a `arrivalBufferFixedMinutes` v `SaveRouteRequest`.
- [ ] **9.4** PÅ™idat handler `handleBufferChange(percent: number, fixedMinutes: number)` â†’ update stavu â†’ `triggerRecalculate()`.
- [ ] **9.5** PÅ™edat buffer props + `onBufferChange` do `RouteDetailTimeline` a `PlanningTimeline`.
- [ ] **9.6** `tsc --noEmit` â€” ovÄ›Å™it kompilaci.

### FÃ¡ze 10: Frontend â€” RouteDetailTimeline (zobrazenÃ­ a editace)

- [ ] **10.1** PÅ™idat props do `RouteDetailTimelineProps`: `arrivalBufferPercent?: number`, `arrivalBufferFixedMinutes?: number`, `onBufferChange?: (percent: number, fixedMinutes: number) => void`.
- [ ] **10.2** Zobrazit buffer info drobnÃ½m pÃ­smem pod depot departure: â€Rezerva: {pct} % + {fixed} min âœï¸". Pokud `onBufferChange` chybÃ­, nezobrazovat âœï¸.
- [ ] **10.3** Implementovat inline editor:
  - KliknutÃ­ na âœï¸ pÅ™epne do edit mÃ³du.
  - Dva malÃ© inputy (`number`): procento a fixnÃ­ minuty.
  - âœ“ potvrdÃ­ (zavolÃ¡ `onBufferChange`) a zavÅ™e editor.
  - âœ• zruÅ¡Ã­ a zavÅ™e editor.
  - Enter potvrdÃ­, Escape zruÅ¡Ã­.
- [ ] **10.4** PÅ™idat CSS styly do `RouteDetailTimeline.module.css`: `.bufferInfo`, `.bufferText`, `.bufferEditBtn`, `.bufferEditor`, `.bufferInput`.
- [ ] **10.5** `tsc --noEmit`

### FÃ¡ze 11: Frontend â€” Settings crew form (odebrat buffer)

- [ ] **11.1** `Settings.tsx` â€” odebrat `arrivalBufferPercent` a `arrivalBufferFixedMinutes` z `CrewFormData` interface. Odebrat inicializaci (defaulty 10 a 0). Odebrat oba input bloky. Odebrat z `createCrew()` a `updateCrew()` volÃ¡nÃ­. Odebrat zobrazenÃ­ v crew list.
- [ ] **11.2** Odebrat pÅ™eklad. klÃ­Äe `crew_arrival_buffer_percent`, `crew_arrival_buffer_hint`, `crew_arrival_buffer_fixed`, `crew_arrival_buffer_fixed_hint` z `{cs,en,sk}/settings.json`.
- [ ] **11.3** `tsc --noEmit`

### FÃ¡ze 12: Frontend â€” pÅ™eklady (novÃ© klÃ­Äe)

- [ ] **12.1** PÅ™idat pÅ™eklady do `{cs,en,sk}/planner.json`:
  - `route_buffer_label` â€” â€Rezerva" / â€Buffer" / â€Rezerva"
  - `route_buffer_percent_suffix` â€” â€% z pÅ™ejezdu" / â€% of travel" / â€% z prejazdu"
  - `route_buffer_fixed_suffix` â€” â€fixnÃ­ min" / â€fixed min" / â€fixnÃ© min"
  - `route_buffer_edit` â€” â€Upravit rezervu" / â€Edit buffer" / â€UpraviÅ¥ rezervu"

### FÃ¡ze 13: FinÃ¡lnÃ­ ovÄ›Å™enÃ­

- [ ] **13.1** `cargo check` â€” backend kompiluje bez chyb.
- [ ] **13.2** `cargo test` â€” vÅ¡echny testy prochÃ¡zÃ­.
- [ ] **13.3** `tsc --noEmit` â€” frontend kompiluje bez chyb.
- [ ] **13.4** ManuÃ¡lnÃ­ QA:
  - VytvoÅ™it novou trasu â†’ buffer se pÅ™edvyplnÃ­ z user preferences (10 % + 0 min).
  - OvÄ›Å™it zobrazenÃ­ bufferu na timeline drobnÃ½m pÃ­smem.
  - Kliknout na âœï¸ â†’ editovat â†’ potvrdit â†’ ovÄ›Å™it pÅ™epoÄet ETA.
  - UloÅ¾it trasu â†’ buffer se uloÅ¾Ã­ do DB.
  - VytvoÅ™it druhou trasu â†’ ovÄ›Å™it, Å¾e se pÅ™edvyplnÃ­ poslednÄ› pouÅ¾itÃ¡ hodnota.
  - OtevÅ™Ã­t nastavenÃ­ posÃ¡dky â†’ buffer tam uÅ¾ nenÃ­.

---

## 7. Soubory dotÄenÃ© zmÄ›nami

### SmazanÃ© soubory
- `worker/migrations/004_add_crew_buffer.sql`
- `worker/migrations/005_fix_crew_buffer_type.sql`
- `worker/migrations/014_add_crew_fixed_buffer.sql`

### ZmÄ›nÄ›nÃ© soubory â€” backend
- `worker/migrations/001_initial_schema.sql` â€” pÅ™idat buffer do `routes`, `users`; odebrat z `crews`
- `worker/src/types/crew.rs` â€” odebrat buffer pole + opravit testy
- `worker/src/types/route.rs` â€” pÅ™idat buffer pole
- `worker/src/types/settings.rs` â€” pÅ™idat `last_arrival_buffer_*`
- `worker/src/db/queries/crew.rs` â€” odebrat buffer z dotazÅ¯
- `worker/src/db/queries/route.rs` â€” pÅ™idat buffer do upsert/select
- `worker/src/db/queries/settings.rs` â€” ÄÃ­st/zapisovat `last_arrival_buffer_*`
- `worker/src/handlers/route.rs` â€” `handle_save_route` uklÃ¡dÃ¡ buffer + aktualizuje user prefs; `SaveRouteRequest` rozÅ¡Ã­Å™en
- `worker/src/handlers/jobs.rs` â€” neÄÃ­st buffer z crew, pÅ™ijmout v payloadu
- `worker/src/services/vrp/config.rs` â€” beze zmÄ›ny (buffer stÃ¡le pÅ™ichÃ¡zÃ­ zvenku)
- `worker/src/services/sequential_schedule.rs` â€” beze zmÄ›ny (buffer stÃ¡le pÅ™ichÃ¡zÃ­ zvenku)

### ZmÄ›nÄ›nÃ© soubory â€” shared types
- `packages/shared-types/src/route.ts` â€” buffer pole
- `packages/shared-types/src/settings.ts` â€” `lastArrivalBufferPercent`, `lastArrivalBufferFixedMinutes`

### ZmÄ›nÄ›nÃ© soubory â€” frontend
- `apps/web/src/services/routeService.ts` â€” buffer v `SaveRouteRequest`, `SavedRoute`
- `apps/web/src/services/crewService.ts` â€” odebrat buffer z `Crew`
- `apps/web/src/services/settingsService.ts` â€” buffer preference
- `apps/web/src/pages/Settings.tsx` â€” odebrat buffer z `CrewForm`
- `apps/web/src/pages/PlanningInbox.tsx` â€” buffer stav, flow, props
- `apps/web/src/components/planner/RouteDetailTimeline.tsx` â€” zobrazenÃ­ + inline editor
- `apps/web/src/components/planner/RouteDetailTimeline.module.css` â€” styly
- `apps/web/public/locales/cs/planner.json` â€” novÃ© pÅ™eklady
- `apps/web/public/locales/en/planner.json` â€” novÃ© pÅ™eklady
- `apps/web/public/locales/sk/planner.json` â€” novÃ© pÅ™eklady
- `apps/web/public/locales/cs/settings.json` â€” odebrat crew buffer klÃ­Äe
- `apps/web/public/locales/en/settings.json` â€” odebrat crew buffer klÃ­Äe
- `apps/web/public/locales/sk/settings.json` â€” odebrat crew buffer klÃ­Äe

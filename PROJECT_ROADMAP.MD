# Project Roadmap - Sazinka v1.0 GA

> **Last Updated:** 2026-01-30 (added Phase 5: Production Readiness)

## Current State Analysis

**Backend (Rust Worker):**
- Customer handlers: 100% complete
- Device handlers: 100% complete âœ…
- Revision handlers: 100% complete âœ…
- Route handlers: 100% complete (planning works)

**Frontend (React):**
- Customers/CustomerDetail: Fully functional + Devices + Timeline âœ…
- Planner: Fully functional + drag/drop + save/load âœ…
- Admin: Fully functional + Export UI âœ…
- Settings: Fully functional (work, business, email, depots) âœ…
- Dashboard: Real stats from revision.stats âœ…
- Calendar: Fully functional with real data âœ…

**Database:** Schema complete for all tables including communications and visits âœ…

---

## Roadmap Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PHASE 1: Core Flow âœ… COMPLETE                       â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Device CRUD  â”‚    â”‚ Revision CRUDâ”‚    â”‚  Dashboard   â”‚                 â”‚
â”‚   â”‚  Backend +   â”‚    â”‚  Backend +   â”‚    â”‚   Stats      â”‚                 â”‚
â”‚   â”‚  Frontend âœ… â”‚    â”‚  Frontend âœ… â”‚    â”‚      âœ…      â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE 2: Smart Planning âœ… COMPLETE                     â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚  Functional  â”‚    â”‚ Smart Plan   â”‚    â”‚ Planner UX   â”‚                 â”‚
â”‚   â”‚  Calendar âœ… â”‚    â”‚ Suggest. âœ…  â”‚    â”‚ + Persist âœ… â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PHASE 3: Users & Communication âœ… COMPLETE               â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚    User      â”‚    â”‚  Settings    â”‚    â”‚   Export +   â”‚                 â”‚
â”‚   â”‚  (mocked) âœ… â”‚    â”‚   UI âœ…      â”‚    â”‚   CSV âœ…     â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PHASE 4: CRM Evidence âœ… COMPLETE                      â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Communicationâ”‚    â”‚   Visits     â”‚    â”‚  Customer    â”‚                 â”‚
â”‚   â”‚    Log âœ…    â”‚    â”‚  Tracking âœ… â”‚    â”‚  Timeline âœ… â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PHASE 5: Production Readiness ğŸ“‹ PLANNED                   â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ 5A: Auth +   â”‚    â”‚ 5B: Billing  â”‚    â”‚ 5C: 2FA +    â”‚                 â”‚
â”‚   â”‚ Security ğŸ”´  â”‚â”€â”€â”€â–¶â”‚ + RLS  ğŸŸ¡    â”‚â”€â”€â”€â–¶â”‚ GDPR   ğŸŸ¢    â”‚                 â”‚
â”‚   â”‚  (MUST)      â”‚    â”‚  (SHOULD)    â”‚    â”‚  (NICE)      â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 1: Core Flow (Devices, Revisions, Dashboard) âœ… COMPLETE

> **Completed:** 2026-01-30

### 1.1 Device Handlers âœ…

**Files created:**
- `worker/src/handlers/device.rs` âœ…
- `worker/src/db/queries/device.rs` âœ…
- `worker/src/types/device.rs` âœ…

**NATS subjects (all implemented):**
- `sazinka.device.create` âœ…
- `sazinka.device.list` âœ…
- `sazinka.device.get` âœ…
- `sazinka.device.update` âœ…
- `sazinka.device.delete` âœ…

### 1.2 Revision Handlers âœ…

**Files created:**
- `worker/src/handlers/revision.rs` âœ…
- `worker/src/db/queries/revision.rs` âœ…
- `worker/src/types/revision.rs` âœ…

**NATS subjects (all implemented):**
- `sazinka.revision.create` âœ…
- `sazinka.revision.list` âœ…
- `sazinka.revision.get` âœ…
- `sazinka.revision.update` âœ…
- `sazinka.revision.complete` âœ…
- `sazinka.revision.upcoming` âœ…
- `sazinka.revision.stats` âœ…

### 1.3 Device Management UI âœ…

**Files created:**
- `apps/web/src/services/deviceService.ts` âœ… (with TDD tests)
- `apps/web/src/components/devices/DeviceList.tsx` âœ…
- `apps/web/src/components/devices/DeviceForm.tsx` âœ…
- `apps/web/src/pages/CustomerDetail.tsx` - Devices section added âœ…

### 1.4 Revision Management UI âœ…

**Files created:**
- `apps/web/src/services/revisionService.ts` âœ… (with TDD tests)
- `apps/web/src/components/revisions/RevisionList.tsx` âœ…
- `apps/web/src/components/revisions/RevisionForm.tsx` âœ…
- `apps/web/src/components/revisions/CompleteRevisionDialog.tsx` âœ…

### 1.5 Dashboard with Real Data âœ…

**Stats displayed:**
- Overdue revisions count (red) âœ…
- Due this week count (yellow) âœ…
- Scheduled today count (green) âœ…
- Completed this month count âœ…

---

## Phase 2: Smart Planning (Calendar, Intelligent Suggestions) âœ… COMPLETE

> **Completed:** 2026-01-30

### 2.1 Functional Calendar âœ…

**Files created:**
- `apps/web/src/pages/Calendar.tsx` - Complete rewrite âœ…
- `apps/web/src/components/calendar/CalendarGrid.tsx` âœ…
- `apps/web/src/components/calendar/DayCell.tsx` âœ…
- `apps/web/src/utils/calendarUtils.ts` âœ… (18 TDD tests)

**Features implemented:**
- Month navigation âœ…
- Display scheduled revisions per day âœ…
- Color coding by revision count/status âœ…
- Click day to see details or navigate to planner âœ…

### 2.2 Smart Plan Suggestion âœ…

**Files created/modified:**
- `worker/src/handlers/revision.rs` - Added handle_suggest âœ…
- `worker/src/db/queries/revision.rs` - Added get_revision_suggestions âœ…
- `worker/src/types/revision.rs` - Added suggestion types âœ…
- `apps/web/src/services/revisionService.ts` - Added getSuggestedRevisions (+4 TDD tests) âœ…
- `apps/web/src/pages/Planner.tsx` - Replaced random selection âœ…

**NATS subject:**
- `sazinka.revision.suggest` âœ…

**Priority scoring implemented:**
| Priority | Score | Criteria |
|----------|-------|----------|
| Overdue | 100 | due_date < today |
| Due this week | 80 | due_date <= today + 7 days |
| Due soon | 60 | due_date <= today + 14 days |
| Due this month | 40 | due_date <= today + 30 days |
| Upcoming | 20 | due_date > today + 30 days |

### 2.3 Planner UX Improvements âœ…

**Files created/modified:**
- `apps/web/src/components/planner/SortableStopItem.tsx` âœ…
- `apps/web/src/components/planner/SortableStopItem.module.css` âœ…
- `apps/web/src/pages/Planner.tsx` - Added DndContext âœ…

**Features implemented:**
- Drag and drop reordering with @dnd-kit âœ…
- Lock/unlock individual stops âœ…
- Visual feedback during drag âœ…
- "Manually reordered" indicator âœ…

### 2.4 Route Persistence âœ…

**Files created/modified:**
- `worker/src/handlers/route.rs` - Added handle_save, handle_get âœ…
- `worker/src/db/queries/route.rs` - Added route_stops queries âœ…
- `apps/web/src/services/routeService.ts` âœ…

**NATS subjects:**
- `sazinka.route.save` - Save planned route âœ…
- `sazinka.route.get` - Load route for date âœ…

**Features implemented:**
- Save current route with stops to database âœ…
- Load saved route for selected date âœ…
- "Load" button appears when saved route exists âœ…
- Last saved timestamp display âœ…

---

## Phase 3: Users, Settings, Communication ğŸ”„ IN PROGRESS

### 3.1 User Authentication (Skipped - using mock user)

**Status:** Deferred - using TEMP_USER_ID for now

### 3.2 User Settings UI âœ…

**Files created:**
- `apps/web/src/pages/Settings.tsx` âœ…
- `apps/web/src/pages/Settings.module.css` âœ…

**Features implemented:**
- Tab-based settings UI âœ…
- Work constraints form (hours, max revisions, service duration) âœ…
- Business info form (name, contact, billing) âœ…
- Email templates form âœ…
- Depots manager (list, add, edit, delete, set primary) âœ…

### 3.3 Export CSV âœ…

**Files created:**
- `apps/web/src/services/exportService.ts` âœ…

**Export types implemented:**
- Customers export (CSV format matching import) âœ…
- Revisions export with date range and status filters âœ…
- Export UI in Admin page âœ…

### 3.4 Basic Email Reminders (Stretch Goal)

**Files to create:**
- `worker/src/services/email.rs` - NEW
- `worker/src/handlers/email.rs` - NEW

**Features:**
- Email templates (Handlebars)
- Resend API integration
- Manual send button per revision
- Communications log

---

## Phase 4: CRM Evidence (Communication & Visits) âœ… COMPLETE

> **Completed:** 2026-01-30

### 4.1 Database Migration âœ…

**File:** `worker/migrations/20260130_000001_crm_enhancements.sql`
- Extended communications table with user_id, contact fields, follow-up tracking âœ…
- Created visits table with scheduling, status, and result tracking âœ…

### 4.2 Communication Handlers âœ…

**Files created:**
- `worker/src/types/communication.rs` âœ…
- `worker/src/handlers/communication.rs` âœ…
- `worker/src/db/queries/communication.rs` âœ…
- `packages/shared-types/src/communication.ts` âœ…
- `apps/web/src/services/communicationService.ts` âœ…

**NATS subjects implemented:**
- `sazinka.communication.create` âœ…
- `sazinka.communication.list` âœ…
- `sazinka.communication.update` âœ…
- `sazinka.communication.delete` âœ…

### 4.3 Visit Handlers âœ…

**Files created:**
- `worker/src/types/visit.rs` âœ…
- `worker/src/handlers/visit.rs` âœ…
- `worker/src/db/queries/visit.rs` âœ…
- `packages/shared-types/src/visit.ts` âœ…
- `apps/web/src/services/visitService.ts` âœ…

**NATS subjects implemented:**
- `sazinka.visit.create` âœ…
- `sazinka.visit.list` âœ…
- `sazinka.visit.update` âœ…
- `sazinka.visit.complete` âœ…
- `sazinka.visit.delete` âœ…

**Visit types (`visit_type`):**
| Type | Description |
|------|-------------|
| `revision` | Regular revision (links to revisions table) |
| `service` | Service call |
| `sales` | Sales meeting |
| `complaint` | Complaint handling |
| `consultation` | Consultation |
| `other` | Other |

### 4.4 Communication UI âœ…

**Files created:**
- `apps/web/src/services/communicationService.ts` âœ…
- Communication forms integrated into CustomerTimeline âœ…

### 4.5 Visit UI âœ…

**Files created:**
- `apps/web/src/services/visitService.ts` âœ…
- Visit forms integrated into CustomerTimeline âœ…

### 4.6 Customer Timeline âœ…

**Files created:**
- `apps/web/src/components/timeline/CustomerTimeline.tsx` âœ…
- `apps/web/src/components/timeline/CustomerTimeline.module.css` âœ…
- `apps/web/src/components/timeline/index.ts` âœ…

**Features implemented:**
- Unified chronological view with communications and visits âœ…
- Add communication form (notes, calls, emails, SMS) âœ…
- Add visit form with scheduling âœ…
- Status badges for visit states âœ…
- Icons for communication types âœ…

### 4.7 Dashboard Enhancements

(Stretch goal - deferred)
- Pending follow-ups count + list
- Today's visits count + list
- This week's visits count

---

## Phase 5: Production Readiness (Public SaaS) ğŸ“‹ PLANNED

> **Status:** Planning phase - required before public launch

### Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 5: Production Readiness                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 5A: Pre-Launch (MUST HAVE)                                           â”‚  â”‚
â”‚   â”‚  â”œâ”€ Authentication (JWT)                                             â”‚  â”‚
â”‚   â”‚  â”œâ”€ TLS on WebSocket                                                 â”‚  â”‚
â”‚   â”‚  â”œâ”€ Rate limiting                                                    â”‚  â”‚
â”‚   â”‚  â”œâ”€ Health checks                                                    â”‚  â”‚
â”‚   â”‚  â”œâ”€ Managed PostgreSQL                                               â”‚  â”‚
â”‚   â”‚  â””â”€ Error tracking (Sentry)                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 5B: Launch (SHOULD HAVE)                                             â”‚  â”‚
â”‚   â”‚  â”œâ”€ Row Level Security                                               â”‚  â”‚
â”‚   â”‚  â”œâ”€ Billing integration (Stripe)                                     â”‚  â”‚
â”‚   â”‚  â”œâ”€ Usage metering                                                   â”‚  â”‚
â”‚   â”‚  â”œâ”€ Uptime monitoring                                                â”‚  â”‚
â”‚   â”‚  â””â”€ Terms of Service + Privacy Policy                                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 5C: Post-Launch (NICE TO HAVE)                                       â”‚  â”‚
â”‚   â”‚  â”œâ”€ 2FA/MFA                                                          â”‚  â”‚
â”‚   â”‚  â”œâ”€ OAuth providers                                                  â”‚  â”‚
â”‚   â”‚  â”œâ”€ Full observability stack                                         â”‚  â”‚
â”‚   â”‚  â”œâ”€ GDPR compliance tools                                            â”‚  â”‚
â”‚   â”‚  â””â”€ Advanced audit logging                                           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5A: Pre-Launch (MUST HAVE) ğŸ”´

#### 5A.1 Authentication & Authorization

**Current state:** Hardcoded `TEMP_USER_ID`, no login flow

**Files to create/modify:**
- `worker/src/handlers/auth.rs` - JWT login/logout/verify
- `worker/src/middleware/auth.rs` - JWT validation middleware
- `apps/web/src/pages/Login.tsx` - Login form
- `apps/web/src/stores/authStore.ts` - Implement JWT storage

**Features:**
| Feature | Priority | Description |
|---------|----------|-------------|
| JWT login | MUST | Email + password â†’ JWT token |
| JWT refresh | MUST | Refresh token rotation |
| Password hashing | MUST | bcrypt or argon2 |
| Password reset | MUST | Email-based reset flow |
| Session invalidation | MUST | Logout clears tokens |

**NATS subjects:**
- `sazinka.auth.login` - Returns JWT + refresh token
- `sazinka.auth.logout` - Invalidates session
- `sazinka.auth.verify` - Validates JWT
- `sazinka.auth.refresh` - Rotates tokens
- `sazinka.auth.reset-password` - Initiates reset
- `sazinka.auth.set-password` - Completes reset

#### 5A.2 TLS on WebSocket

**Current state:** NATS WebSocket without encryption (warning in logs)

**Solution options:**
1. **Cloudflare Tunnel** (recommended) - Zero-config TLS termination
2. **nginx reverse proxy** - `proxy_pass` to NATS with SSL cert
3. **Native NATS TLS** - Configure certs in `nats-server.conf`

**Files to modify:**
- `infra/docker-compose.yml` - Add nginx or configure NATS TLS
- `infra/nginx.conf` - NEW (if using nginx)

#### 5A.3 Rate Limiting

**Current state:** Only geocoding has rate limiting

**Implementation:**
- Per-handler rate limits in Rust (token bucket algorithm)
- Or: nginx `limit_req_zone` directive

**Limits to implement:**
| Endpoint | Limit | Window |
|----------|-------|--------|
| `auth.login` | 5 | 1 min |
| `customer.*` | 100 | 1 min |
| `route.plan` | 10 | 1 min |
| `geocode.*` | 20 | 1 min |

#### 5A.4 Health Checks

**Current state:** Only `sazinka.ping` handler exists

**Endpoints to add:**
- `GET /health` - Basic liveness (HTTP, not NATS)
- `GET /ready` - Readiness (DB connected, services up)

**Files to create:**
- `worker/src/http_server.rs` - Minimal HTTP server for health checks

#### 5A.5 Managed PostgreSQL

**Current state:** Local Docker PostgreSQL

**Recommended providers:**
| Provider | Free tier | Backups | Notes |
|----------|-----------|---------|-------|
| **Neon** | 0.5 GB | Daily | Serverless, auto-scaling |
| **Supabase** | 500 MB | Daily | Includes auth (alternative) |
| **Railway** | $5 credit | Manual | Simple setup |

**Migration steps:**
1. Export schema and data
2. Update `DATABASE_URL` in production
3. Test connection from VPS

#### 5A.6 Error Tracking

**Current state:** File-based logging only

**Solution:** Sentry (free tier: 5K errors/month)

**Files to modify:**
- `worker/Cargo.toml` - Add `sentry` crate
- `worker/src/main.rs` - Initialize Sentry
- `apps/web/package.json` - Add `@sentry/react`
- `apps/web/src/main.tsx` - Initialize Sentry

---

### 5B: Launch (SHOULD HAVE) ğŸŸ¡

#### 5B.1 Row Level Security (RLS)

**Purpose:** Database-level tenant isolation

**Migration:**
```sql
-- Enable RLS on all tenant tables
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE devices ENABLE ROW LEVEL SECURITY;
ALTER TABLE revisions ENABLE ROW LEVEL SECURITY;
-- etc.

-- Create policies
CREATE POLICY tenant_isolation ON customers
    USING (user_id = current_setting('app.current_user_id')::uuid);
```

**Worker modification:**
```rust
// Set user context before each query
sqlx::query("SET app.current_user_id = $1")
    .bind(user_id)
    .execute(&pool)
    .await?;
```

#### 5B.2 Billing Integration

**Provider:** Stripe (recommended for simplicity)

**Database tables:**
```sql
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    plan_id VARCHAR(50) NOT NULL, -- 'free', 'basic', 'pro'
    status VARCHAR(20) NOT NULL,  -- 'active', 'canceled', 'past_due'
    current_period_end TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE usage_records (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    metric VARCHAR(50) NOT NULL, -- 'customers', 'geocoding', 'routes'
    count INTEGER NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL
);
```

**Plan limits:**
| Plan | Customers | Routes/day | Geocoding/month |
|------|-----------|------------|-----------------|
| Free | 50 | 5 | 100 |
| Basic | 500 | 20 | 1,000 |
| Pro | Unlimited | Unlimited | 10,000 |

#### 5B.3 Usage Metering

**Metrics to track:**
- `customers_count` - Total customers per user
- `routes_planned` - Routes planned per day
- `geocoding_requests` - Geocoding API calls per month
- `storage_bytes` - Future: attachments storage

**Implementation:**
- Increment counters in handlers
- Check limits before operations
- Return `LIMIT_EXCEEDED` error when over quota

#### 5B.4 Uptime Monitoring

**Services:**
- **UptimeRobot** (free: 50 monitors) - HTTP health checks
- **Better Stack** (free tier) - Incident management

**Monitors to create:**
- Frontend availability
- NATS WebSocket connectivity
- Health endpoint response time

#### 5B.5 Legal Documents

**Required documents:**
- Terms of Service (ToS)
- Privacy Policy
- Cookie Policy (if using cookies)
- Data Processing Agreement (DPA) for B2B

**Implementation:**
- Static pages in frontend
- Consent checkbox on signup

---

### 5C: Post-Launch (NICE TO HAVE) ğŸŸ¢

#### 5C.1 Two-Factor Authentication (2FA)

**Options:**
- TOTP (Google Authenticator, Authy)
- SMS (via Twilio)
- Email OTP

**Files to create:**
- `worker/src/services/totp.rs` - TOTP generation/verification
- `apps/web/src/components/auth/TwoFactorSetup.tsx`

#### 5C.2 OAuth Providers

**Providers to consider:**
- Google (most common)
- Microsoft (for B2B)
- Apple (for future mobile app)

**Library:** `oauth2` crate for Rust

#### 5C.3 Full Observability Stack

**Components:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Observability Stack                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚ Worker      â”‚â”€â”€â”€â–¶â”‚ Vector      â”‚â”€â”€â”€â–¶â”‚ Loki (logs)             â”‚â”‚
â”‚   â”‚ NATS        â”‚    â”‚             â”‚    â”‚ Prometheus (metrics)    â”‚â”‚
â”‚   â”‚ PostgreSQL  â”‚    â”‚             â”‚    â”‚ Tempo (traces)          â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚              â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                          â”‚ Grafana             â”‚   â”‚
â”‚                                          â”‚ - Dashboards        â”‚   â”‚
â”‚                                          â”‚ - Alerting          â”‚   â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Rust crates:**
- `tracing-opentelemetry` - Distributed tracing
- `metrics` + `metrics-exporter-prometheus` - Metrics export

#### 5C.4 GDPR Compliance

**Features to implement:**
- **Data export** - Full user data in JSON/ZIP
- **Data deletion** - "Right to be forgotten"
- **Consent management** - Track what user agreed to
- **Audit trail** - Who accessed what when

**Database tables:**
```sql
CREATE TABLE audit_log (
    id UUID PRIMARY KEY,
    user_id UUID,
    action VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50),
    entity_id UUID,
    old_value JSONB,
    new_value JSONB,
    ip_address INET,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE user_consents (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    consent_type VARCHAR(50) NOT NULL,
    granted BOOLEAN NOT NULL,
    granted_at TIMESTAMPTZ,
    revoked_at TIMESTAMPTZ
);
```

---

### Production Architecture Target

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Production Architecture                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚   â”‚ Cloudflare       â”‚  - CDN for static assets                             â”‚
â”‚   â”‚ (Edge)           â”‚  - TLS termination                                   â”‚
â”‚   â”‚                  â”‚  - DDoS protection                                   â”‚
â”‚   â”‚                  â”‚  - WAF rules                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚   â”‚ NATS Cluster     â”‚â—€â”€â”€â”€â”€â–¶â”‚ Worker Cluster   â”‚                           â”‚
â”‚   â”‚ (2+ nodes)       â”‚      â”‚ (2+ instances)   â”‚                           â”‚
â”‚   â”‚ + JetStream      â”‚      â”‚ + Health checks  â”‚                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                      â”‚                                      â”‚
â”‚                                      â–¼                                      â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                            â”‚ Managed PostgreSQLâ”‚                            â”‚
â”‚                            â”‚ (Neon/Supabase)  â”‚                             â”‚
â”‚                            â”‚ + Auto backups   â”‚                             â”‚
â”‚                            â”‚ + RLS enabled    â”‚                             â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚   â”‚ Valhalla         â”‚      â”‚ Nominatim        â”‚                           â”‚
â”‚   â”‚ (self-hosted)    â”‚      â”‚ (self-hosted)    â”‚                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ External Services                                                     â”‚ â”‚
â”‚   â”‚  â”œâ”€ Stripe (billing)                                                 â”‚ â”‚
â”‚   â”‚  â”œâ”€ Sentry (error tracking)                                          â”‚ â”‚
â”‚   â”‚  â”œâ”€ Resend (emails)                                                  â”‚ â”‚
â”‚   â”‚  â””â”€ UptimeRobot (monitoring)                                         â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

---

## Phase 6: UX Workflow (Call Queue, Smart Scheduling) ğŸš§ IN PROGRESS

> **Status:** Phase 6A-6B complete, 6C partially complete
> **Reference:** See `PROJECT_UX.MD` for full wireframes and concepts

### Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE 6: UX Workflow                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6A: Call Queue (MVP)                                                 â”‚  â”‚
â”‚   â”‚  â”œâ”€ Fronta k obvolÃ¡nÃ­ (revize v oknÄ› 11-12 mÄ›sÃ­cÅ¯)                  â”‚  â”‚
â”‚   â”‚  â”œâ”€ Filtry: oblast, typ sluÅ¾by, priorita                            â”‚  â”‚
â”‚   â”‚  â”œâ”€ Quick actions: Zavolat, OdloÅ¾it, Domluvit                       â”‚  â”‚
â”‚   â”‚  â””â”€ snooze_until pole pro odloÅ¾enÃ­                                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6B: Schedule Dialog (MVP)                                            â”‚  â”‚
â”‚   â”‚  â”œâ”€ VÃ½bÄ›r dne + ÄasovÃ©ho okna                                       â”‚  â”‚
â”‚   â”‚  â”œâ”€ PÅ™iÅ™azenÃ­ vozidla/technika                                      â”‚  â”‚
â”‚   â”‚  â”œâ”€ DÃ©lka Ãºkonu (default z device type)                             â”‚  â”‚
â”‚   â”‚  â””â”€ UloÅ¾enÃ­ do Revision (scheduled_date, time_window)               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6C: Enhanced Day Planner (MVP)                                       â”‚  â”‚
â”‚   â”‚  â”œâ”€ Seznam zastÃ¡vek s ÄasovÃ½mi okny                                 â”‚  â”‚
â”‚   â”‚  â”œâ”€ VarovÃ¡nÃ­ konfliktÅ¯ (ÄervenÃ©/Å¾lutÃ©)                              â”‚  â”‚
â”‚   â”‚  â”œâ”€ Vehicle tabs (multi-car)                                         â”‚  â”‚
â”‚   â”‚  â””â”€ Day load indicator                                               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6D: Technician View (MVP)                                            â”‚  â”‚
â”‚   â”‚  â”œâ”€ MÅ¯j dneÅ¡nÃ­ plÃ¡n (mobile-friendly)                               â”‚  â”‚
â”‚   â”‚  â”œâ”€ Per-stop: Navigovat, Volat, Hotovo, NezastiÅ¾en                  â”‚  â”‚
â”‚   â”‚  â””â”€ Export: segmented Google Maps + PDF                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6E: Smart Slots (V2)                                                 â”‚  â”‚
â”‚   â”‚  â”œâ”€ Insertion heuristic algoritmus                                   â”‚  â”‚
â”‚   â”‚  â”œâ”€ Valhalla matrix cache per den/vozidlo                           â”‚  â”‚
â”‚   â”‚  â”œâ”€ 3-5 doporuÄenÃ½ch slotÅ¯ pÅ™i domluvÄ›                              â”‚  â”‚
â”‚   â”‚  â””â”€ Vizualizace dopadu na trasu (+X min)                            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6A: Call Queue (Fronta k obvolÃ¡nÃ­)

**Database changes:**
```sql
ALTER TABLE revisions ADD COLUMN snooze_until DATE;
ALTER TABLE revisions ADD COLUMN snooze_reason VARCHAR(255);
```

**NATS subjects:**
- `sazinka.revision.queue` - List revisions in due window
- `sazinka.revision.snooze` - Postpone revision

**Files to create:**
- [x] `worker/src/db/queries/revision.rs` - Add queue query âœ…
- [x] `apps/web/src/pages/CallQueue.tsx` - NEW âœ…
- [x] `apps/web/src/pages/CallQueue.module.css` - NEW âœ…
- [x] Queue item inline in CallQueue.tsx (no separate component needed)

**Query logic:**
```sql
SELECT r.*, c.*, d.*
FROM revisions r
JOIN customers c ON r.customer_id = c.id
JOIN devices d ON r.device_id = d.id
WHERE r.user_id = $1
  AND r.status IN ('upcoming', 'scheduled')
  AND r.scheduled_date IS NULL  -- not yet scheduled
  AND (r.snooze_until IS NULL OR r.snooze_until <= CURRENT_DATE)
  AND r.due_date BETWEEN CURRENT_DATE - INTERVAL '30 days' 
                     AND CURRENT_DATE + INTERVAL '60 days'
ORDER BY 
  CASE WHEN r.due_date < CURRENT_DATE THEN 0 ELSE 1 END,  -- overdue first
  r.due_date ASC
```

---

### 6B: Schedule Dialog

**Database changes:**
```sql
ALTER TABLE revisions ADD COLUMN assigned_vehicle_id UUID;
ALTER TABLE revisions ADD COLUMN route_order INTEGER;

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  name VARCHAR(100) NOT NULL,
  home_depot_id UUID REFERENCES depots(id),
  preferred_areas TEXT[],
  working_hours_start TIME DEFAULT '08:00',
  working_hours_end TIME DEFAULT '17:00',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**NATS subjects:**
- `sazinka.vehicle.create` - Create vehicle
- `sazinka.vehicle.list` - List vehicles
- `sazinka.vehicle.update` - Update vehicle
- `sazinka.vehicle.delete` - Delete vehicle

**Files to create:**
- [x] `worker/src/types/vehicle.rs` - NEW âœ…
- [x] `worker/src/handlers/vehicle.rs` - NEW âœ…
- [x] `worker/src/db/queries/vehicle.rs` - NEW âœ…
- [ ] `apps/web/src/services/vehicleService.ts` - NEW (pending)
- [x] Schedule dialog inline in CallQueue.tsx âœ…

---

### 6C: Enhanced Day Planner

**Enhancements to existing Planner:**
- ~~Vehicle tabs (select which vehicle's route to view/edit)~~ (pending)
- ~~Time window display per stop~~ (pending)
- ~~Conflict warnings (time window violations)~~ (pending)
- ~~Day load indicator (total service time + travel time)~~ (pending)
- [x] View tabs: "DoporuÄenÃ©" / "NaplÃ¡novanÃ©" âœ…
- [x] Load scheduled revisions for selected date âœ…

**Files modified:**
- [x] `apps/web/src/pages/Planner.tsx` - Added view tabs, scheduled revisions âœ…
- [x] `apps/web/src/pages/Planner.module.css` - Tab styles âœ…

**Calendar enhancements:**
- [x] View mode toggle: "TermÃ­ny" (due_date) / "NaplÃ¡novanÃ©" (scheduled_date) âœ…
- [x] `apps/web/src/pages/Calendar.tsx` - Added view toggle âœ…
- [x] `apps/web/src/utils/calendarUtils.ts` - groupRevisionsByDay with dateField param âœ…

---

### 6D: Technician View

**Files to create:**
- [ ] `apps/web/src/pages/TechnicianDay.tsx` - NEW (mobile-friendly)
- [ ] `apps/web/src/pages/TechnicianDay.module.css` - NEW
- [ ] `apps/web/src/services/exportService.ts` - Add Google Maps + PDF

**Export features:**
- Segmented Google Maps links (8-10 stops per link)
- PDF with addresses, phones, time windows, notes
- "Navigate to next" single-stop links

---

### 6E: Smart Slots (V2)

**NATS subject:**
- `sazinka.slots.suggest` - Get best slots for new appointment

**Algorithm (insertion heuristic):**
1. Load existing route for day + vehicle
2. For each possible time slot (e.g., 08-10, 10-12, 12-14...):
   - Try inserting new stop at each position
   - Calculate delta travel time using Valhalla
   - Check feasibility (time windows)
   - Score: 60% delta time + 25% slack + 15% area coherence
3. Return top 3-5 slots with impact visualization

**Files to create:**
- [ ] `worker/src/services/slot_suggester.rs` - NEW
- [ ] `worker/src/handlers/slots.rs` - NEW
- [ ] `apps/web/src/services/slotService.ts` - NEW

---

## Out of Scope for v1.0

Explicitly excluded:
- Mobile app
- Multi-tenant/team features (multiple users per account)
- Invoice generation
- Document attachments
- Incoming email processing
- Advanced reporting/analytics
- Multi-region support

---

## Implementation Order

```
Phase 1 (Core Flow): âœ… COMPLETE
  1.1 Device handlers + queries âœ…
  1.2 Revision handlers + queries âœ…
  1.3 Device UI in CustomerDetail âœ…
  1.4 Revision UI components âœ…
  1.5 Dashboard stats âœ…

Phase 2 (Smart Planning): âœ… COMPLETE
  2.1 Calendar with real data âœ…
  2.2 Smart plan suggestion algorithm âœ…
  2.3 Drag/drop + lock/unlock âœ…
  2.4 Route persistence âœ…

Phase 3 (Users & Comms): âœ… COMPLETE
  3.1 Authentication (mocked) âœ…
  3.2 Settings UI âœ…
  3.3 CSV export âœ…
  3.4 Email reminders (stretch goal - deferred)

Phase 4 (CRM Evidence): âœ… COMPLETE
  4.1 Database migration (communications + visits) âœ…
  4.2 Communication handlers (TDD) âœ…
  4.3 Visit handlers (TDD) âœ…
  4.4 Communication UI components âœ…
  4.5 Visit UI components âœ…
  4.6 Customer Timeline âœ…
  4.7 Dashboard enhancements (deferred)

Phase 5 (Production Readiness): ğŸ“‹ PLANNED
  5A: Pre-Launch (MUST HAVE) ğŸ”´
    5A.1 JWT Authentication
    5A.2 TLS on WebSocket
    5A.3 Rate limiting
    5A.4 Health checks
    5A.5 Managed PostgreSQL
    5A.6 Error tracking (Sentry)
  
  5B: Launch (SHOULD HAVE) ğŸŸ¡
    5B.1 Row Level Security
    5B.2 Billing (Stripe)
    5B.3 Usage metering
    5B.4 Uptime monitoring
    5B.5 Legal documents (ToS, Privacy)
  
  5C: Post-Launch (NICE TO HAVE) ğŸŸ¢
    5C.1 Two-Factor Authentication
    5C.2 OAuth providers
    5C.3 Full observability stack
    5C.4 GDPR compliance tools

Phase 6 (UX Workflow): ğŸ”„ IN PROGRESS
  6A: Call Queue (MVP)
    6A.1 DB migration (snooze_until, snooze_reason) ğŸ”„
    6A.2 revision.queue endpoint (TDD)
    6A.3 revision.snooze endpoint (TDD)
    6A.4 CallQueue page UI
  
  6B: Schedule Dialog (MVP)
    6B.1 DB migration (vehicles table, assigned_vehicle_id)
    6B.2 Vehicle CRUD handlers (TDD)
    6B.3 ScheduleRevisionDialog component
  
  6C: Enhanced Day Planner (MVP)
    6C.1 Vehicle selector tabs
    6C.2 Time window display
    6C.3 Conflict warnings
  
  6D: Technician View (MVP)
    6D.1 TechnicianDay page
    6D.2 Google Maps export (segmented)
    6D.3 PDF export
  
  6E: Smart Slots (V2)
    6E.1 Insertion heuristic algorithm
    6E.2 Valhalla matrix cache
    6E.3 slots.suggest endpoint
    6E.4 UI integration
```

# Sazinka - Workflow & UI Koncept

> **Status:** MVP kompletnÃ­ + Phase 9 (Planner redesign) + sjednocenÃ­ komponent + Smart Slot Heuristics (multi-crew, Valhalla) + Auto-recalculation + Chronological insertion & break constraints + Routing accuracy fixes + Timeline UX improvements + Flexible time windows + Client detail redesign + Slot heuristics fixes  
> **Verze:** 0.9.2  
> **Datum:** 2026-02-17
> 
> **ImplementovÃ¡no:**
> - âœ… Fronta k obvolÃ¡nÃ­ (`/queue`) - filtry, statistiky, akce
> - âœ… Dialog pro plÃ¡novÃ¡nÃ­ nÃ¡vÅ¡tÄ›vy (datum, ÄasovÃ© okno, dÃ©lka)
> - âœ… Dialog pro odloÅ¾enÃ­ (snooze)
> - âœ… KalendÃ¡Å™ - pÅ™epÃ­naÄ TermÃ­ny/NaplÃ¡novanÃ©
> - âœ… **PlÃ¡n dne** (`/planner`) - slouÄenÃ¡ strÃ¡nka PlÃ¡novÃ¡nÃ­ + MÅ¯j den:
>   - Mapa s trasou + statistiky
>   - Seznam zastÃ¡vek s akcemi (navigovat, volat, hotovo)
>   - Google Maps export (single + segmented)
>   - Tisk/PDF
>   - NÃ¡hled fronty k obvolÃ¡nÃ­
> - âœ… Smart Slots - inteligentnÃ­ nÃ¡vrhy ÄasovÃ½ch slotÅ¯ podle existujÃ­cÃ­ trasy
> - âœ… Detail revize (`/revisions/:id`) - workflow hub
> - âœ… Dashboard - clickable stats, CTA fronta k obvolÃ¡nÃ­
> - âœ… **SjednocenÃ© komponenty Inbox/Planner** â€” `RouteDetailTimeline` + `RouteMapPanel` sdÃ­lenÃ© obÄ›ma strÃ¡nkami
> - âœ… **Bidirectional highlight** â€” klik na zastÃ¡vku/segment v timeline â†” zvÃ½raznÄ›nÃ­ na mapÄ›
> - âœ… **InsertionPreview** â€” vizualizace vloÅ¾enÃ­ kandidÃ¡ta do trasy na mapÄ› (Inbox only)
> - âœ… **Export+ asynchronnÄ›** â€” export joby bÄ›Å¾Ã­ na workeru a v `Ãšlohy` lze dokonÄenÃ½ export stÃ¡hnout pÅ™es `StÃ¡hnout export`
> - âœ… **NÃ¡zev export ZIP podle timezone uÅ¾ivatele** â€” `export-YYYYMMDD-HHMMSS-XX.zip` (Äas ve jmÃ©nÄ› respektuje timezone uÅ¾ivatele, kterÃ½ export spustil)
> - âœ… **ZÃ¡znam prÃ¡ce V1** (`/worklog`) â€” rychlÃ½ zÃ¡znam nÃ¡vÅ¡tÄ›vy, rychlÃ© dokonÄenÃ­ plÃ¡novanÃ©/probÃ­hajÃ­cÃ­ nÃ¡vÅ¡tÄ›vy, zachovanÃ© prokliky na den v kalendÃ¡Å™i / nÃ¡vÅ¡tÄ›vu / zÃ¡kaznÃ­ka, vÄetnÄ› mobilnÄ›-responsivnÃ­ho layoutu
> - âœ… **Auto-recalculation** â€” automatickÃ½ pÅ™epoÄet ETAs/ETDs po kaÅ¾dÃ©m vloÅ¾enÃ­ zastÃ¡vky nebo drag-and-drop pÅ™esunutÃ­ pomocÃ­ `sazinka.route.recalculate` (Valhalla matrix + sequential schedule)
> - âœ… **Chronological insertion** â€” novÃ© zastÃ¡vky se automaticky vklÃ¡dajÃ­ v chronologickÃ©m poÅ™adÃ­ podle `scheduledTimeStart`, nikoliv na konec trasy
> - âœ… **Break constraint enforcement** â€” pauza respektuje nakonfigurovanÃ© ÄasovÃ© okno (napÅ™. 11:30-13:00) a vklÃ¡dÃ¡ se do sprÃ¡vnÃ© mezery mezi zastÃ¡vkami, ne hned po pÅ™edchozÃ­ zastÃ¡vce
> - âœ… **Valhalla routing accuracy** â€” snapping radius snÃ­Å¾en z 50 km na 500 m (eliminuje detours zpÅ¯sobenÃ© mock geocodingem); break zastÃ¡vky (bez souÅ™adnic) jsou vylouÄeny z Valhalla matrix poÅ¾adavku, aby nezpÅ¯sobovaly fallback na MockRoutingService (40 km/h)
> - âœ… **Break chronological placement** â€” pÅ™i vÃ½bÄ›ru pozice pauzy se preferujÃ­ mezery, kam pauza chronologicky patÅ™Ã­ (`chronoFit`), takÅ¾e pauza v 11:30 se nevloÅ¾Ã­ pÅ™ed zastÃ¡vku v 08:00
> - âœ… **Timeline height halved + hourly labels** â€” vÃ½Å¡ka plÃ¡novacÃ­ timeline snÃ­Å¾ena na polovinu (`PIXELS_PER_MINUTE: 1.25`), vlevo pÅ™idÃ¡ny hodinovÃ© znaÄky
> - âœ… **Collapsible/expandable map** â€” mapa v Inboxu lze sbalit (zobrazit jen timeline) nebo rozbalit na celou strÃ¡nku
> - âœ… **Insertion preview deduplication** â€” opravena duplicitnÃ­ vizualizace nÃ¡vrhu vloÅ¾enÃ­ kandidÃ¡ta, kdy break rozdÄ›lujÃ­cÃ­ mezeru vytvÃ¡Å™el dva nÃ¡hledy mÃ­sto jednoho; `insertAfterIndex` se pÅ™iÅ™azuje jen mezerÃ¡m pÅ™ed customer stopy
> - âœ… **Flexible time windows** â€” rozliÅ¡enÃ­ mezi domluvenÃ½m ÄasovÃ½m oknem (napÅ™. 08:00-12:00) a potÅ™ebnÃ½m Äasem nÃ¡vÅ¡tÄ›vy (napÅ™. 1 hodina). DispeÄer nastavÃ­ "PotÅ™ebnÃ½ Äas" v detailu zÃ¡kaznÃ­ka pod "DomluvenÃ½ termÃ­n", solver umÃ­stÃ­ zastÃ¡vku optimÃ¡lnÄ› v rÃ¡mci okna. Timeline zobrazuje okno jako svÄ›tle modrÃ© pozadÃ­ za zastÃ¡vkou s popiskem "Okno HH:MM - HH:MM". Backend scheduler i VRP solver respektujÃ­ flexibilnÃ­ okna. Backward-compatible: zastÃ¡vky bez explicitnÃ­ho `serviceDurationMinutes` nebo kde `serviceDuration >= windowLength` zÅ¯stÃ¡vajÃ­ "pinned" (pÅ¯vodnÃ­ chovÃ¡nÃ­).
> - âœ… **Client detail layout redesign** â€” pÅ™echod z dvousloupcovÃ©ho na jednosloupcovÃ½ layout pro lepÅ¡Ã­ Äitelnost a vyuÅ¾itÃ­ prostoru. Sekce nynÃ­ v poÅ™adÃ­: DomluvenÃ½ termÃ­n (s inline service duration inputem pro flexibilnÃ­ okna), Revize nejpozdÄ›ji, Kontakt, Adresa, PoznÃ¡mky. AkÄnÃ­ tlaÄÃ­tka (Domluvit termÃ­n, PÅ™idat do trasy, OdloÅ¾it) pÅ™esunuty na konec. OdstranÄ›n `window.prompt()` pro zadÃ¡nÃ­ potÅ™ebnÃ©ho Äasu - nynÃ­ inline UI komponenta.
> - âœ… **Default service duration 60 min** â€” vÃ½chozÃ­ doba revize zmÄ›nÄ›na z 30 na 60 minut (backend defaults, frontend fallbacks, Settings page)
> - âœ… **Quarter-hour aligned slots** â€” navrhovanÃ© sloty zarovnÃ¡ny na Ätvrthodiny (8:00, 8:15, 8:30, 8:45) pomocÃ­ `ceil_quarter_hour()` v backend insertion a slot_suggester
> - âœ… **Slot overlap filtering** â€” navrhovanÃ© sloty se kontrolujÃ­ proti VÅ EM existujÃ­cÃ­m zastÃ¡vkÃ¡m (vÄ. pauz); pÅ™ekrÃ½vajÃ­cÃ­ se sloty se filtrujÃ­ a nezobrazujÃ­
> - âœ… **Timeline layout fix** â€” oprava vertikÃ¡lnÃ­ho layoutu PlanningTimeline: min. vÃ½Å¡ka stop/break karet 56px, odstranÄ›n margin drift v gapZone
> 
> **ZmÄ›ny v navigaci:**
> - `/planner` â†’ "PlÃ¡n dne" (slouÄeno PlÃ¡novÃ¡nÃ­ + MÅ¯j den)
> - `/today` â†’ pÅ™esmÄ›rovÃ¡nÃ­ na `/planner`
> - NavigaÄnÃ­ poloÅ¾ka "MÅ¯j den" odstranÄ›na

### âš ï¸ Internationalization note

> All UI labels, button text, error messages, and user-visible strings in this document are in Czech (original MVP language). These will be extracted to translation keys and available in English as part of the i18n migration â€” see `PRJ_I18N.MD` for the full phased plan. When implementing new UI features, use `t()` keys from the start, not hardcoded strings.

---

## PÅ™ehled

Tento dokument popisuje workflow a UI koncept pro klÃ­Äovou ÄÃ¡st aplikace Sazinka - plÃ¡novÃ¡nÃ­ pravidelnÃ½ch revizÃ­ a nÃ¡vÅ¡tÄ›v u zÃ¡kaznÃ­kÅ¯.

### CÃ­lovÃ¡ skupina
- DrobnÃ­ Å™emeslnÃ­ci (kominÃ­ci, plynaÅ™i, reviznÃ­ technici)
- PravidelnÃ© revize v intervalech 11-12 mÄ›sÃ­cÅ¯
- Jedna nebo vÃ­ce posÃ¡dek, jedno nebo vÃ­ce dep
- DispeÄerka + technici NEBO Å™emeslnÃ­k sÃ¡m

---

## ZÃ¡kladnÃ­ architektura

Aplikace mÃ¡ **3+1 vrstvy prÃ¡ce**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. CO SE BLÃÅ½Ã                                                  â”‚
â”‚     Automaticky spoÄÃ­tanÃ© "due window" (11-12 mÄ›sÃ­cÅ¯ od revize) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. DOMLUVIT                                                     â”‚
â”‚     Call workflow â†’ vybrat termÃ­n + ÄasovÃ© okno + sluÅ¾bu        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. NAPLÃNOVAT DEN                                               â”‚
â”‚     Route planner â†’ optimalizace poÅ™adÃ­ + ÄasovÃ¡ okna + depa    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. DEN VÃJEZDU (operativa)                                      â”‚
â”‚     RychlÃ© Ãºpravy, pÅ™esuny, export trasy                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Workflow krok za krokem

### 1. Po dokonÄenÃ­ revize â†’ automatickÃ¡ dalÅ¡Ã­ revize

KdyÅ¾ technik oznaÄÃ­ revizi jako "Hotovo":

1. UloÅ¾it `lastServiceAt` (datum dokonÄenÃ­)
2. SpoÄÃ­tat `nextDueFrom = lastServiceAt + 11 mÄ›sÃ­cÅ¯`
3. SpoÄÃ­tat `nextDueTo = lastServiceAt + 12 mÄ›sÃ­cÅ¯`
4. VytvoÅ™it novou revizi se stavem "ÄekÃ¡ na kontakt"

**UI - Detail zÃ¡kaznÃ­ka:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  Jan NovÃ¡k                                    â”‚
â”‚ Revize plynovÃ©ho kotle                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PoslednÃ­ revize: 15.01.2026 (kotel)            â”‚
â”‚ DalÅ¡Ã­ revize:    10.12.2026 â€“ 15.01.2027       â”‚
â”‚ Stav:            â³ ÄŒekÃ¡ na kontakt             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ“ Zavolat]  [ğŸ“… Domluvit]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. Fronta k obvolÃ¡nÃ­

HlavnÃ­ pracovnÃ­ obrazovka pro dispeÄerku i Å™emeslnÃ­ka-sÃ³listu.

**ZobrazenÃ­:**
- ZÃ¡kaznÃ­ci v oknÄ› 11-12 mÄ›sÃ­cÅ¯ od poslednÃ­ revize
- ZÃ¡kaznÃ­ci po termÃ­nu (prioritnÄ› nahoÅ™e)

**Filtry:**
- Oblast (mÄ›sto/PSÄŒ/region)
- Typ sluÅ¾by (kotel, komÃ­n, plyn...)
- Depo/posÃ¡dka
- Priorita
- "Nevolat dopoledne" a podobnÃ© preference

**Informace u kaÅ¾dÃ©ho zÃ¡kaznÃ­ka:**
1. Kde je zÃ¡kaznÃ­k (adresa + mini mapa / region)
2. Jak dlouho trvÃ¡ Ãºkon (servisnÃ­ Äas)
3. Stav kontaktu (naposledy volÃ¡no, poznÃ¡mka)

**UI - Fronta k obvolÃ¡nÃ­:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ Fronta k obvolÃ¡nÃ­                    [Filtr â–¾] [Oblast â–¾]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚ ğŸ”´ PO TERMÃNU (3)                                                   â”‚
â”‚ â”œâ”€â”€ Karel Svoboda    â”‚ Brno-stÅ™ed  â”‚ Kotel 45min â”‚ â˜ï¸ 3x neÃºspÄ›Å¡nÄ› â”‚
â”‚ â”œâ”€â”€ Marie DvoÅ™Ã¡kovÃ¡  â”‚ Brno-sever  â”‚ KomÃ­n 30min â”‚ â˜ï¸ NezvedÃ¡      â”‚
â”‚ â””â”€â”€ Petr ÄŒernÃ½       â”‚ Blansko     â”‚ Kotel 45min â”‚ â˜ï¸ NevolÃ¡no     â”‚
â”‚                                                                     â”‚
â”‚ ğŸŸ¡ TENTO TÃDEN (8)                                                  â”‚
â”‚ â”œâ”€â”€ Jana NovÃ¡kovÃ¡    â”‚ VyÅ¡kov      â”‚ Kotel 45min â”‚ â˜ï¸ NevolÃ¡no     â”‚
â”‚ â”œâ”€â”€ ...                                                             â”‚
â”‚                                                                     â”‚
â”‚ ğŸŸ¢ PÅ˜ÃÅ TÃ TÃDEN (12)                                                â”‚
â”‚ â””â”€â”€ ...                                                             â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Celkem: 23 zÃ¡kaznÃ­kÅ¯ k obvolÃ¡nÃ­                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Domluva nÃ¡vÅ¡tÄ›vy (klÃ­ÄovÃ¡ obrazovka)

**ZÃ¡sadnÃ­ princip:** PÅ™i domluvÄ› nesmÃ­Å¡ vybÃ­rat sloty naslepo. NabÃ­dka termÃ­nÅ¯ musÃ­ odrÃ¡Å¾et realitu trasy.

**UI - Dialog "Domluvit nÃ¡vÅ¡tÄ›vu":**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“… Domluvit nÃ¡vÅ¡tÄ›vu                                         [âœ•]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚ ZÃKAZNÃK                                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Jan NovÃ¡k                                                       â”‚ â”‚
â”‚ â”‚ LesnÃ­ 123, Brno 61500                                          â”‚ â”‚
â”‚ â”‚ ğŸ“ +420 777 123 456                                             â”‚ â”‚
â”‚ â”‚ âš ï¸ PoznÃ¡mka: Parkovat za domem, zvonek nefunguje               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚ TYP ÃšKONU                           DÃ‰LKA                          â”‚
â”‚ [Revize kotle      â–¾]               [45 min â–¾]                     â”‚
â”‚                                                                     â”‚
â”‚ KDO POJEDE                          DEPO                           â”‚
â”‚ [Technik 1 - Petr  â–¾]               [Brno-stÅ™ed â–¾]                 â”‚
â”‚                                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                     â”‚
â”‚ VÃBÄšR DNE                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Po    Ãšt    St    ÄŒt    PÃ¡    So    Ne                        â”‚ â”‚
â”‚ â”‚  27    28    29    30    31     1     2                        â”‚ â”‚
â”‚ â”‚  [3]   [5]   [2]  [ğŸ”µ4]  [6]   [-]   [-]                       â”‚ â”‚
â”‚ â”‚                    â†‘ vybranÃ½ den                                â”‚ â”‚
â”‚ â”‚  (ÄÃ­sla = poÄet volnÃ½ch slotÅ¯)                                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚ DOPORUÄŒENÃ‰ SLOTY PRO 30.01.2026 (Multi-crew, Valhalla)             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸš PosÃ¡dka P1 (5 zastÃ¡vek, 78% dne)                            â”‚ â”‚
â”‚ â”‚ â”œâ”€ â­ 10:15 - 11:00  â”‚ 92%  â”‚ +8min â”‚ OK    â”‚ [Vybrat]        â”‚ â”‚
â”‚ â”‚ â”œâ”€    14:00 - 15:00  â”‚ 71%  â”‚ +22minâ”‚ TÄ›snÃ½ â”‚ [Vybrat]        â”‚ â”‚
â”‚ â”‚                                                                 â”‚ â”‚
â”‚ â”‚ ğŸš PosÃ¡dka P2 (3 zastÃ¡vky, 45% dne)                            â”‚ â”‚
â”‚ â”‚ â”œâ”€    10:30 - 11:30  â”‚ 85%  â”‚ +12minâ”‚ OK    â”‚ [Vybrat]        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚ NEBO VLASTNÃ ÄŒAS  (real-time validace, debounced 500ms)            â”‚
â”‚ [ÄŒasovÃ© okno: ___:___ - ___:___]                                   â”‚
â”‚ âŒ Slot se pÅ™ekrÃ½vÃ¡ s nÃ¡vÅ¡tÄ›vou DvoÅ™Ã¡kovÃ¡ (error)                  â”‚
â”‚ âš ï¸ PÅ™ed slotem je minimÃ¡lnÃ­ ÄasovÃ¡ rezerva (warning)               â”‚
â”‚ â†’ OdhadovanÃ½ pÅ™Ã­jezd: 10:03 | Rezerva: 12 min                     â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              [ZruÅ¡it]  [âœ“ Domluvit nÃ¡vÅ¡tÄ›vu]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Algoritmus nabÃ­dky slotÅ¯ (v2 â€” multi-crew, Valhalla):**

Aplikace v pozadÃ­ (`sazinka.slots.suggest.v2`):
1. Pro **vÅ¡echny aktivnÃ­ posÃ¡dky** (nebo vybranou podmnoÅ¾inu) naÄte existujÃ­cÃ­ trasu + naplÃ¡novanÃ© revize
2. PomocÃ­ **Valhalla** spoÄÃ­tÃ¡ matice vzdÃ¡lenostÃ­/ÄasÅ¯ (reÃ¡lnÃ© souÅ™adnice zÃ¡kaznÃ­kÅ¯ z DB)
3. Pro kaÅ¾dou posÃ¡dku najde **optimÃ¡lnÃ­ inserÄnÃ­ pozice** (sdÃ­lenÃ¡ logika `calculate_insertion_positions`)
4. OhodnotÃ­ kaÅ¾dÃ½ slot **skÃ³rovacÃ­ funkcÃ­**:
   - 40% travel (delta_minutes) â€” menÅ¡Ã­ objÃ­Å¾Äka = lepÅ¡Ã­
   - 25% fit (slack_before + slack_after) â€” vÃ­ce rezervy = lepÅ¡Ã­
   - 20% preference â€” shoda s preferovanÃ½m Äasem zÃ¡kaznÃ­ka
   - 15% balance â€” vyrovnanÃ© vytÃ­Å¾enÃ­ posÃ¡dek
5. Status badge: **OK** (zelenÃ½), **TÄ›snÃ½** (Å¾lutÃ½, slack <15 min), **Konflikt** (ÄervenÃ½)

**Validace ruÄnÄ› zadanÃ©ho slotu** (`sazinka.slots.validate`):
- PÅ™ekryv s existujÃ­cÃ­ nÃ¡vÅ¡tÄ›vou (error)
- NedosaÅ¾itelnÃ½ Äas â€” cestovnÃ­ doba nestihne (error)
- Mimo pracovnÃ­ dobu (error)
- MinimÃ¡lnÃ­ rezerva <15 min (warning)
- PÅ™etÃ­Å¾enÃ½ den >90% (warning)
- Zasahuje do okna pauzy (warning)

Pokud validace vrÃ¡tÃ­ `feasible: false`, zobrazÃ­ se **warning box** s moÅ¾nostÃ­ "PÅ™esto naplÃ¡novat" nebo "Vybrat jinÃ½ slot".

---

### 4. PlÃ¡novÃ¡nÃ­ dne (dispeÄerskÃ½ pohled)

Zde se sklÃ¡dÃ¡ dennÃ­ plÃ¡n a Å™eÅ¡Ã­ multi-car a depa.

**UI - PlÃ¡novaÄ dne:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“… PlÃ¡n dne: 30.01.2026              [â—€ PÅ™edchozÃ­] [DalÅ¡Ã­ â–¶]               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Technik 1 - Petr]  [Technik 2 - Jan]  [+ PÅ™idat posÃ¡dku]                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ZASTÃVKY (9)           â”‚                    MAPA                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ  Depo Brno       â”‚ â”‚  â”‚                                            â”‚   â”‚
â”‚ â”‚    Start 08:00     â”‚ â”‚  â”‚         ğŸ                                  â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â”‚          â•²                                 â”‚   â”‚
â”‚ â”‚ 1. Jan NovÃ¡k       â”‚ â”‚  â”‚           â•²  â‘                             â”‚   â”‚
â”‚ â”‚    08:27 - 09:12   â”‚ â”‚  â”‚            â•²â”€â”€â—                            â”‚   â”‚
â”‚ â”‚    â±ï¸ 45min â”‚ ğŸ”’    â”‚ â”‚  â”‚               â•²                           â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â”‚                â•²  â‘¡                       â”‚   â”‚
â”‚ â”‚ 2. Marie SvobodovÃ¡ â”‚ â”‚  â”‚                 â—â”€â”€â•²                       â”‚   â”‚
â”‚ â”‚    09:35 - 10:05   â”‚ â”‚  â”‚                      â•²  â‘¢                  â”‚   â”‚
â”‚ â”‚    â±ï¸ 30min        â”‚ â”‚  â”‚                       â—                    â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â”‚                      â•±                     â”‚   â”‚
â”‚ â”‚ 3. Petr ÄŒernÃ½      â”‚ â”‚  â”‚                    â•±                       â”‚   â”‚
â”‚ â”‚    10:28 - 11:13   â”‚ â”‚  â”‚                  ğŸ                         â”‚   â”‚
â”‚ â”‚    â±ï¸ 45min â”‚ âš ï¸    â”‚ â”‚  â”‚                                            â”‚   â”‚
â”‚ â”‚    Riziko zpoÅ¾dÄ›nÃ­ â”‚ â”‚  â”‚                                            â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”‚ ...                â”‚ â”‚                                                    â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  STATISTIKY                                       â”‚
â”‚ â”‚ ğŸ  Depo Brno       â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚    NÃ¡vrat ~16:30   â”‚ â”‚  â”‚ CelkovÃ¡ vzdÃ¡lenost:  87 km                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ CelkovÃ½ Äas:         6h 45min              â”‚   â”‚
â”‚                        â”‚  â”‚ ServisnÃ­ Äas:        5h 15min              â”‚   â”‚
â”‚ [â†» Re-optimalizovat]   â”‚  â”‚ ÄŒas na cestÄ›:        1h 30min              â”‚   â”‚
â”‚ [+ PÅ™idat zastÃ¡vku]    â”‚  â”‚ Konflikty:           1 âš ï¸                   â”‚   â”‚
â”‚                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Interakce:**
- Drag & drop pro zmÄ›nu poÅ™adÃ­ zastÃ¡vek
- "Re-optimalizovat" tlaÄÃ­tko (zachovÃ¡ domluvenÃ¡ okna)
- "Zamknout poÅ™adÃ­" ğŸ”’ pro citlivÃ© zakÃ¡zky
- PÅ™etÃ¡hnout zakÃ¡zku mezi auty (multi-car reÅ¾im)

**VarovÃ¡nÃ­ (musÃ­ bÃ½t velmi viditelnÃ¡):**
- ğŸ”´ ÄŒasovÃ© okno nestÃ­hÃ¡ vyjÃ­t
- ğŸŸ¡ Riziko zpoÅ¾dÄ›nÃ­ (trasa natÄ›sno)
- ğŸŸ  PÅ™ejezd pÅ™Ã­liÅ¡ dlouhÃ½
- âš« PÅ™ekroÄenÃ­ pracovnÃ­ doby

---

### 5. Den vÃ½jezdu (operativa + export)

Bez mobilnÃ­ aplikace potÅ™ebuje technik jednoduchÃ© webovÃ© rozhranÃ­.

**UI - MÅ¯j dneÅ¡nÃ­ plÃ¡n:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“± MÅ¯j plÃ¡n na 30.01.2026                        [ğŸ”„] [ğŸ“¤ Export]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â‘  Jan NovÃ¡k                                    08:27 - 09:12   â”‚ â”‚
â”‚ â”‚    LesnÃ­ 123, Brno                                              â”‚ â”‚
â”‚ â”‚    ğŸ“ +420 777 123 456                                          â”‚ â”‚
â”‚ â”‚    Revize kotle â”‚ 45 min                                        â”‚ â”‚
â”‚ â”‚    âš ï¸ Parkovat za domem                                         â”‚ â”‚
â”‚ â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚ â”‚    [ğŸ—ºï¸ Navigovat]  [ğŸ“ Volat]  [âœ“ Hotovo]  [âœ• NezastiÅ¾en]      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â‘¡ Marie SvobodovÃ¡                              09:35 - 10:05   â”‚ â”‚
â”‚ â”‚    HlavnÃ­ 45, Brno-sever                                        â”‚ â”‚
â”‚ â”‚    ğŸ“ +420 608 234 567                                          â”‚ â”‚
â”‚ â”‚    VymetÃ¡nÃ­ komÃ­nu â”‚ 30 min                                     â”‚ â”‚
â”‚ â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚ â”‚    [ğŸ—ºï¸ Navigovat]  [ğŸ“ Volat]  [âœ“ Hotovo]  [âœ• NezastiÅ¾en]      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚ ... dalÅ¡Ã­ zastÃ¡vky ...                                              â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hotovo: 0/9  â”‚  ZbÃ½vÃ¡: ~6h 45min  â”‚  DalÅ¡Ã­: Jan NovÃ¡k za 15 min   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Exporty:**
- "OtevÅ™Ã­t trasu v Google Maps" (waypoints, pÅ™i limitu rozdÄ›lit)
- PDF "dennÃ­ plÃ¡n" (adresa, okno, poznÃ¡mky, telefon)
- CSV export (pro vlastnÃ­ navigaci / archiv)

---

## Role a reÅ¾imy pouÅ¾itÃ­

> **Autentizace:** PÅ™Ã­stup k aplikaci vyÅ¾aduje pÅ™ihlÃ¡Å¡enÃ­ (JWT). Role jsou vynuceny na backendu i frontendu. Viz `PROJECT_MULTIUSER.MD`.

### Role

| Role | PÅ™Ã­stup ke strÃ¡nkÃ¡m | Popis |
|------|---------------------|-------|
| **Admin** | VÅ¡e vÄetnÄ› Admin panelu | SprÃ¡vce systÃ©mu |
| **Customer** | VÅ¡e kromÄ› Admin (vÄetnÄ› NastavenÃ­) | Majitel firmy, mÅ¯Å¾e vytvÃ¡Å™et pracovnÃ­ky |
| **Worker** | VÅ¡e kromÄ› Admin a NastavenÃ­ | ZamÄ›stnanec, vidÃ­ data svÃ©ho zÃ¡kaznÃ­ka |

### ReÅ¾im A: DispeÄerka + 1-N aut (Customer + Workers)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DispeÄerka    â”‚     â”‚   Technik 1     â”‚     â”‚   Technik 2     â”‚
â”‚   (Customer)    â”‚     â”‚   (Worker)      â”‚     â”‚   (Worker)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Fronta        â”‚     â”‚ â€¢ MÅ¯j plÃ¡n      â”‚     â”‚ â€¢ MÅ¯j plÃ¡n      â”‚
â”‚ â€¢ Domluva       â”‚â”€â”€â”€â”€â–¶â”‚ â€¢ Status update â”‚     â”‚ â€¢ Status update â”‚
â”‚ â€¢ PlÃ¡novÃ¡nÃ­     â”‚     â”‚ â€¢ Export        â”‚     â”‚ â€¢ Export        â”‚
â”‚ â€¢ PÅ™ehledy      â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â€¢ NastavenÃ­     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ReÅ¾im B: Å˜emeslnÃ­k sÃ¡m (Customer bez Workers)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Å˜emeslnÃ­k (Customer, vÅ¡e sÃ¡m)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Fronta + mini plÃ¡novÃ¡nÃ­ v jednom  â”‚
â”‚ â€¢ "MÅ¯j plÃ¡n" jako vÃ½chozÃ­ homepage  â”‚
â”‚ â€¢ Domluva s automatickÃ½mi sloty     â”‚
â”‚ â€¢ NastavenÃ­                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## KlÃ­ÄovÃ© datovÃ© entity

| Entita | Popis | KlÃ­ÄovÃ© atributy |
|--------|-------|------------------|
| Customer | ZÃ¡kaznÃ­k | adresa, GPS, kontakt, poznÃ¡mky |
| Device | ZaÅ™Ã­zenÃ­ k revizi | typ, revision_interval_months |
| Revision | PlÃ¡novanÃ¡/provedenÃ¡ revize | due_date, scheduled_date, time_window, status |
| Crew | PosÃ¡dka/technik | depot_id, kapacita, pracovnÃ­ doba |
| Depot | VÃ½chozÃ­ mÃ­sto | adresa, GPS |
| Route | DennÃ­ plÃ¡n | datum, crew_id, zastÃ¡vky[], statistiky |

---

## Stavy revize (lifecycle)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   VYTVOÅ˜ENO  â”‚
                    â”‚ (automaticky)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ODLOÅ½ENO   â”‚â—„â”€â”€â”€â”‚   ÄŒEKÃ NA    â”‚
â”‚              â”‚    â”‚   KONTAKT    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚ zÃ¡kaznÃ­k kontaktovÃ¡n
       â”‚                   â–¼
       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  DOMLUVENO   â”‚
                   â”‚ (mÃ¡ termÃ­n)  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ pÅ™iÅ™azeno do trasy
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ NAPLÃNOVÃNO  â”‚
                   â”‚ (v trase)    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼             â–¼             â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ HOTOVO   â”‚  â”‚NEZASTIÅ½ENâ”‚  â”‚ ZRUÅ ENO  â”‚
     â”‚          â”‚  â”‚          â”‚  â”‚          â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ automaticky
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  DALÅ Ã   â”‚
     â”‚ REVIZE   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## DvÄ› UX vÄ›ci, kterÃ© udÄ›lajÃ­ nejvÄ›tÅ¡Ã­ rozdÃ­l

### 1. NabÃ­dka slotÅ¯ pÅ™i domluvÄ›
Ne "vyberte si datum a Äas naslepo", ale inteligentnÃ­ nÃ¡vrhy na zÃ¡kladÄ› aktuÃ¡lnÃ­ trasy.

### 2. Jedno kliknutÃ­: z domluvy do plÃ¡nu
A hned vidÄ›t dopad na trasu (vzdÃ¡lenost, Äas, konflikty).

---

## PlÃ¡n integrace UI podle workflow

CÃ­l: UÅ¾ivatel nesmÃ­ "pÅ™eskakovat" mezi izolovanÃ½mi strÃ¡nkami. KaÅ¾dÃ¡ obrazovka musÃ­ nabÃ­dnout jasnÃ½ dalÅ¡Ã­ krok a kontext.

### GlobÃ¡lnÃ­ pravidla navigace
- VÅ¾dy viditelnÃ© CTA pro dalÅ¡Ã­ krok workflow (napravo nahoÅ™e / v detail panelu).
- KaÅ¾dÃ¡ revize/zÃ¡kaznÃ­k mÃ¡ dostupnÃ© akce: `Detail`, `Domluvit`, `NaplÃ¡novat`, `OznaÄit hotovo` podle stavu.
- ZobrazenÃ­ kontextu: u kaÅ¾dÃ© revize vÅ¾dy zobrazit zÃ¡kaznÃ­ka, adresu, termÃ­n a stav.

### StrÃ¡nky a jejich propojenÃ­ (MVP plÃ¡n)
1. Dashboard
   - CTA: "Fronta k obvolÃ¡nÃ­" (primÃ¡rnÃ­), "PlÃ¡novÃ¡nÃ­ dne" (sekundÃ¡rnÃ­), "MÅ¯j den".
   - Widgety "Po termÃ­nu" a "Tento tÃ½den" musÃ­ bÃ½t klikatelnÃ© â†’ filtr na frontu nebo kalendÃ¡Å™.

2. Fronta k obvolÃ¡nÃ­ (`/queue`)
   - Akce "NaplÃ¡novat" po uloÅ¾enÃ­ pÅ™esmÄ›ruje do PlÃ¡novaÄe na vybranÃ½ den.
   - PÅ™idat proklik na `Detail zÃ¡kaznÃ­ka` a `Detail revize`.
   - V kartÄ› ukÃ¡zat poslednÃ­ komunikaci a poznÃ¡mku (z timeline).

3. KalendÃ¡Å™ (`/calendar`)
   - Klik na revizi vede na `Detail revize` (ne pouze seznam).
   - V detail panelu CTA: "OtevÅ™Ã­t v plÃ¡novaÄi" + "Domluvit" (pokud nemÃ¡ termÃ­n).
   - PÅ™epÃ­naÄ TermÃ­ny/NaplÃ¡novanÃ© zachovat, ale doplnit legendu pro stav workflow.

4. PlÃ¡novaÄ (`/planner`)
   - V seznamu "NaplÃ¡novanÃ©" zobrazit jmÃ©no zÃ¡kaznÃ­ka + adresu + ÄasovÃ© okno.
   - Klik na poloÅ¾ku â†’ detail revize (nebo side panel).
   - TlaÄÃ­tko "PÅ™idat z fronty" (kontextovÃ½ filtr na datum).

5. Detail revize (novÃ½ cÃ­lovÃ½ kontext)
   - CentrÃ¡lnÃ­ hub: status, termÃ­n, poznÃ¡mky, akce podle stavu.
   - Odkazy: zÃ¡kaznÃ­k, komunikace, nÃ¡vÅ¡tÄ›vy, plÃ¡n dne.

#### Detail revize - struktura strÃ¡nky (workflow hub)

**CÃ­l:** Jeden pohled pro vÅ¡echny kroky workflow. UÅ¾ivatel vidÃ­ kontext + dalÅ¡Ã­ akci bez hledÃ¡nÃ­.

**1) Sticky header**
- NÃ¡zev: `Revize - [typ zaÅ™Ã­zenÃ­]`
- Status badge: `ÄŒekÃ¡ na kontakt / Domluveno / NaplÃ¡novÃ¡no / Hotovo / ZruÅ¡eno`
- KlÃ­ÄovÃ© info: `TermÃ­n`, `ÄŒasovÃ© okno`, `DÃ©lka`, `Technik/posÃ¡dka`
- PrimÃ¡rnÃ­ CTA (context-aware):
  - ÄŒekÃ¡ na kontakt â†’ `Domluvit termÃ­n`
  - Domluveno â†’ `OtevÅ™Ã­t v plÃ¡novaÄi (den)`
  - NaplÃ¡novÃ¡no â†’ `OtevÅ™Ã­t v plÃ¡novaÄi (den)`
  - Hotovo â†’ `Zobrazit vÃ½sledek`
- SekundÃ¡rnÃ­ akce (menu): `PÅ™eplÃ¡novat`, `OdloÅ¾it`, `ZruÅ¡it`

**2) Kontekt zÃ¡kaznÃ­ka (card)**
- JmÃ©no, adresa, poznÃ¡mka
- Kontakty: `ğŸ“ Zavolat`, `âœ‰ï¸ Email`
- CTA: `OtevÅ™Ã­t zÃ¡kaznÃ­ka`
- Mini mapa (pokud existuje)

**3) Detail revize (card)**
- ZaÅ™Ã­zenÃ­: typ, nÃ¡zev, interval, poslednÃ­ revize
- TermÃ­n: datum + ÄasovÃ© okno + dÃ©lka
- PÅ™iÅ™azenÃ­: technik/posÃ¡dka/depo (pokud existuje)
- CTA: `OtevÅ™Ã­t zaÅ™Ã­zenÃ­`

**4) Workflow panel (pravÃ½ sloupec / side panel)**
- KontextovÃ© akce dle stavu:
  - ÄŒekÃ¡ na kontakt: `Domluvit`, `OdloÅ¾it`, `Zavolat`
  - Domluveno: `PÅ™eplÃ¡novat`, `OtevÅ™Ã­t v plÃ¡novaÄi`, `ZruÅ¡it`
  - NaplÃ¡novÃ¡no: `OtevÅ™Ã­t v plÃ¡novaÄi`, `PÅ™esun v trase` (pokud existuje)
  - Hotovo: `Zobrazit vÃ½sledek`, `VytvoÅ™it dalÅ¡Ã­ revizi` (pokud se dÄ›lÃ¡ ruÄnÄ›)
- Text "DalÅ¡Ã­ krok": napÅ™. `DalÅ¡Ã­ krok: naplÃ¡novat den`

**5) Historie a komunikace (timeline)**
- Komunikace (hovory, emaily, poznÃ¡mky)
- NÃ¡vÅ¡tÄ›vy (visit log)
- RychlÃ© pÅ™idÃ¡nÃ­ komunikace

**6) Operativa (volitelnÃ©)**
- `Tisk / PDF / Export`
- `Navigovat` (single-stop, pro technika)

#### Detail revize - wireframe (ASCII)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Revize - Plynovy kotel          [STATUS: DOMLUVENO]   [Domluvit termÃ­n]    â”‚
â”‚ TermÃ­n: 30.01.2026  |  Okno: 10:00-11:00  |  DÃ©lka: 45 min  |  Technik: A  â”‚
â”‚ [PÅ™eplÃ¡novat] [OdloÅ¾it] [ZruÅ¡it]                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ZAKAZNIK                                  â”‚  â”‚ WORKFLOW                     â”‚
â”‚ Jan Novak                                 â”‚  â”‚ DalÅ¡Ã­ krok: naplÃ¡novat den   â”‚
â”‚ Lesni 123, Brno                           â”‚  â”‚                             â”‚
â”‚ Pozn.: Parkovat za domem                  â”‚  â”‚ [OtevÅ™Ã­t v plÃ¡novaÄi (den)]  â”‚
â”‚ [ğŸ“ Zavolat] [âœ‰ï¸ Email] [Detail zÃ¡kaznÃ­ka]â”‚  â”‚ [PÅ™eplÃ¡novat] [ZruÅ¡it]        â”‚
â”‚ [Mini mapa]                               â”‚  â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REVIZE                                    â”‚  â”‚ HISTORIE / KOMUNIKACE        â”‚
â”‚ ZaÅ™Ã­zenÃ­: Kotel ABC-123                   â”‚  â”‚ - 20.01: VolÃ¡no, nezastiÅ¾en  â”‚
â”‚ Interval: 12 mÄ›sÃ­cÅ¯                       â”‚  â”‚ - 25.01: Email o termÃ­nu     â”‚
â”‚ PoslednÃ­ revize: 15.01.2026               â”‚  â”‚ [PÅ™idat zÃ¡znam]               â”‚
â”‚ [Detail zaÅ™Ã­zenÃ­]                         â”‚  â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

6. ~~MÅ¯j den (`/today`)~~ â†’ **SLOUÄŒENO DO PLÃN DNE (`/planner`)**
   - `/today` nynÃ­ pÅ™esmÄ›rovÃ¡vÃ¡ na `/planner`
   - VÅ¡echny funkce (navigace, volÃ¡nÃ­, hotovo) jsou v PlÃ¡n dne

### MinimÃ¡lnÃ­ integraÄnÃ­ checklist âœ… COMPLETE
- [x] ZavÃ©st `Detail revize` jako primÃ¡rnÃ­ uzel workflow âœ…
- [x] PÅ™idat prokliky mezi Fronta â†’ Detail â†’ PlÃ¡n dne âœ…
- [x] VÅ¡echny seznamy revizÃ­ zobrazujÃ­ zÃ¡kaznÃ­ka a akci âœ…
- [x] Dashboard a KalendÃ¡Å™ majÃ­ pÅ™Ã­mÃ½ vstup do fronty/planovÃ¡nÃ­ âœ…
- [x] Po naplÃ¡novÃ¡nÃ­ automatickÃ½ nÃ¡vrat do kontextu (plÃ¡n dne) âœ…
- [x] SlouÄit PlÃ¡novÃ¡nÃ­ + MÅ¯j den do jednÃ© strÃ¡nky "PlÃ¡n dne" âœ…

### Tvorba dennÃ­ trasy z PlÃ¡novacÃ­ho inboxu

**CÃ­l:** UÅ¾ivatel vytvÃ¡Å™Ã­ dennÃ­ trasu pÅ™Ã­mo na strÃ¡nce Fronta (PlÃ¡novacÃ­ inbox), aniÅ¾ by musel pÅ™echÃ¡zet na strÃ¡nku PlÃ¡n dne. VybÃ­rÃ¡ zÃ¡kaznÃ­ky ze seznamu, pÅ™idÃ¡vÃ¡ je do trasy, optimalizuje a uklÃ¡dÃ¡ â€” vÅ¡e na jednÃ© obrazovce.

**StrÃ¡nka:** `/queue` â€” PlÃ¡novacÃ­ inbox (tÅ™Ã­sloupcovÃ½ layout)

#### Workflow tvorby trasy

1. UÅ¾ivatel vybere datum, posÃ¡dku a depo v header baru
2. UÅ¾ivatel prochÃ¡zÃ­ seznam kandidÃ¡tÅ¯ (levÃ½ panel)
3. KandidÃ¡ty pÅ™idÃ¡vÃ¡ do trasy buÄ:
   - JednotlivÄ›: klik na kandidÃ¡ta â†’ detail (pravÃ½ panel) â†’ tlaÄÃ­tko "PÅ™idat do trasy"
   - HromadnÄ›: zaÅ¡krtne checkboxy â†’ tlaÄÃ­tko "PÅ™idat vybranÃ© do trasy"
4. PÅ™idanÃ­ kandidÃ¡ti se zobrazÃ­ ve stÅ™ednÃ­m panelu pod mapou jako seznam zastÃ¡vek
5. Mapa prÅ¯bÄ›Å¾nÄ› zobrazuje zastÃ¡vky a propojenÃ­
6. UÅ¾ivatel klikne "Optimalizovat trasu" â†’ VRP solver pÅ™epoÄÃ­tÃ¡ poÅ™adÃ­ a Äasy
7. Trasa se **automaticky uklÃ¡dÃ¡** prÅ¯bÄ›Å¾nÄ› (auto-save s debounce 1,5 s) â€” uÅ¾ivatel nemusÃ­ nic uklÃ¡dat ruÄnÄ›

#### LevÃ½ panel â€” Seznam kandidÃ¡tÅ¯

- U kaÅ¾dÃ©ho kandidÃ¡ta je checkbox pro hromadnÃ½ vÃ½bÄ›r
- KandidÃ¡ti, kteÅ™Ã­ jsou jiÅ¾ v trase, majÃ­ vizuÃ¡lnÃ­ oznaÄenÃ­ (barevnÃ½ prouÅ¾ek vlevo)
- Pod segmentovÃ½mi zÃ¡loÅ¾kami je tlaÄÃ­tko "PÅ™idat vybranÃ© do trasy" (aktivnÃ­, kdyÅ¾ jsou zaÅ¡krtnutÃ© checkboxy)
- KlÃ¡vesovÃ¡ zkratka `A` â€” pÅ™idat aktuÃ¡lnÄ› vybranÃ©ho kandidÃ¡ta do trasy

#### StÅ™ednÃ­ panel â€” Mapa + ZastÃ¡vky v trase

- HornÃ­ ÄÃ¡st: mapa se zastÃ¡vkami a trasou
- SpodnÃ­ ÄÃ¡st: kompaktnÃ­ seznam zastÃ¡vek v trase:
  - PoÅ™adovÃ© ÄÃ­slo, jmÃ©no zÃ¡kaznÃ­ka, adresa, ETAâ€“ETD, tlaÄÃ­tko âœ• (odebrat)
  - SouhrnnÃ© metriky: vzdÃ¡lenost, Äas, poÄet zastÃ¡vek, zatÃ­Å¾enÃ­ dne (%)
- AkÄnÃ­ tlaÄÃ­tka: Optimalizovat trasu, VyÄistit
- **Auto-save:** Trasa se automaticky uklÃ¡dÃ¡ 1,5 s po poslednÃ­ zmÄ›nÄ› (pÅ™idÃ¡nÃ­, odebrÃ¡nÃ­, optimalizace). Status bar v hlaviÄce ukazuje:
  - `â— NeuloÅ¾enÃ© zmÄ›ny` â€” zmÄ›na ÄekÃ¡ na uloÅ¾enÃ­ (debounce)
  - `âŸ³ UklÃ¡dÃ¡m...` â€” probÃ­hÃ¡ uklÃ¡dÃ¡nÃ­
  - `âœ“ UloÅ¾eno prÃ¡vÄ› teÄ / pÅ™ed N min` â€” ÃºspÄ›Å¡nÄ› uloÅ¾eno
  - `âš ï¸ NepodaÅ™ilo se uloÅ¾it [Zkusit znovu]` â€” chyba s moÅ¾nostÃ­ retry
- PrÃ¡zdnÃ½ stav: "ZatÃ­m Å¾Ã¡dnÃ© zastÃ¡vky v trase. Vyberte kandidÃ¡ty ze seznamu."

#### PravÃ½ panel â€” Detail kandidÃ¡ta

- Pod slot suggestions pÅ™idÃ¡no tlaÄÃ­tko "PÅ™idat do trasy"
- Pokud je kandidÃ¡t jiÅ¾ v trase, mÃ­sto "PÅ™idat" se zobrazÃ­ "Odebrat z trasy"
- KlÃ¡vesovÃ¡ zkratka `R` â€” odebrat aktuÃ¡lnÄ› vybranÃ©ho z trasy

#### Wireframe

```
PLÃNOVACÃ INBOX â€” TVORBA TRASY
=============================================================================
Den: 07.02.2026  PosÃ¡dka: Petr  Depo: Brno-stÅ™ed  [Route-aware: ON]
=============================================================================

KANDIDÃTI (levÃ½ panel)        MAPA + TRASA (stÅ™ed)         DETAIL (pravÃ½)
+---------------------------+ +------------------------+ +------------------+
| [x] Po termÃ­nu  TÃ½den ... | |                        | | Jan NovÃ¡k        |
|                           | |    [MAPA S TRASOU]      | | Kotel 45min      |
| [ ] Karel S.  Brno  +2min | |    1â”€â”€2â”€â”€3â”€â”€Depo        | | LesnÃ­ 123, Brno  |
| [x] Marie D.  Brno  +5min | |                        | |                  |
| [ ] Petr ÄŒ.   Blank +8min | +------------------------+ | Slot suggestions:|
| [x] Jana N.   VyÅ¡k +12min | | ZASTÃVKY V TRASE (3)   | | 09:15 +2min  OK  |
| â–Œ  Anna K. (v trase)      | | 1. Karel S. 08:30-09:15| | 10:45 +5min  OK  |
|                           | | 2. Anna K.  09:45-10:15| | 14:00 +8min Tight|
| [PÅ™idat vybranÃ© do trasy] | | 3. JiÅ™Ã­ M.  10:45-11:30| |                  |
|                           | |                    [âœ•]  | | [PÅ˜IDAT DO TRASY]|
|                           | | VzdÃ¡l: 45km  ÄŒas: 3h   | | [OdloÅ¾it]        |
|                           | | ZatÃ­Å¾enÃ­: 62%           | | [Detail zÃ¡kaznÃ­ka]|
|                           | |                        | |                  |
|                           | | [Optimalizovat][VyÄistit]| | kbd: A pÅ™idat    |
|                           | | âœ“ UloÅ¾eno prÃ¡vÄ› teÄ     | |      R odebrat   |
+---------------------------+ +------------------------+ +------------------+
```

#### KlÃ¡vesovÃ© zkratky (rozÅ¡Ã­Å™enÃ­)

| KlÃ¡vesa | Akce |
|---------|------|
| `A` | PÅ™idat vybranÃ©ho kandidÃ¡ta do trasy (best slot) |
| `R` | Odebrat vybranÃ©ho kandidÃ¡ta z trasy |
| `Shift+A` | PÅ™idat vÅ¡echny zaÅ¡krtnutÃ© do trasy |

---

## RozhodnutÃ­ a mapovÃ¡nÃ­ na existujÃ­cÃ­ model

### 1. Entity mapping (ROZHODNUTO)

| NavrÅ¾enÃ¡ entita | ExistujÃ­cÃ­ entita | PoznÃ¡mka |
|-----------------|-------------------|----------|
| Asset | `Device` | âœ… PÅ™Ã­mÃ© mapovÃ¡nÃ­ |
| ServiceCycle | Logika v `Device` + `Revision` | NenÃ­ potÅ™eba novÃ¡ tabulka |
| Job | `Revision` | âœ… Revision = co je potÅ™eba udÄ›lat |
| Appointment | `Revision` | âœ… Revision = kdy se to mÃ¡ udÄ›lat |
| Visit | `Visit` | âœ… HistorickÃ½ zÃ¡znam provedenÃ­ |

**KlÃ­ÄovÃ© rozhodnutÃ­:** NezavÃ¡dÄ›t novÃ© entity Job/Appointment. `Revision` pokrÃ½vÃ¡ obojÃ­:
- `scheduled_date IS NULL` â†’ backlog / ÄekÃ¡ na kontakt
- `scheduled_date IS NOT NULL` â†’ appointment / domluveno

### 2. Stavy revize (ROZHODNUTO)

**Zachovat existujÃ­cÃ­ enum, pÅ™idat odvozenÃ© stavy logikou:**

| UX stav | MapovÃ¡nÃ­ | Implementace |
|---------|----------|--------------|
| PlÃ¡novanÃ¡ (dÅ™Ã­ve NadchÃ¡zejÃ­cÃ­) | `upcoming` | `status='upcoming' AND scheduled_date IS NULL` |
| Domluveno | `scheduled` | `status='scheduled'` (mÃ¡ termÃ­n, nepotvrzeno) |
| Potvrzeno | `confirmed` | `status='confirmed'` |
| NaplÃ¡novÃ¡no v trase | `confirmed` | + `route_order IS NOT NULL` |
| DokonÄeno | `completed` | `status='completed'` - **pouze dokonÄenÃ© revize zaklÃ¡dajÃ­ vÃ½poÄet "po termÃ­nu"** |
| OdloÅ¾eno | `upcoming` | + novÃ© pole `snooze_until` |
| ZruÅ¡eno | `cancelled` | `status='cancelled'` |

> **ZmÄ›na v0.16.0:** Stav "NadchÃ¡zejÃ­cÃ­" pÅ™ejmenovÃ¡n na "PlÃ¡novanÃ¡" (lÃ©pe vystihuje vÃ½znam).
> Pouze dokonÄenÃ© revize (`status='completed'`) se pouÅ¾Ã­vajÃ­ pro vÃ½poÄet zpoÅ¾dÄ›nÃ­.
> ZpoÅ¾dÄ›nÃ­ = (last_completed_at + interval_months) < today.
> Pro zaÅ™Ã­zenÃ­ bez provedenÃ© revize se pouÅ¾ije installation_date jako zÃ¡klad.

**NovÃ¡ pole pro Revision (schema change):**
```sql
ALTER TABLE revisions ADD COLUMN snooze_until DATE;
ALTER TABLE revisions ADD COLUMN snooze_reason VARCHAR(255);
ALTER TABLE revisions ADD COLUMN assigned_crew_id UUID REFERENCES crews(id);
ALTER TABLE revisions ADD COLUMN route_order INTEGER;
```

### 3. Algoritmus nabÃ­dky slotÅ¯ (ROZHODNUTO)

**Insertion Heuristic s Valhalla cache:**

```
1. Pro zvolenÃ½ den + posÃ¡dku naÄti existujÃ­cÃ­ trasu:
   Depot â†’ A â†’ B â†’ C â†’ Depot

2. Pro novÃ©ho zÃ¡kaznÃ­ka X zkus vloÅ¾it mezi kaÅ¾dou dvojici:
   - mezi Depot/A, A/B, B/C, C/Depot

3. SpoÄÃ­tej delta travel time:
   Î” = t(A,X) + t(X,B) - t(A,B)

4. Simuluj forward pass pro feasibility:
   - arrival/departure times
   - ovÄ›Å™ ÄasovÃ¡ okna (hard constraint)

5. SkÃ³re kandidÃ¡ta:
   - 60% Î” travel time (niÅ¾Å¡Ã­ = lepÅ¡Ã­)
   - 25% slack (vÃ­ce = lepÅ¡Ã­)
   - 15% area coherence (volitelnÃ©)

6. Vyber top 3-5 slotÅ¯, diverzifikuj Äasy
```

**VÃ½kon s Valhalla:**
- Cache travel times mezi existujÃ­cÃ­mi body dne
- Pro novÃ½ bod X dopoÄÃ­tat pouze: `t(X, vÅ¡ichni)` a `t(vÅ¡ichni, X)`

### 4. Multi-crew a multi-depot (ROZHODNUTO)

**MVP:**
- `Crew.home_depot_id` = default start/end
- `Crew.preferred_area` = seznam PSÄŒ prefixÅ¯ / okresÅ¯
- RuÄnÃ­ pÅ™iÅ™azenÃ­ + jednoduchÃ© regiony
- UI: zobrazit "Day load" per posÃ¡dka

**V2:**
- Clustering zakÃ¡zek do N clusterÅ¯ (N = poÄet posÃ¡dek)
- Auto-balance load mezi posÃ¡dkami
- `RoutePlan.start_depot_id`, `RoutePlan.end_depot_id` pro pÅ™epsÃ¡nÃ­

### 5. Export Google Maps (ROZHODNUTO)

**Segmentace trasy:**
- RozdÄ›lit na segmenty po 8-10 zastÃ¡vkÃ¡ch
- Generovat 2-5 odkazÅ¯: "Trasa 1/4", "Trasa 2/4"...
- KaÅ¾dÃ½ odkaz otevÅ™e Google Maps s ÄÃ¡stÃ­ dne

**Fallback:**
- PDF / tisk (seznam adres + tel + okna)
- KML/GPX export pro jinÃ© navigace
- "Navigovat" tlaÄÃ­tko per zastÃ¡vka (jednobodovÄ›, bez limitÅ¯)

---

## MVP ImplementaÄnÃ­ plÃ¡n

### FÃ¡ze 1: ZÃ¡kladnÃ­ infrastruktura (1-2 tÃ½dny)

**DB zmÄ›ny:**
```sql
-- RozÅ¡Ã­Å™enÃ­ revisions
ALTER TABLE revisions ADD COLUMN snooze_until DATE;
ALTER TABLE revisions ADD COLUMN snooze_reason VARCHAR(255);
ALTER TABLE revisions ADD COLUMN assigned_crew_id UUID;
ALTER TABLE revisions ADD COLUMN route_order INTEGER;

-- NovÃ¡ tabulka crews (pokud neexistuje)
CREATE TABLE crews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  name VARCHAR(100) NOT NULL,
  home_depot_id UUID REFERENCES depots(id),
  preferred_areas TEXT[], -- PSÄŒ prefixy
  working_hours_start TIME DEFAULT '08:00',
  working_hours_end TIME DEFAULT '17:00',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Backend:**
- [ ] Migration pro novÃ¡ pole
- [ ] CRUD pro Crew entity
- [ ] Endpoint: `revision.queue` - fronta k obvolÃ¡nÃ­

### FÃ¡ze 2: Fronta k obvolÃ¡nÃ­ (1 tÃ½den)

**Endpoint:** `GET /api/revisions/queue`
```typescript
interface QueueFilters {
  status: 'overdue' | 'due_soon' | 'upcoming';
  area?: string;      // PSÄŒ prefix
  deviceType?: string;
  crewId?: string;
}

interface QueueItem {
  revision: Revision;
  customer: Customer;
  device: Device;
  daysUntilDue: number;
  lastContactAt?: Date;
  contactAttempts: number;
}
```

**UI komponenty:**
- [ ] `CallQueue` - seznam s filtry
- [ ] `QueueItem` - karta zÃ¡kaznÃ­ka
- [ ] Quick actions: Zavolat, OdloÅ¾it, Domluvit

### FÃ¡ze 3: Domluva revize (1-2 tÃ½dny)

**Endpoint:** `POST /api/revisions/{id}/schedule`
```typescript
interface ScheduleRequest {
  scheduledDate: string;
  timeWindowStart: string;
  timeWindowEnd: string;
  serviceDuration: number;
  crewId?: string;
  notes?: string;
}
```

**UI komponenty:**
- [ ] `ScheduleRevisionDialog` - modal pro domluvu
- [ ] KalendÃ¡Å™ s poÄtem volnÃ½ch slotÅ¯ per den
- [ ] Seznam ÄasovÃ½ch oken (zatÃ­m bez smart slotÅ¯)

### FÃ¡ze 4: PlÃ¡n dne - zÃ¡kladnÃ­ (1-2 tÃ½dny)

**Endpoint:** `GET /api/routes/{date}/{crewId}`
```typescript
interface DayPlan {
  date: string;
  crew: Crew;
  stops: PlannedStop[];
  totalDistance: number;
  totalDuration: number;
  warnings: RouteWarning[];
}
```

**UI komponenty:**
- [ ] `DayPlanner` - dispeÄerskÃ½ pohled
- [ ] Drag & drop poÅ™adÃ­ zastÃ¡vek
- [ ] Mapa s trasou (existujÃ­cÃ­)
- [ ] ZÃ¡kladnÃ­ varovÃ¡nÃ­ konfliktÅ¯

### FÃ¡ze 5: MÅ¯j dneÅ¡nÃ­ plÃ¡n (1 tÃ½den)

**UI komponenty:**
- [ ] `TechnicianDayView` - mobilnÃ­-friendly seznam
- [ ] Per-stop akce: Navigovat, Volat, Hotovo, NezastiÅ¾en
- [ ] Export: segmentovanÃ© Google Maps linky
- [ ] PDF export

### FÃ¡ze 6 (V2): Smart sloty (2-3 tÃ½dny)

**Backend:**
- [ ] Insertion heuristic algoritmus
- [ ] Valhalla matrix cache per den/posÃ¡dka
- [ ] Endpoint: `GET /api/slots/suggest`

**UI:**
- [ ] ZobrazenÃ­ doporuÄenÃ½ch slotÅ¯ v `ScheduleRevisionDialog`
- [ ] Vizualizace dopadu na trasu (+X min)

---

## API Endpointy (pÅ™ehled)

| Endpoint | Metoda | Popis |
|----------|--------|-------|
| `/api/revisions/queue` | GET | Fronta k obvolÃ¡nÃ­ |
| `/api/revisions/{id}/schedule` | POST | Domluvit termÃ­n |
| `/api/revisions/{id}/snooze` | POST | OdloÅ¾it revizi |
| `/api/crews` | CRUD | SprÃ¡va posÃ¡dek |
| `/api/routes/{date}` | GET | PlÃ¡n dne (vÅ¡echny posÃ¡dky) |
| `/api/routes/{date}/{crewId}` | GET | PlÃ¡n dne (konkrÃ©tnÃ­ posÃ¡dka) |
| `/api/routes/{date}/{crewId}/reorder` | POST | ZmÄ›na poÅ™adÃ­ |
| `/api/routes/{date}/{crewId}/optimize` | POST | Re-optimalizace |
| `/api/slots/suggest` | POST | DoporuÄenÃ© sloty (V2) |
| `/api/export/googlemaps/{date}/{crewId}` | GET | Google Maps linky |
| `/api/export/pdf/{date}/{crewId}` | GET | PDF export |

---

## ShrnutÃ­ klÃ­ÄovÃ½ch rozhodnutÃ­

| Oblast | RozhodnutÃ­ |
|--------|------------|
| Entity | NezavÃ¡dÄ›t Job/Appointment, `Revision` je obojÃ­ |
| Stavy | Zachovat enum, â€ÄekÃ¡ na kontakt" = derived, â€odloÅ¾eno" = snooze_until |
| Sloty | Insertion heuristic + Valhalla cache (V2) |
| Multi-crew | MVP = ruÄnÃ­ + PSÄŒ regiony, V2 = clustering |
| Export | SegmentovanÃ© Google Maps (8-10 bodÅ¯) + PDF |
| MVP poÅ™adÃ­ | Queue â†’ Schedule â†’ DayPlan â†’ TechView |

---

## DalÅ¡Ã­ kroky

1. [x] ~~ZÃ­skat odpovÄ›di na otevÅ™enÃ© otÃ¡zky~~
2. [x] ~~Namapovat na existujÃ­cÃ­ datovÃ½ model~~
3. [ ] SchvÃ¡lit implementaÄnÃ­ plÃ¡n
4. [ ] DB migrace pro novÃ¡ pole
5. [ ] Implementace FÃ¡ze 1-5 (MVP)
6. [ ] TestovÃ¡nÃ­ s reÃ¡lnÃ½mi daty
7. [ ] Implementace FÃ¡ze 6 (Smart sloty)

---

## Jobs Dashboard (Phase 7D)

> **Status:** Partially implemented (Phase 7D core in `/jobs`)
> **UmÃ­stÄ›nÃ­:** `/admin/jobs` (souÄÃ¡st Admin sekce)

### ÃšÄel

CentralizovanÃ½ monitoring vÅ¡ech asynchronnÃ­ch Ãºloh zpracovÃ¡vanÃ½ch pÅ™es JetStream:
- Geocoding (Nominatim)
- Routing (Valhalla)
- Importy/Exporty
- Email/SMS (budoucÃ­)
- Exporty lze z historie stahovat pÅ™Ã­mo tlaÄÃ­tkem `StÃ¡hnout export` u dokonÄenÃ½ch export jobÅ¯

### Wireframe

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SAZINKA              ZÃ¡kaznÃ­ci  PlÃ¡n dne  KalendÃ¡Å™  Fronta  Admin         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€ Jobs Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚ Ve frontÄ›   â”‚ â”‚ ZpracovÃ¡nÃ­  â”‚ â”‚ DokonÄeno   â”‚ â”‚ Selhalo     â”‚      â”‚ â”‚
â”‚  â”‚  â”‚     12      â”‚ â”‚      3      â”‚ â”‚    1,247    â”‚ â”‚      5      â”‚      â”‚ â”‚
â”‚  â”‚  â”‚   â—‹ â—‹ â—‹     â”‚ â”‚   â— â— â—     â”‚ â”‚   âœ“ âœ“ âœ“     â”‚ â”‚   âœ— âœ—       â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€ AktivnÃ­ Ãºlohy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ”„ Valhalla Matrix                                    3s ago â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ ID: job-abc123                                               â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 60%  Calculating distances...          â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                              [ZruÅ¡it]        â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ“ Geocoding Batch                                   15s ago â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ ID: job-def456                                               â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 85%  Geocoding customer 42/50...       â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                              [ZruÅ¡it]        â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ“¥ Import CSV                                        1m ago  â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ ID: job-ghi789                                               â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%  Processing row 200/500...         â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                              [ZruÅ¡it]        â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€ NedÃ¡vno dokonÄenÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ âœ“ Geocoding Batch                              2m ago  2.3s â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   25 customers geocoded, 2 failed                           â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ âœ“ Valhalla Geometry                            5m ago  1.1s â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   Route for 12 stops calculated                             â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€ SelhanÃ© Ãºlohy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ âœ— Valhalla Matrix                             10m ago        â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   Error: Connection timeout after 30s                        â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   Retries: 3/3                                               â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                    [Opakovat]  [Zahodit]     â”‚  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DatovÃ© typy

```typescript
interface JobSummary {
  id: string;
  type: 'geocode' | 'geocode_address' | 'geocode_reverse' | 
        'valhalla_matrix' | 'valhalla_geometry' |
        'import' | 'export' | 'email' | 'sms';
  status: 'queued' | 'processing' | 'completed' | 'failed';
  progress?: number;        // 0-100
  message?: string;         // Current status message
  submittedAt: string;      // ISO timestamp
  startedAt?: string;
  completedAt?: string;
  durationMs?: number;
  error?: string;
  retryCount: number;
  maxRetries: number;
}

interface JobsDashboardStats {
  queued: number;
  processing: number;
  completed: number;
  failed: number;
}
```

### NATS Subjects

| Subject | Popis |
|---------|-------|
| `sazinka.admin.jobs.list` | Seznam aktivnÃ­ch Ãºloh |
| `sazinka.admin.jobs.stats` | Statistiky front |
| `sazinka.admin.jobs.cancel` | ZruÅ¡enÃ­ Ãºlohy |
| `sazinka.admin.jobs.retry` | OpakovÃ¡nÃ­ selhanÃ© Ãºlohy |

### UI komponenty

- [ ] `JobsDashboard` - hlavnÃ­ strÃ¡nka
- [ ] `JobStatsCards` - 4 karty se statistikami
- [ ] `ActiveJobsList` - seznam aktivnÃ­ch Ãºloh
- [ ] `CompletedJobsList` - nedÃ¡vno dokonÄenÃ©
- [ ] `FailedJobsList` - selhanÃ© Ãºlohy s akcemi
- [ ] `JobProgressBar` - progress bar s procentem
- [ ] `JobTypeIcon` - ikona podle typu Ãºlohy

### Integrace s existujÃ­cÃ­m Admin UI

Jobs Dashboard bude novÃ¡ zÃ¡loÅ¾ka v Admin sekci:

```
Admin
â”œâ”€â”€ PÅ™ehled (stÃ¡vajÃ­cÃ­)
â”œâ”€â”€ Export dat (stÃ¡vajÃ­cÃ­)
â”œâ”€â”€ Jobs Dashboard (novÃ©) â† Phase 7D
â””â”€â”€ NastavenÃ­ (stÃ¡vajÃ­cÃ­)
```

---

---

## Phase 8: GA Redesign - Route-Aware Planning

> **Status:** Planning phase  
> **Verze:** 1.0  
> **Datum:** 2026-02-02

### KlÃ­ÄovÃ½ koncept

**HlavnÃ­ zmÄ›na:** "Domluvit nÃ¡vÅ¡tÄ›vu" jiÅ¾ nenÃ­ oddÄ›lenÃ© od plÃ¡novÃ¡nÃ­ trasy - je to **jedna Äinnost**: vloÅ¾it zakÃ¡zku do dennÃ­ trasy s minimem Î”km/Î”min a s ohledem na ÄasovÃ¡ okna.

---

### 1. Persony

#### 1.1 DispeÄerka (primÃ¡rnÄ› desktop)

**Kontext:** PC, telefon, Äasto pÅ™epÃ­nÃ¡ mezi hovorem, mapou, seznamem a plÃ¡nem dne.

**CÃ­l:** Domluvit termÃ­ny a prÅ¯bÄ›Å¾nÄ› sklÃ¡dat dennÃ­ trasy pro 1â€“N posÃ¡dek tak, aby byl minimÃ¡lnÃ­ Äas/kilometry a pÅ™itom byla splnÄ›na okna a kapacita dne.

**KlÃ­ÄovÃ© potÅ™eby:**
- Rychle vidÄ›t kdo je na Å™adÄ› a proÄ (due, priorita)
- PÅ™i domluvÄ› hned vidÄ›t dopad na trasu: Î”km / Î”min a konflikty
- VidÄ›t kapacitu dne (vytÃ­Å¾enÃ­, rezerva/slack) a varovÃ¡nÃ­ "den je plnÃ½"
- Å˜eÅ¡it vÃ½jimky v mÃ­stÄ› (nelze geokÃ³dovat, chybÃ­ tel, zÃ¡kaznÃ­k chce zavolat pozdÄ›ji)
- Minimum scrollu, maximum informaÄnÃ­ hustoty, klÃ¡vesovÃ© zkratky

**TypickÃ© chovÃ¡nÃ­:**
- Vybere den + posÃ¡dku + depo â†’ vybÃ­rÃ¡ zÃ¡kaznÃ­ky z inboxu tak, aby "sedÄ›li" do trasy
- V hovoru nabÃ­dne 3 nejlepÅ¡Ã­ sloty, ne celÃ½ kalendÃ¡Å™
- KdyÅ¾ nÄ›co "nesedÃ­", odloÅ¾Ã­ nebo pÅ™ehodÃ­ na jinÃ½ den/posÃ¡dku

#### 1.2 Å˜emeslnÃ­k (primÃ¡rnÄ› mobil)

**Kontext:** MobilnÃ­ web, Äasto venku; potÅ™ebuje rychle navigovat, volat, vidÄ›t poznÃ¡mky a uzavÅ™Ã­t zakÃ¡zku.

**CÃ­l:** ProvÃ©st nÃ¡vÅ¡tÄ›vy, minimalizovat zmatky, mÃ­t vÅ¡echny informace dostupnÃ© (kontakt, adresa, poznÃ¡mky, zaÅ™Ã­zenÃ­, historie), rychle zaznamenat vÃ½sledek.

**KlÃ­ÄovÃ© potÅ™eby:**
- DneÅ¡nÃ­ plÃ¡n: poÅ™adÃ­, okna, Äas dojezdu, navigace
- Jedno kliknutÃ­: Navigovat, Volat, Na mÃ­stÄ›, Hotovo
- PoznÃ¡mky typu "parkovÃ¡nÃ­ / klÃ­Äe / pÅ™Ã­stup" zvÃ½raznÄ›nÃ©
- I bez mobilnÃ­ aplikace: export (odkaz/Google Maps) a offline-ish "tisk/PDF"

---

### 2. NÃ¡zvoslovÃ­ (sjednocenÃ­)

| UI termÃ­n | Popis | MapovÃ¡nÃ­ na DB |
|-----------|-------|----------------|
| **ZÃ¡kaznÃ­k** | Osoba nebo firma | `Customer` |
| **ZaÅ™Ã­zenÃ­** | Kotel, komÃ­n, plynovÃ½ spotÅ™ebiÄ | `Device` |
| **ZakÃ¡zka** | Co se mÃ¡ udÄ›lat (revize/servis/ÄiÅ¡tÄ›nÃ­) | `Revision` |
| **NÃ¡vÅ¡tÄ›va** | DomluvenÃ© datum + ÄasovÃ© okno + dÃ©lka + posÃ¡dka | `Visit` |
| **PlÃ¡n dne** | KonkrÃ©tnÃ­ trasa pro den a posÃ¡dku (sekvence nÃ¡vÅ¡tÄ›v + metriky) | `PlannedRoute` |
| **PlÃ¡novacÃ­ inbox** | Seznam zakÃ¡zek k domluvenÃ­/vloÅ¾enÃ­ do trasy | Query over `Revision` |

---

### 3. StavovÃ© signÃ¡ly (konzistentnÃ­ napÅ™Ã­Ä aplikacÃ­)

#### 3.1 Stav adresy

| Stav | Ikona | Popis |
|------|-------|-------|
| OvÄ›Å™eno | âœ… | MÃ¡ geo a proÅ¡la validacÃ­ |
| ÄŒekÃ¡ na ovÄ›Å™enÃ­ | â³ | GeokÃ³dovÃ¡nÃ­ pending |
| Nelze lokalizovat | âš  | GeokÃ³d selhal |
| Bez adresy | â›” | Nelze optimalizovat |

#### 3.2 Stav vloÅ¾enÃ­ slotu do trasy

| Stav | Ikona | PodmÃ­nky |
|------|-------|----------|
| OK | âœ… | Bez konfliktu, vytÃ­Å¾enÃ­ â‰¤90%, slack â‰¥20 min |
| TÄ›snÃ© | âš  | VytÃ­Å¾enÃ­ 90â€“100% nebo slack 10â€“20 min |
| Konflikt | âŒ | PoruÅ¡enÃ­ okna nebo vytÃ­Å¾enÃ­ >100% |

#### 3.3 Kapacita dne

| Stav | Ikona | PodmÃ­nky |
|------|-------|----------|
| V pohodÄ› | âœ… | load <80%, slack >30 min |
| TÄ›snÃ½ | âš  | load 80â€“95% nebo slack 15â€“30 min |
| PÅ™etÃ­Å¾enÃ½ | âŒ | load >95% nebo slack <15 min |

---

### 4. Design principy pro GA

#### 4.1 TÅ™i zÃ¡sadnÃ­ UX pravidla

1. **Route-aware vÅ¡ude tam, kde se domlouvÃ¡ termÃ­n**
   - "Domluvit" vÅ¾dy ukazuje dopad na trasu

2. **VÃ½jimky Å™eÅ¡itelnÃ© pÅ™Ã­mo v mÃ­stÄ›**
   - Nelze geokÃ³dovat â†’ okamÅ¾itÄ› "Opravit adresu" a pokraÄovat

3. **Desktop je hustÃ½ a rychlÃ½; mobil je rovnocennÃ½, jen jinak posklÃ¡danÃ½**
   - Ne "desktop jako zvÄ›tÅ¡enÃ½ mobil"

#### 4.2 ExplicitnÃ­ "Route-aware" reÅ¾im

V Inboxu i v DomluvÄ› termÃ­nu bude pÅ™epÃ­naÄ:

```
Optimalizovat podle trasy: [Zapnuto]
```

KdyÅ¾ je **OFF**:
- Sloty nemajÃ­ Î”km/Î”min, jen "ÄasovÃ½ konflikt"
- UI ukÃ¡Å¾e InlineAlert: "Bez ovÄ›Å™enÃ© adresy nelze optimalizovat. Opravit adresu."

---

### 5. KomponentovÃ½ katalog

#### 5.1 ZÃ¡kladnÃ­ layoutovÃ© komponenty

| Komponenta | Popis |
|------------|-------|
| `AppShell` | Top nav, breadcrumb slot, content container, dense mÃ³d |
| `SplitView` | Desktop: 2â€“3 panely (Inbox / Map / Detail) |
| `RightDrawer` / `BottomSheet` | JednotnÃ¡ logika otevÅ™enÃ­/zavÅ™enÃ­, focus trap, ESC |

#### 5.2 Route-aware plÃ¡novÃ¡nÃ­

| Komponenta | Popis |
|------------|-------|
| `RouteContextHeader` | Sticky nahoÅ™e: Den, PosÃ¡dka, Depo + souhrn metrik |
| `CandidateRow` | Å˜Ã¡dek v inboxu: jmÃ©no, mÄ›sto, due, Î”km, Î”min, slot chips |
| `RouteMap` | Mapa s ÄÃ­slovanÃ½mi piny + polyline + insertion preview |
| `SlotSuggestions` | NabÃ­dka 3â€“5 slotÅ¯ s metrikami a stavy |
| `InsertionPreview` | Mini panel "vloÅ¾Ã­ se mezi: 3 (Jana) â†’ 4 (Michaela)" |

#### 5.3 StavovÃ© komponenty

| Komponenta | Popis |
|------------|-------|
| `StatusChip` | Badge pro adresu/zakÃ¡zku/kapacitu se stavem |
| `InlineAlert` | KrÃ¡tkÃ© vysvÄ›tlenÃ­ problÃ©mu + CTA |
| `MetricBadge` | Pro Î”km/Î”min a dennÃ­ metriky |

#### 5.4 Data grid

| Komponenta | Popis |
|------------|-------|
| `CustomerTable` | TanStack Table s bohatÃ½mi buÅˆkami |
| `CustomerPreviewPanel` | ShrnutÃ­ + CTA v side panelu |
| `CustomerEditDrawer` | Editace + ovÄ›Å™enÃ­ adresy |

---

### 6. KlÃ¡vesovÃ© zkratky (dispeÄerka / desktop)

#### 6.1 GlobÃ¡lnÃ­

| Zkratka | Akce |
|---------|------|
| `/` | Focus do search |
| `g i` | Go to Inbox |
| `g c` | Go to Customers |
| `g d` | Go to Day plan |

#### 6.2 Inbox

| Zkratka | Akce |
|---------|------|
| `â†‘` / `â†“` | VÃ½bÄ›r kandidÃ¡ta |
| `Enter` | OtevÅ™Ã­t detail |
| `1`..`5` | Vybrat doporuÄenÃ½ slot |
| `D` | OtevÅ™Ã­t "Domluvit" |
| `S` | UloÅ¾it/"Domluvit" (commit) |
| `O` | OtevÅ™Ã­t "OdloÅ¾it" |
| `E` | "Opravit adresu" |
| `Esc` | ZavÅ™Ã­t drawer/modal |

#### 6.3 PlÃ¡n dne

| Zkratka | Akce |
|---------|------|
| `Ctrl+S` | UloÅ¾it plÃ¡n |
| `R` | Re-optimalizovat |
| `P` | Tisk |
| `M` | Export do Google Maps |

---

### 7. Metriky kapacity a jak je ukazovat

#### 7.1 Metriky v RouteContextHeader

```
51 km â€¢ jÃ­zda 1h16 â€¢ servis 5h30 â€¢ vytÃ­Å¾enÃ­ 92% âš  â€¢ rezerva 18 min âš 
```

| Metrika | Popis |
|---------|-------|
| VzdÃ¡lenost (km) | SouÄet vÅ¡ech ÃºsekÅ¯ trasy |
| ÄŒas jÃ­zdy (travel time) | Z Valhalla matrix |
| ServisnÃ­ Äas | SouÄet service duration vÅ¡ech zastÃ¡vek |
| VytÃ­Å¾enÃ­ dne (load %) | (jÃ­zda + servis + pauzy) / pracovnÃ­ doba |
| Rezerva (slack) | NejmenÅ¡Ã­ ÄasovÃ¡ rezerva mezi nÃ¡vÅ¡tÄ›vami |

#### 7.2 Tooltip vysvÄ›tlenÃ­

- **VytÃ­Å¾enÃ­:** "VytÃ­Å¾enÃ­ = (jÃ­zda + servis + pauzy) / pracovnÃ­ doba dne"
- **Rezerva:** "NejmenÅ¡Ã­ ÄasovÃ¡ rezerva mezi nÃ¡vÅ¡tÄ›vami vzhledem k ÄasovÃ½m oknÅ¯m; nÃ­zkÃ¡ rezerva = riziko skluzu"

---

### 8. StrÃ¡nky - detailnÃ­ popis a wireframes

#### 8.1 PlÃ¡novacÃ­ inbox (route-aware)

**ÃšÄel:** Domluvit/vloÅ¾it zakÃ¡zky do konkrÃ©tnÃ­ dennÃ­ trasy s minimÃ¡lnÃ­m dopadem na km/Äas.

**Desktop layout (3 panely):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlÃ¡novacÃ­ inbox  Den[St 5.3] PosÃ¡dka[1] Depo[Brno]  Route-aware[ON] [Filtry]â”‚
â”‚ 51 km â€¢ jÃ­zda 1h16 â€¢ servis 5h30 â€¢ vytÃ­Å¾enÃ­ 92%âš  â€¢ rezerva 18mâš           â”‚
â”‚ [Po termÃ­nu(12)] [TÃ½den(18)] [30 dnÃ­(43)] [VÅ¡e] [OdloÅ¾enÃ©] [ProblÃ©my]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ INBOX         â”‚ MAPA + TRASA DNE                           â”‚ DETAIL      â”‚
â”‚ Jana NovotnÃ¡  â”‚ piny 1..N + highlight kandidÃ¡t             â”‚ Jana NovotnÃ¡â”‚
â”‚ +3.2km +6min âœ…â”‚ nÃ¡vrh vloÅ¾enÃ­ mezi 3â†’4                     â”‚ Sloty:      â”‚
â”‚ 10â€“12âœ… 12â€“14âš  â”‚                                           â”‚ 10â€“12 âœ… +6m â”‚
â”‚               â”‚                                           â”‚ 12â€“14 âš  +14mâ”‚
â”‚ Michaelaâ€¦     â”‚                                           â”‚ 8â€“10 âŒ      â”‚
â”‚ +7.8km +14mâš   â”‚                                           â”‚ [DOMLUVIT]  â”‚
â”‚               â”‚                                           â”‚ [ODLOÅ½IT]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Mobile layout:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Inbox  Den [..] PosÃ¡dka [1]     â”‚
â”‚ Kapacita 92% âš                â”‚
â”‚ [Seznam] [Mapa]              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (karty s Î”km/Î”min)            â”‚
â”‚ Jana NovotnÃ¡  +6m +3.2km âœ…   â”‚
â”‚ [Domluvit] [OdloÅ¾it]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Segmenty:**
- Po termÃ­nu / Tento tÃ½den / Do 30 dnÃ­ / VÅ¡e / OdloÅ¾enÃ© / ProblÃ©my

**UI stavy:**
1. `context=missing` - VyÅ¾aduje vÃ½bÄ›r dne+posÃ¡dky
2. `context=ready, route=loading` - Skeleton metrik a mapy
3. `route=ready, inbox=ready` - KandidÃ¡ti seÅ™azenÃ­ dle "nejlepÅ¡Ã­ vloÅ¾enÃ­"
4. `candidate=selected, suggestions=loading` - DotekajÃ­ sloty
5. `routeAware=forcedOff` - ChybÃ­ geo, banner s vysvÄ›tlenÃ­m
6. `capacity=warn|danger` - VarovÃ¡nÃ­ v headeru

---

#### 8.2 PÅ™ehled cest / Planner (`/planner`)

**ÃšÄel:** PÅ™ehled naplÃ¡novanÃ½ch cest s filtrovÃ¡nÃ­m. ProhlÃ­Å¾enÃ­ tras s detailnÃ­ Äasovou osou a vizualizacÃ­ na mapÄ›.

**Desktop layout (2 sloupce: sidebar + mapa):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LEVÃ SLOUPEC (sidebar)               â”‚  PRAVÃ SLOUPEC (mapa)            â”‚
â”‚                                        â”‚                                  â”‚
â”‚  FILTRY                                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  [Datum ____] [... rozsah]             â”‚  â”‚                          â”‚   â”‚
â”‚  [PosÃ¡dka: VÅ¡e â–¾] [Depo: VÅ¡e â–¾]       â”‚  â”‚      MAPA S TRASOU       â”‚   â”‚
â”‚                                        â”‚  â”‚   (piny + segmenty)      â”‚   â”‚
â”‚  NAPLÃNOVANÃ‰ CESTY (N)  [â†»]           â”‚  â”‚                          â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â‘ â”€â”€â‘¡â”€â”€â‘¢â”€â”€â‘£â”€â”€ğŸ          â”‚   â”‚
â”‚  â”‚ Po 2.2. â€¢ PosÃ¡dka 1 â€¢ 3 zast.   â”‚  â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚ 45 km â€¢ 2h30                     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                                  â”‚
â”‚  â”‚ Ãšt 3.2. â€¢ PosÃ¡dka 1 â€¢ 5 zast.   â”‚  â”‚                                  â”‚
â”‚  â”‚ 78 km â€¢ 4h15                     â”‚  â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                  â”‚
â”‚                                        â”‚                                  â”‚
â”‚  DETAIL TRASY           45 km Â· 2h30   â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                  â”‚
â”‚  â”‚ ğŸ  Depo Brno                     â”‚  â”‚                                  â”‚
â”‚  â”‚ â”€â”€â”€ 12 km Â· 18 min â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚                                  â”‚
â”‚  â”‚ â‘  Jan NovÃ¡k    08:30â€“09:15      â”‚  â”‚                                  â”‚
â”‚  â”‚   LesnÃ­ 123, Brno  [Potvrzeno]  â”‚  â”‚                                  â”‚
â”‚  â”‚ â”€â”€â”€ 8 km Â· 12 min â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚                                  â”‚
â”‚  â”‚ â‘¡ Marie Svob.  09:45â€“10:15     â”‚  â”‚                                  â”‚
â”‚  â”‚   HlavnÃ­ 45     [Nepotvrzeno]   â”‚  â”‚                                  â”‚
â”‚  â”‚ â”€â”€â”€ 15 km Â· 22 min â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚                                  â”‚
â”‚  â”‚ â‘¢ Petr ÄŒernÃ½   10:50â€“11:35     â”‚  â”‚                                  â”‚
â”‚  â”‚   NÃ¡draÅ¾nÃ­ 8    [Potvrzeno]     â”‚  â”‚                                  â”‚
â”‚  â”‚ â”€â”€â”€ 10 km Â· 15 min â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚                                  â”‚
â”‚  â”‚ ğŸ  Depo Brno                     â”‚  â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Filtry:**
- **Den**: vÃ½bÄ›r jednoho dne s moÅ¾nostÃ­ pÅ™epnout na rozsah
- **PosÃ¡dka**: defaultnÄ› "VÅ¡e", vÃ½bÄ›r z existujÃ­cÃ­ch posÃ¡dek
- **Depo**: defaultnÄ› "VÅ¡e", vÃ½bÄ›r z existujÃ­cÃ­ch dep
- UÅ¾ivatelskÃ© preference (defaultnÃ­ posÃ¡dka, depo) se naÄtou ze Settings jako vÃ½chozÃ­ hodnoty

**Interakce:**
- KliknutÃ­ na trasu v seznamu zobrazÃ­ jejÃ­ detail v dolnÃ­ ÄÃ¡sti sidebaru
- KliknutÃ­ na zastÃ¡vku v timeline zvÃ½raznÃ­ mÃ­sto na mapÄ› a pÅ™eletÃ­ na nÄ›j
- KliknutÃ­ na segment v timeline zvÃ½raznÃ­ Ãºsek cesty na mapÄ›
- KliknutÃ­ na segment cesty na mapÄ› zobrazÃ­ info o Ãºseku

**Komponenty (sdÃ­lenÃ© s Inbox):**
- `RouteListPanel` â€” seznam tras s kartami (datum, posÃ¡dka, zastÃ¡vky, vzdÃ¡lenost, Äas)
- `RouteDetailTimeline` â€” sdÃ­lenÃ¡ vertikÃ¡lnÃ­ timeline: depo â†’ segment (Äas odâ€“do, km, trvÃ¡nÃ­) â†’ zastÃ¡vka (status badge, dohodnutÃ©/vypoÄÃ­tanÃ© Äasy, warning ikona pÅ™i rozdÃ­lu >15 min) â†’ ... â†’ depo
  - Ve spodnÃ­m route summary: `VzdÃ¡lenost`, `CelkovÃ½ Äas`, `ZatÃ­Å¾enÃ­` + sekundÃ¡rnÃ­ Ãºdaj `z toho jÃ­zda`
  - SjednocenÃ© akce na obou strÃ¡nkÃ¡ch: `Optimalizovat`, `PÅ™idat pauzu`, `Smazat trasu`
- `RouteMapPanel` â€” sdÃ­lenÃ¡ mapa MapLibre GL (piny, segmenty, polyline, highlight, v Inbox navÃ­c selectedCandidate a insertionPreview)
- Bidirectional highlight: klik v timeline â†” zvÃ½raznÄ›nÃ­ na mapÄ›, klik na segment/zastÃ¡vku na mapÄ› â†” zvÃ½raznÄ›nÃ­ v timeline
- VRP optimalizace s pauzou: opraven backend payload pauzy pro `vrp-pragmatic` (required break), aby se optimalizace nepÅ™epÃ­nala na heuristickÃ½ fallback kvÅ¯li chybÄ› deserializace

**NastavenÃ­ uÅ¾ivatele (Settings â†’ Moje nastavenÃ­):**
- DefaultnÃ­ posÃ¡dka a depo se uklÃ¡dajÃ­ do DB (`users.default_crew_id`, `users.default_depot_id`)
- PouÅ¾Ã­vajÃ­ se jako vÃ½chozÃ­ filtry na strÃ¡nce Planner
- UÅ¾ivatel mÅ¯Å¾e filtrovat i jinÃ© posÃ¡dky/depa â€” preference nejsou tvrdÃ¡ vazba

---

#### 8.3 Seznam zÃ¡kaznÃ­kÅ¯

**ÃšÄel:** Katalog pro dohledÃ¡nÃ­ a ÃºdrÅ¾bu dat.

**Desktop (tabulka):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ZÃ¡kaznÃ­ci  [ğŸ” hledatâ€¦____________________] [Saved â–¾] [Filtry] â”‚
â”‚ [Å˜adit â–¾] [Tabulka|Karty]                               [+NovÃ½]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ZÃKAZNÃK             | MÄšSTO | ZAÅ˜. | NEJBL. ZAK. | ADRESA | â‹¯ â”‚
â”‚ Alena HÃ¡jek          | HodonÃ­n| 2    | 3.1.2027    | âœ…     | â‹¯ â”‚
â”‚ +420â€¦ â€¢ emailâ€¦ â€¢ U PoÅ¡ty 220â€¦                               â€¦ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (klik Å™Ã¡dku)                   â”‚ NÃ¡hled zÃ¡kaznÃ­ka (panel)      â”‚
â”‚                                â”‚ kontakt, adresa, CTA          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Mobile (karty):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ZÃ¡kaznÃ­ci                    â”‚
â”‚ [ğŸ” hledatâ€¦_______________]   â”‚
â”‚ [Bez adresy] [Nelze loc] [Po]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Alena HÃ¡jek (Osoba)          â”‚
â”‚ HodonÃ­n â€¢ U PoÅ¡ty 220â€¦       â”‚
â”‚ âœ… OvÄ›Å™eno â€¢ ZaÅ™Ã­zenÃ­ 2      â”‚
â”‚ NejbliÅ¾Å¡Ã­: 3.1.2027          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 8.4 Detail zÃ¡kaznÃ­ka (workspace + edit drawer)

**ÃšÄel:** RychlÃ½ pÅ™ehled + zaÅ™Ã­zenÃ­ + historie + komunikace; editace v draweru.

**Desktop (2 sloupce + taby):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† ZpÄ›t  Alena HÃ¡jek [OSOBA]  [ğŸ“] [ğŸ§­] [â• do plÃ¡nu] [âœ Upravit] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Kontakt               â”‚ [ZaÅ™Ã­zenÃ­] [ZakÃ¡zky&NÃ¡vÅ¡tÄ›vy] [Komunik.]â”‚
â”‚ +420â€¦ (kopÃ­rovat)     â”‚ â”€ ZaÅ™Ã­zenÃ­ (kompaktnÃ­ Å™Ã¡dky)            â”‚
â”‚ emailâ€¦                â”‚ Kotelâ€¦  Interval 12  DalÅ¡Ã­: â€¦  [Domluvit]â”‚
â”‚ Adresa âœ… OvÄ›Å™eno      â”‚ KomÃ­nâ€¦  Interval 24  DalÅ¡Ã­: â€¦  [Domluvit]â”‚
â”‚ U PoÅ¡ty 220â€¦ [Opravit] â”‚                                          â”‚
â”‚ Mini mapa [OtevÅ™Ã­t]   â”‚                                          â”‚
â”‚ PoznÃ¡mkyâ€¦             â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Editace:** PravÃ½ drawer se sekcemi "ZÃ¡klad", "Kontakt", "Adresa + ovÄ›Å™enÃ­", "PoznÃ¡mky"

**MazÃ¡nÃ­ zÃ¡kaznÃ­ka (aktuÃ¡lnÃ­ UX):**

- V headeru detailu je akce pro smazÃ¡nÃ­ zÃ¡kaznÃ­ka (anonymizace).
- Po kliknutÃ­ se otevÅ™e potvrzovacÃ­ dialog s upozornÄ›nÃ­m, Å¾e akce je nevratnÃ¡ a osobnÃ­ Ãºdaje budou trvale anonymizovÃ¡ny bez moÅ¾nosti undo.
- Po potvrzenÃ­ zÃ¡kaznÃ­k zmizÃ­ ze seznamÅ¯/UI, ale historickÃ¡ navÃ¡zanÃ¡ data zÅ¯stÃ¡vajÃ­ zachovÃ¡na v anonymizovanÃ© podobÄ›.
- UX copy explicitnÄ› komunikuje, Å¾e jde o anonymizaci PII (GDPR-style), ne fyzickÃ© odstranÄ›nÃ­ historickÃ½ch vazeb.

---

#### 8.5 Domluvit termÃ­n (vloÅ¾it do trasy) - dialog/panel

**ÃšÄel:** JednÃ­m rozhodnutÃ­m vybrat slot a vloÅ¾it do trasy.

**Desktop (inline panel):**

```
Domluvit termÃ­n
DoporuÄenÃ©: [Ãšt 10â€“12 âœ… +6m/+3.2km] [St 8â€“10 âœ… +0m] [ÄŒt 12â€“14 âŒ]
Datum [..]  Okno [10:00]â€“[12:00]  Doba [30m]  (PosÃ¡dka/Depo dle kontextu)
Stav: âœ… OK (rezerva 18 min)
[ZruÅ¡it]                         [Domluvit]
```

**Mobile (full-screen sheet):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Domluvit termÃ­n              â”‚
â”‚ DoporuÄenÃ©:                  â”‚
â”‚ [St 8â€“10 âœ…] [Ãšt 10â€“12 âœ…]     â”‚
â”‚ Datum [..] Okno [..]â€“[..]     â”‚
â”‚ Doba [30m]                    â”‚
â”‚ Stav: OK (+6m / +3.2km)       â”‚
â”‚ [ZruÅ¡it]         [Domluvit]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 8.6 OdloÅ¾it akci - dialog

**ÃšÄel:** OdloÅ¾it dalÅ¡Ã­ krok zakÃ¡zky do data s dÅ¯vodem.

```
OdloÅ¾it akci
OdloÅ¾it do: [dd.mm.rrrr]  Rychle: [+7] [+14] [+30]
DÅ¯vod: [NezvedÃ¡ â–¾]
PoznÃ¡mka: [__________]
[ZruÅ¡it]            [OdloÅ¾it]
```

**DÅ¯vody:** NezvedÃ¡, DovolenÃ¡, Chce zavolat pozdÄ›ji, JinÃ½

---

#### 8.7 Detail zakÃ¡zky (workflow hub)

**ÃšÄel:** CentrÃ¡lnÃ­ detail toho, co se mÃ¡ udÄ›lat.

**Desktop:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† ZpÄ›t  ZakÃ¡zka: Revize plynovÃ©ho kotle  [NADCHÃZEJÃCÃ]       â”‚
â”‚ Due: 26.2.2026   [Domluvit termÃ­n] [OdloÅ¾it] [ZruÅ¡it â‹¯]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ZÃ¡kaznÃ­k + ZaÅ™Ã­zenÃ­      â”‚ NÃ¡vÅ¡tÄ›va                           â”‚
â”‚ HustopeÄeâ€¦ âœ… adresa      â”‚ St 5.3. 10â€“12  Doba 30m  PosÃ¡dka 1     â”‚
â”‚ Kontaktâ€¦                 â”‚ [ZmÄ›nit] [OtevÅ™Ã­t plÃ¡n dne]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [PrÅ¯bÄ›h/VÃ½sledek] [Komunikace] [Historie]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**KontextovÃ© akce dle stavu:**
- `upcoming` â†’ "Domluvit termÃ­n"
- `scheduled` â†’ "ZmÄ›nit termÃ­n", "PÅ™esunout"
- `in_progress` â†’ "Na mÃ­stÄ›", "Hotovo"
- `completed` â†’ "Zobrazit vÃ½sledek"

---

### 9. UI stavovÃ© modely

#### 9.1 PlÃ¡novacÃ­ inbox - stavy

| Stav | UI | Akce | Fallback |
|------|-----|------|----------|
| `context=missing` | VyÅ¾aduje vÃ½bÄ›r dne+posÃ¡dky | Vybrat | - |
| `route=loading` | Skeleton metrik | ÄŒekat | - |
| `route=ready` | KandidÃ¡ti seÅ™azenÃ­ | Vybrat kandidÃ¡ta | - |
| `suggestions=loading` | Skeleton slotÅ¯ | ÄŒekat | - |
| `routeAware=forcedOff` | Banner "bez optimalizace" | Opravit adresu | Domluvit bez Î” |
| `capacity=warn` | Chip v headeru | PÅ™epnout posÃ¡dku/den | - |

#### 9.2 Optimistic UI

**Ano (optimistic):**
- VloÅ¾it do dne / domluvit
- OdloÅ¾it
- UloÅ¾enÃ­ poznÃ¡mky

**Ne (neoptimistic):**
- Editace adresy + ovÄ›Å™enÃ­
- Reorder celÃ© trasy (draft mÃ³d)

---

### 10. Empty states a edge cases

#### 10.1 Inbox je prÃ¡zdnÃ½

```
Inbox je prÃ¡zdnÃ½ â€“ na tento den nejsou Å¾Ã¡dnÃ© poloÅ¾ky k domluvenÃ­.
[Zobrazit dalÅ¡Ã­ obdobÃ­] [PÅ™ejÃ­t na ZÃ¡kaznÃ­ky]
```

#### 10.2 Nelze geokÃ³dovat

```
âš  Adresu se nepodaÅ™ilo ovÄ›Å™it. Do optimalizace trasy se nezahrne.
[Opravit adresu]
```

#### 10.3 ChybÃ­ telefon

```
âš  ZÃ¡kaznÃ­k nemÃ¡ telefon. Nelze obvolat.
[Doplnit telefon]
```

#### 10.4 Den je plnÃ½

```
âŒ Den je tÃ©mÄ›Å™ plnÃ½ (92%). DoporuÄeno pÅ™idat max. 1 krÃ¡tkou nÃ¡vÅ¡tÄ›vu v okolÃ­.
```

---

### 11. DoporuÄenÃ© UI knihovny

| Knihovna | ÃšÄel |
|----------|------|
| shadcn/ui + Radix UI | Dostupnost, modernÃ­ vzhled |
| Tailwind CSS | KonzistentnÃ­ spacing |
| TanStack Table | Tabulka zÃ¡kaznÃ­kÅ¯ |
| React Query | CachovÃ¡nÃ­, optimistic updates |
| React Hook Form + Zod | FormulÃ¡Å™e + validace |
| date-fns | Data/Äasy |
| Zustand | UI stav (den/posÃ¡dka, panely, filtry) |
| react-virtuoso | Virtualizace dlouhÃ½ch seznamÅ¯ |

---

---

## Phase 10: Onboarding Wizard (New User Registration)

> **Status:** âœ… Complete â€” Phase A âœ… Â· Phase B âœ… Â· Phase C âœ… Â· Phase D âœ… Â· Phase E âœ…  
> **Version:** 1.9  
> **Date:** 2026-02-21

### 1. Goals

1. Replace the current single-page Register form with a multi-step wizard.
2. Add **email verification** (confirmation link sent via Resend).
3. **Rate-limit** registration + verification endpoints; add DDoS guardrails.
4. Show **country availability** (CZ now, SK coming soon, waitlist for others).
5. Communicate the **30-day free trial** â€” no credit card required.
6. Include a **device type selection** step so the user's tenant has the right configs from day one.
7. All user-facing text available in **en**, **cs**, **sk**.
8. The wizard module is **lazy-loaded** â€” zero extra JS until the user navigates to `/register`.
9. The full country list is **lazy-loaded** â€” only fetched when the user explicitly wants a country other than the pre-selected CZ default.
10. A clear **progress indicator** is visible at all times showing total steps, current position, and step labels.

### 2. Current State (as-is)

| Area | Status |
|------|--------|
| `Register.tsx` | Single form: name, email, password, business name (optional), locale. Already lazy-loaded via `React.lazy`. |
| `handle_register` (Rust) | Creates user immediately, returns JWT. No email verification. |
| `RateLimiter` | Exists for login (5 attempts / 5 min). Not applied to registration. |
| Email infrastructure | `EmailProcessor` skeleton (Resend-based, JetStream queue). Not yet sending real emails. |
| `countries` table | Exists with `is_supported` flag. CZ + SK seeded. Admin UI can sync/manage. |
| `users` table | No `email_verified`, `verification_token_hash`, or `verification_expires` columns. |
| `device_type_configs` | Per-tenant. 5 builtin types auto-seeded on tenant creation via DB trigger (`seed_device_types_for_tenant`). Labels are hardcoded Czech. |
| `DeviceTypeConfigManager` | Full CRUD exists in Settings page. ~800 line component. |
| Country list in frontend | `CountrySelect` loads all countries eagerly on first dropdown open. |

### 3. Progress Indicator

The wizard has a persistent **horizontal stepper bar** visible on every step (except the Landing page). It shows:

```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â‘           â‘¡          â‘¢          â‘£          â‘¤
Account   About you   Devices   Depot   All set!
  â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‹
             â†‘ current
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

- **Completed steps**: filled circle + checkmark + clickable (can navigate back).
- **Current step**: filled circle + bold label.
- **Future steps**: empty circle + muted label + not clickable.
- Labels are localized.
- Mobile: labels hidden, only numbered circles with progress line.

### 4. Wizard Steps

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LANDING  (/register)                                       â”‚
â”‚  (no stepper bar â€” this is the "pre-wizard" page)           â”‚
â”‚                                                             â”‚
â”‚  Ariadline logo                                             â”‚
â”‚                                                             â”‚
â”‚  "Plan routes, manage revisions, save time."                â”‚
â”‚                                                             â”‚
â”‚  ğŸ‡¨ğŸ‡¿ Czech Republic           [Start free trial â†’]          â”‚
â”‚     Available now Â· 30 days free Â· No credit card           â”‚
â”‚                                                             â”‚
â”‚  Coming soon:                                               â”‚
â”‚  ğŸ‡¸ğŸ‡° Slovakia                  [Notify me]                  â”‚
â”‚  ğŸ‡¦ğŸ‡¹ Austria                   [Notify me]                  â”‚
â”‚  (... dynamic list from DB where coming_soon = true)        â”‚
â”‚                                                             â”‚
â”‚  ğŸ“ Different country?         [Notify me â†’]                â”‚
â”‚     We'll let you know when we launch in your country.      â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Already have an account? [Sign in]                         â”‚
â”‚                                                             â”‚
â”‚  [ğŸŒ EN] [ğŸ‡¨ğŸ‡¿ CS] [ğŸ‡¸ğŸ‡° SK]   â† language switcher            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    User clicks "Start free trial" for CZ
    OR clicks "Notify me" â†’ mini-form (email + country picker) â†’ done
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘ â”€â”€â”€â‘¡â”€â”€â”€â‘¢â”€â”€â”€â‘£â”€â”€â”€â‘¤                                         â”‚
â”‚  â—   â—‹   â—‹   â—‹   â—‹   Account                               â”‚
â”‚                                                             â”‚
â”‚  STEP 1 / 5  â€”  Account                                    â”‚
â”‚                                                             â”‚
â”‚  Email        [________________________]                    â”‚
â”‚  Password     [________________________]  (min 8 chars)     â”‚
â”‚  Confirm pwd  [________________________]                    â”‚
â”‚                                                             â”‚
â”‚  Password strength: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ Strong                       â”‚
â”‚                                                             â”‚
â”‚  â˜ I agree to the [Terms of Service] and [Privacy Policy]   â”‚
â”‚                                                             â”‚
â”‚                              [â† Back]  [Continue â†’]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Backend creates unverified user, sends verification email.
    Frontend shows "Check your inbox" interstitial.
    User clicks link in email â†’ token verified â†’ proceed.
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘ â”€â”€â”€â‘¡â”€â”€â”€â‘¢â”€â”€â”€â‘£â”€â”€â”€â‘¤                                         â”‚
â”‚  âœ“   â—   â—‹   â—‹   â—‹   About you                             â”‚
â”‚                                                             â”‚
â”‚  STEP 2 / 5  â€”  About you                                  â”‚
â”‚                                                             â”‚
â”‚  Your name *          [________________________]            â”‚
â”‚  Company name         [________________________] (optional) â”‚
â”‚  Phone                [________________________] (optional) â”‚
â”‚  ICO                  [________________________] (optional) â”‚
â”‚                                                             â”‚
â”‚  Language             [Czech â–¾]  (pre-filled from landing)  â”‚
â”‚  Country              Czech Republic (locked from landing)  â”‚
â”‚                                                             â”‚
â”‚                              [â† Back]  [Continue â†’]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘ â”€â”€â”€â‘¡â”€â”€â”€â‘¢â”€â”€â”€â‘£â”€â”€â”€â‘¤                                         â”‚
â”‚  âœ“   âœ“   â—   â—‹   â—‹   Devices                               â”‚
â”‚                                                             â”‚
â”‚  STEP 3 / 5  â€”  What do you service?                       â”‚
â”‚                                                             â”‚
â”‚  Select the device types you work with.                     â”‚
â”‚  You can add or change these later in Settings.             â”‚
â”‚                                                             â”‚
â”‚  â˜‘ Chimney               30 min Â· every 12 months  [â–¾]     â”‚
â”‚  â˜ Gas boiler            60 min Â· every 12 months          â”‚
â”‚  â˜ Gas water heater      45 min Â· every 12 months          â”‚
â”‚  â˜ Fireplace / insert    30 min Â· every 12 months          â”‚
â”‚  â˜ Gas stove             20 min Â· every 36 months          â”‚
â”‚  (labels shown in user's locale)                            â”‚
â”‚                                                             â”‚
â”‚  Expand a selected type to adjust defaults:                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜‘ Chimney                                [â–´ collapse] â”‚   â”‚
â”‚  â”‚   Default duration:  [30] min                        â”‚   â”‚
â”‚  â”‚   Revision interval: [12] months                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  [+ Add custom device type]                                 â”‚
â”‚                                                             â”‚
â”‚                              [â† Back]  [Continue â†’]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘ â”€â”€â”€â‘¡â”€â”€â”€â‘¢â”€â”€â”€â‘£â”€â”€â”€â‘¤                                         â”‚
â”‚  âœ“   âœ“   âœ“   â—   â—‹   Depot                                 â”‚
â”‚                                                             â”‚
â”‚  STEP 4 / 5  â€”  Your depot (home base)                     â”‚
â”‚                                                             â”‚
â”‚  This is where your crew starts and ends each day.          â”‚
â”‚                                                             â”‚
â”‚  Depot name *         [________________________]            â”‚
â”‚  Street *             [________________________]            â”‚
â”‚  City *               [________________________]            â”‚
â”‚  Postal code *        [________________________]            â”‚
â”‚                                                             â”‚
â”‚  [Verify address]  â†’ geocode via Nominatim                  â”‚
â”‚  âœ… Address verified (lat: 49.19, lng: 16.61)               â”‚
â”‚                                                             â”‚
â”‚                              [â† Back]  [Continue â†’]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘ â”€â”€â”€â‘¡â”€â”€â”€â‘¢â”€â”€â”€â‘£â”€â”€â”€â‘¤                                         â”‚
â”‚  âœ“   âœ“   âœ“   âœ“   â—   All set!                              â”‚
â”‚                                                             â”‚
â”‚  STEP 5 / 5  â€”  You're all set!                            â”‚
â”‚                                                             â”‚
â”‚  âœ“ Account created                                         â”‚
â”‚  âœ“ 1 device type configured (Chimney)                      â”‚
â”‚  âœ“ Depot "Brno" saved                                      â”‚
â”‚  âœ“ Crew created                                             â”‚
â”‚                                                             â”‚
â”‚  Your 30-day free trial starts today.                       â”‚
â”‚  We'll remind you before it ends â€” no surprises.            â”‚
â”‚                                                             â”‚
â”‚                    [Go to Dashboard â†’]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. Registration flow â€” sequence diagram

```
Browser                        Worker (Rust)                   Resend
  â”‚                               â”‚                              â”‚
  â”‚ sazinka.auth.register.start   â”‚                              â”‚
  â”‚ {email, password, locale,     â”‚                              â”‚
  â”‚  country}                     â”‚                              â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
  â”‚                               â”‚ validate email, password     â”‚
  â”‚                               â”‚ check rate limit (IP+email)  â”‚
  â”‚                               â”‚ check email not taken        â”‚
  â”‚                               â”‚ hash password (argon2)       â”‚
  â”‚                               â”‚ INSERT user (email_verified  â”‚
  â”‚                               â”‚   = false)                   â”‚
  â”‚                               â”‚ generate token, hash it       â”‚
  â”‚                               â”‚ store hash + expiry in DB    â”‚
  â”‚                               â”‚                              â”‚
  â”‚                               â”‚ â”€â”€â”€ email.send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
  â”‚                               â”‚   "Click to verify"          â”‚
  â”‚                               â”‚                              â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
  â”‚ {ok, message: "check inbox"}  â”‚                              â”‚
  â”‚                               â”‚                              â”‚
  â”‚ (user clicks link in email)   â”‚                              â”‚
  â”‚                               â”‚                              â”‚
  â”‚ sazinka.auth.verify-email     â”‚                              â”‚
  â”‚ {token}                       â”‚                              â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
  â”‚                               â”‚ hash token, lookup by hash, check expiry â”‚
  â”‚                               â”‚ UPDATE email_verified = true  â”‚
  â”‚                               â”‚ CREATE tenant + user_tenants  â”‚
  â”‚                               â”‚ (auto-seeds device type cfgs) â”‚
  â”‚                               â”‚ generate JWT                 â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
  â”‚ {token, user}                 â”‚                              â”‚
  â”‚                               â”‚                              â”‚
  â”‚ sazinka.onboarding.profile    â”‚                              â”‚
  â”‚ {name, businessName, phone,   â”‚                              â”‚
  â”‚  ico, locale}                 â”‚                              â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
  â”‚                               â”‚ UPDATE user profile fields   â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
  â”‚ {ok}                          â”‚                              â”‚
  â”‚                               â”‚                              â”‚
  â”‚ sazinka.onboarding.devices    â”‚                              â”‚
  â”‚ {selectedTypes: [{key,        â”‚                              â”‚
  â”‚   duration, interval}],       â”‚                              â”‚
  â”‚  customTypes: [{label,        â”‚                              â”‚
  â”‚   duration, interval}]}       â”‚                              â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
  â”‚                               â”‚ deactivate unselected        â”‚
  â”‚                               â”‚   builtin types              â”‚
  â”‚                               â”‚ update duration/interval for â”‚
  â”‚                               â”‚   selected types             â”‚
  â”‚                               â”‚ create custom types          â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
  â”‚ {deviceTypes: [...]}          â”‚                              â”‚
  â”‚                               â”‚                              â”‚
  â”‚ sazinka.onboarding.complete   â”‚                              â”‚
  â”‚ {depot: {name, street, city,  â”‚                              â”‚
  â”‚  postalCode, lat, lng}}       â”‚                              â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
  â”‚                               â”‚ INSERT depot (is_primary)    â”‚
  â”‚                               â”‚ INSERT crew "Crew 1"         â”‚
  â”‚                               â”‚   â†’ home_depot_id = depot    â”‚
  â”‚                               â”‚ UPDATE user.default_crew_id  â”‚
  â”‚                               â”‚ UPDATE user.default_depot_id â”‚
  â”‚                               â”‚ SET onboarding_completed_at  â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
  â”‚ {settings}                    â”‚                              â”‚
```

### 6. Country Availability & Waitlist

#### 6.1 Landing page behaviour

| Country | UI | Action |
|---------|-----|--------|
| CZ (`is_supported = true`, `coming_soon = false`) | Flag + "Available now" badge + "Start free trial" button | Proceeds to Step 1 with `country = "CZ"` |
| Countries where `coming_soon = true` (e.g. SK, AT, ...) | Flag + name + "Coming soon" badge. Rendered as a **dynamic list** from DB. | Each has a "Notify me" link â†’ opens email input inline |
| Others | "Different country?" link below the Coming Soon list | Opens mini-form: email + country picker (lazy) â†’ `INSERT INTO country_waitlist` |

#### 6.2 Country picker lazy loading

The landing page renders:
- **CZ card** statically (always visible),
- **Coming soon list** dynamically from DB (`coming_soon = true`),
- and lazily loads the full country picker only for "Different country?" flow.

The full `CountrySelect` dropdown is loaded **only** when the user clicks "Different country?":

1. `React.lazy(() => import('@/components/common/CountrySelect'))` loads the component chunk.
2. The component itself lazy-loads the country data on first dropdown open (existing behaviour).

Zero extra JS or data fetched until the user explicitly asks for it.

#### 6.3 New DB table: `country_waitlist`

```sql
CREATE TABLE country_waitlist (
    id          UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email       VARCHAR(255) NOT NULL,
    country     CHAR(2) NOT NULL,
    locale      VARCHAR(10) NOT NULL DEFAULT 'en',
    created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(email, country)
);

CREATE INDEX idx_waitlist_country ON country_waitlist(country);
```

#### 6.4 New column on `countries` table

```sql
ALTER TABLE countries
    ADD COLUMN coming_soon BOOLEAN NOT NULL DEFAULT false;

UPDATE countries SET coming_soon = true WHERE code = 'SK';
```

### 7. Email Verification

#### 7.1 DB migration

```sql
ALTER TABLE users
    ADD COLUMN email_verified         BOOLEAN NOT NULL DEFAULT false,
    ADD COLUMN verification_token_hash VARCHAR(128),  -- e.g. argon2 or SHA-256 hex
    ADD COLUMN verification_expires   TIMESTAMPTZ,
    ADD COLUMN tos_accepted_at        TIMESTAMPTZ;    -- GDPR: when user accepted ToS + Privacy Policy

-- Auto-verify all existing users
UPDATE users SET email_verified = true
WHERE password_hash != 'not-set';

CREATE INDEX idx_users_verification_token_hash
    ON users(verification_token_hash)
    WHERE verification_token_hash IS NOT NULL;
```

#### 7.2 Token generation

- 32-byte random token, hex-encoded (64 chars). Send raw token in email link.
- Store **hash** of token in DB (`verification_token_hash`), not plaintext. On verify: hash incoming token, lookup by hash, check expiry.
- Expires after **24 hours**.
- **Token reuse on resend**: If the user clicks "Resend", do not immediately overwrite the token. If the existing token is still valid (unexpired), resend the same token. This ensures that if the first email arrives delayed and the user clicks it, the link is still valid. If expired, generate a new one.

#### 7.3 Email templates

Sent via Resend through the existing `EmailProcessor` JetStream queue. Templates are locale-aware:

**1. Verification email (new user):**
| Locale | Subject | Body (excerpt) |
|--------|---------|----------------|
| en | "Verify your Ariadline account" | "Click the link below to verify your email. This link expires in 24 hours." |
| cs | "OvÄ›Å™te svÅ¯j ÃºÄet Ariadline" | "KliknutÃ­m na odkaz nÃ­Å¾e ovÄ›Å™Ã­te svou e-mailovou adresu. Odkaz je platnÃ½ 24 hodin." |
| sk | "Overte svoj ÃºÄet Ariadline" | "KliknutÃ­m na odkaz niÅ¾Å¡ie overÃ­te svoju e-mailovÃº adresu. Odkaz je platnÃ½ 24 hodÃ­n." |

**2. Already registered (anti-enumeration):**
If an existing verified user tries to register again, we send this email to prevent them from getting stuck, without revealing to the submitter (who might be an attacker) that the account exists.
| Locale | Subject | Body (excerpt) |
|--------|---------|----------------|
| en | "Account already exists" | "You (or someone else) recently tried to register with this email. You already have an account! Click here to log in." |
| cs | "ÃšÄet jiÅ¾ existuje" | "NÄ›kdo se pokusil zaregistrovat s tÃ­mto e-mailem. ÃšÄet u nÃ¡s jiÅ¾ mÃ¡te! KliknÄ›te zde pro pÅ™ihlÃ¡Å¡enÃ­." |
| sk | "ÃšÄet uÅ¾ existuje" | "Niekto sa pokÃºsil zaregistrovaÅ¥ s tÃ½mto e-mailom. ÃšÄet u nÃ¡s uÅ¾ mÃ¡te! Kliknite sem pre prihlÃ¡senie." |

#### 7.4 Verification link format

```
{APP_BASE_URL}/verify-email?token=<hex_token>
```

`APP_BASE_URL` (or `VERIFICATION_BASE_URL`) is configurable: dev/staging use `http://localhost:5173` etc.; production uses `https://app.ariadline.cz`.

Frontend route `/verify-email` reads the token, sends `sazinka.auth.verify-email`, stores JWT, redirects to Step 2.

#### 7.5 Resend verification

"Resend verification email" button with **60-second cooldown** (frontend timer + backend rate limit). NATS subject: `sazinka.auth.resend-verification`.

### 8. Device Type Selection (Step 3)

#### 8.1 Purpose

When a new tenant is created, the DB trigger `seed_device_types_for_tenant` inserts 5 builtin device types with Czech labels. Step 3 lets the user:

1. **Select** which builtin types are relevant (checkbox toggle).
2. **Adjust** default duration and revision interval per selected type.
3. **Add custom** device types (label + duration + interval).

Unselected builtin types are **deactivated** (`is_active = false`), not deleted â€” so they can be re-enabled later in Settings.

#### 8.2 Builtin types presented

Chimney is listed **first and pre-selected** (target market: chimney sweepers). All others unchecked by default.

| # | Key | i18n key | EN label | Duration | Interval | Default |
|---|-----|----------|----------|----------|----------|---------|
| 1 | `chimney` | `device_type_chimney` | Chimney | 30 min | 12 months | **checked** |
| 2 | `gas_boiler` | `device_type_gas_boiler` | Gas boiler | 60 min | 12 months | unchecked |
| 3 | `gas_water_heater` | `device_type_gas_water_heater` | Gas water heater | 45 min | 12 months | unchecked |
| 4 | `fireplace` | `device_type_fireplace` | Fireplace / insert | 30 min | 12 months | unchecked |
| 5 | `gas_stove` | `device_type_gas_stove` | Gas stove | 20 min | 36 months | unchecked |

All labels are **localized** â€” no hardcoded Czech. The `sort_order` in the wizard overrides DB `sort_order` to put chimney first.

#### 8.3 Custom type creation

Minimal: just **label**, **duration**, and **interval**. Custom fields can be added later in Settings. This keeps the wizard simple.

#### 8.4 Backend handler: `sazinka.onboarding.devices`

```rust
pub struct OnboardingDevicesRequest {
    /// Builtin types the user selected (with optional overrides)
    pub selected_builtins: Vec<BuiltinSelection>,
    /// New custom types to create
    pub custom_types: Vec<CustomTypeCreation>,
}

pub struct BuiltinSelection {
    pub device_type_key: String,
    pub default_revision_duration_minutes: Option<i32>,
    pub default_revision_interval_months: Option<i32>,
}

pub struct CustomTypeCreation {
    pub label: String,
    pub default_revision_duration_minutes: i32,
    pub default_revision_interval_months: i32,
}
```

Logic:
1. Get tenant_id for user.
2. For each builtin type NOT in `selected_builtins` â†’ `UPDATE SET is_active = false`.
3. For each builtin type IN `selected_builtins` â†’ `UPDATE SET duration, interval` if overridden.
4. For each `custom_types` entry â†’ `INSERT INTO device_type_configs` (is_builtin = false).

#### 8.5 Depot geocoding UX flow (Step 4)

Geocoding is **mandatory** â€” the app relies on depot coordinates for route planning. The flow handles loading, success, failure, and rate limiting:

```
User fills in Street, City, Postal code
        â”‚
        â–¼
[Verify address]  â† button (enabled when all 3 fields non-empty)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŸ³ Verifying address...                                â”‚
â”‚  (spinner, button disabled, fields read-only)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€ SUCCESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   â”‚  âœ… Address verified                        â”‚
        â”‚   â”‚  Coordinates: 49.1951Â°N, 16.6068Â°E         â”‚
        â”‚   â”‚  [Continue â†’] enabled                       â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€ GEOCODE FAILED (no result) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   â”‚  âš  Could not find this address.            â”‚
        â”‚   â”‚  Please check the street, city and postal  â”‚
        â”‚   â”‚  code, then try again.                     â”‚
        â”‚   â”‚                                            â”‚
        â”‚   â”‚  [Try again]                               â”‚
        â”‚   â”‚                                            â”‚
        â”‚   â”‚  Or pin the location manually:             â”‚
        â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚   â”‚  â”‚                                      â”‚  â”‚
        â”‚   â”‚  â”‚         [Interactive Map]            â”‚  â”‚
        â”‚   â”‚  â”‚      (Click to drop a pin)           â”‚  â”‚
        â”‚   â”‚  â”‚                                      â”‚  â”‚
        â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚   â”‚  [Use pinned location]                     â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€ NETWORK ERROR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   â”‚  âš  Verification failed. Please try again.  â”‚
        â”‚   â”‚  [Retry]                                   â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â””â”€â”€ RATE LIMITED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  âš  Too many attempts. Please wait a moment â”‚
            â”‚  and try again.                            â”‚
            â”‚  [Retry] (disabled for 30s, countdown)     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Rate limit:** 5 geocode requests per user per 5 minutes. This prevents abuse of the Nominatim instance during onboarding. Uses the same `MultiRateLimiter` infrastructure.

**Manual coordinates fallback:** If geocoding repeatedly fails (e.g. new address not yet in Nominatim), an interactive map (e.g., Leaflet) is displayed centered on the selected country. The user can click to drop a pin to set their depot location directly. The "Use pinned location" button validates that the dropped pin is within plausible range for the selected country (e.g. CZ: lat 48.5â€“51.1, lng 12.0â€“18.9).

**"Continue" button state:**
- Disabled until address is verified (either via geocode or pinned location).
- Stays enabled after successful verification â€” editing the address fields resets the verification state, requiring re-verification.

---

### 9. Rate Limiting & DDoS Protection

#### 9.1 Backend rate limits

| Endpoint | Limit | Key | Window |
|----------|-------|-----|--------|
| `sazinka.auth.register.start` | 3 per email, 10 per IP | email + IP | 15 min |
| `sazinka.auth.verify-email` | 5 per token | token prefix | 15 min |
| `sazinka.auth.resend-verification` | 2 per email | email | 5 min |
| `sazinka.auth.login` | 5 per email (existing) | email | 5 min |
| `sazinka.onboarding.geocode.depot` | 5 per user | user_id | 5 min |
| `sazinka.waitlist.join` | 3 per email | email | 1 hour |

#### 9.2 Implementation

Extend the existing `RateLimiter` into a `MultiRateLimiter`:

```rust
pub struct RateLimiterConfig {
    pub max_attempts: u32,
    pub window_seconds: u64,
}

pub struct MultiRateLimiter {
    limiters: HashMap<String, RateLimiter>,
}
```

#### 9.3 DDoS protection (infrastructure layer)

- **Cloudflare proxy** in front of the app domain â€” automatic L3/L4/L7 DDoS mitigation, bot management, WAF rate limiting rules as second layer.
- **NATS** not publicly exposed (internal Docker network only).
- **WebSocket** endpoint (NATS over WS) is the only public surface â€” Cloudflare proxies it.

### 10. Free Trial Messaging

30-day free trial, no credit card. Texts for all three locales:

| Key | EN | CS | SK |
|-----|-----|-----|-----|
| `trial_badge` | "30 days free" | "30 dnÃ­ zdarma" | "30 dnÃ­ zadarmo" |
| `trial_no_card` | "No credit card required" | "Bez platebnÃ­ karty" | "Bez platobnej karty" |
| `trial_started` | "Your 30-day free trial starts today. We'll remind you before it ends â€” no surprises." | "VaÅ¡e 30dennÃ­ zkuÅ¡ebnÃ­ obdobÃ­ zaÄÃ­nÃ¡ dnes. UpozornÃ­me vÃ¡s pÅ™ed jeho koncem â€” Å¾Ã¡dnÃ¡ pÅ™ekvapenÃ­." | "VaÅ¡e 30-dÅˆovÃ© skÃºÅ¡obnÃ© obdobie zaÄÃ­na dnes. UpozornÃ­me vÃ¡s pred jeho koncom â€” Å¾iadne prekvapenia." |

### 11. "Behind the scenes" â€” What the backend does at each step

| Step | Backend action |
|------|---------------|
| Landing page load | Fetch supported + coming-soon countries from DB (public endpoint, no auth; lightweight query, cached) |
| Landing â†’ "Start free trial" | Nothing (country stored in frontend wizard state) |
| Landing â†’ "Notify me" (Coming Soon or Other) | `INSERT INTO country_waitlist` |
| Step 1 â†’ Continue | `INSERT INTO users` (email_verified=false, tos_accepted_at=now()), generate/store verification token hash, send verification email. |
| Email link clicked | `UPDATE users SET email_verified=true`, create tenant + user_tenant relation (triggers `seed_device_types_for_tenant`), issue JWT |
| Step 2 â†’ Continue | `UPDATE users SET name, business_name, phone, ico, locale, country` |
| Step 3 â†’ Continue | Deactivate unselected builtins, update selected overrides, create custom types |
| Step 4 â†’ "Verify address" | Call Nominatim geocoder (`sazinka.onboarding.geocode.depot`) |
| Step 4 â†’ Continue | `INSERT INTO depots`, `INSERT INTO crews` (label from i18n key `onboarding_default_crew_name`), update user defaults, set `onboarding_completed_at` |
| Step 5 â†’ "Go to Dashboard" | Frontend redirect (data already saved) |

### 12. Lazy Loading Strategy

```
/login           â† eagerly loaded (Login.tsx)
/register        â† lazy-loaded (entire wizard module)
  â”œâ”€â”€ Landing    â† rendered immediately, CZ card static + Coming Soon from API
  â”œâ”€â”€ WaitlistForm  â† lazy-loaded on "Different country?" click
  â”‚   â””â”€â”€ CountrySelect â† lazy-loaded on dropdown open (existing)
  â”œâ”€â”€ StepIndicator â† rendered on all wizard steps (1â€“5)
  â”œâ”€â”€ Step1Account  â† rendered on "Start free trial" click
  â”œâ”€â”€ VerifyEmail   â† rendered after Step 1 submit
  â”œâ”€â”€ Step2Profile  â† rendered after email verified
  â”œâ”€â”€ Step3Devices  â† rendered after Step 2 submit
  â”œâ”€â”€ Step4Depot    â† rendered after Step 3 submit
  â”‚   â””â”€â”€ LeafletMap â† lazy-loaded on geocode failure (fallback only)
  â””â”€â”€ Step5Done     â† rendered after Step 4 submit
/verify-email    â† lazy-loaded (thin wrapper, calls verify then redirects)
```

The wizard is a single lazy chunk. Sub-steps are plain components (not further code-split) since the wizard module itself is already deferred. `CountrySelect` stays in its own chunk because it pulls in the full 200+ country dataset. The **Leaflet map** (interactive fallback for geocoding failure) is also a separate lazy chunk â€” it's a large dependency only needed in the rare case that Nominatim fails.

### 13. TDD Implementation Plan

#### Phase A: Database & Types (backend) âœ… DONE

##### A1. Migration 023 â€” email verification columns

**Red:**
```rust
#[test]
fn user_has_email_verified_field() {
    // query user â†’ assert email_verified exists and defaults to false
}
#[test]
fn user_has_verification_token_hash_field() {
    // insert user â†’ set verification_token_hash â†’ query back â†’ assert match
}
```

**Green:** Migration adding `email_verified`, `verification_token_hash`, `verification_expires` to `users`. Backfill existing users as verified.

**Refactor:** Update `User` struct, `USER_COLUMNS`, `UserPublic` to include `emailVerified`.

##### A2. Migration 024 â€” country_waitlist table + countries.coming_soon

**Red:**
```rust
#[test]
fn can_insert_and_query_waitlist_entry() { ... }
#[test]
fn waitlist_unique_constraint_on_email_country() { ... }
#[test]
fn country_has_coming_soon_field() { ... }
```

**Green:** Migration creating `country_waitlist`, adding `coming_soon` to `countries`.

**Refactor:** Create `CountryWaitlistEntry` type, update `Country` struct.

##### A3. Migration 025 â€” onboarding progress columns

**Red:**
```rust
#[test]
fn user_has_onboarding_completed_at() {
    // newly created user â†’ assert onboarding_completed_at IS NULL
}
#[test]
fn user_has_onboarding_step() {
    // newly created user â†’ assert onboarding_step = 2 after verification
}
```

**Green:** 
- `ALTER TABLE users ADD COLUMN onboarding_completed_at TIMESTAMPTZ;`
- `ALTER TABLE users ADD COLUMN onboarding_step SMALLINT NOT NULL DEFAULT 0;`  
  (`0` = pre-verification, `2` = at About you, `3` = at Devices, `4` = at Depot, `5` = at All set, `6` = completed)
- Backfill existing users: `UPDATE users SET onboarding_completed_at = created_at, onboarding_step = 6 WHERE email_verified = true`.

##### A4. Shared types â€” new message payloads

**Red (TypeScript):**
```typescript
describe('RegisterStartRequest', () => {
    it('requires email, password, locale, country', () => { ... });
});
describe('OnboardingDevicesRequest', () => {
    it('requires selectedBuiltins array', () => { ... });
});
describe('OnboardingCompleteRequest', () => {
    it('requires depot fields', () => { ... });
});
```

**Green:** Add types to `packages/shared-types/src/auth.ts` and `packages/shared-types/src/onboarding.ts`.

---

#### Phase B: Backend Handlers âœ… DONE (B1â€“B3, B7, B8)

##### B1. `handle_register_start` â€” create unverified user + send email

**Red:**
```rust
#[tokio::test]
async fn register_start_creates_unverified_user() { ... }
#[tokio::test]
async fn register_start_stores_verification_token_hash() { ... }
#[tokio::test]
async fn register_start_sends_already_registered_email_for_verified_duplicate() { ... }  // anti-enumeration
#[tokio::test]
async fn register_start_resends_verification_for_unverified_duplicate() { ... }  // re-engage abandoned signup
#[tokio::test]
async fn register_start_rate_limited() { ... }
```

**Green:** Handler on `sazinka.auth.register.start`:
1. Validate email + password (min 8 chars, at least 1 uppercase + 1 lowercase + 1 digit â€” per Q4).
2. Check rate limit.
3. If email already exists **and verified**: publish "Already Registered" email job (with login link) to JetStream and return generic success â€” anti-enumeration (section 16.2).
4. If email already exists **but unverified**: re-send the verification email (reuse existing valid token per section 7.2, or generate new if expired) and return generic success.
5. Hash password, insert user (`email_verified = false`).
6. Generate verification token, hash it, store hash with 24h expiry.
7. Publish verification email job to JetStream.
8. Return generic success message.

##### B2. `handle_verify_email` â€” verify token, issue JWT

**Red:**
```rust
#[tokio::test]
async fn verify_email_activates_user() { ... }
#[tokio::test]
async fn verify_email_returns_jwt() { ... }
#[tokio::test]
async fn verify_email_rejects_expired_token() { ... }
#[tokio::test]
async fn verify_email_rejects_invalid_token() { ... }
#[tokio::test]
async fn verify_email_rejects_already_verified() { ... }
```

**Green:** Handler on `sazinka.auth.verify-email`. On success, create tenant mapping, issue JWT, and set `users.onboarding_step = 2`.

##### B3. `handle_resend_verification`

**Red:**
```rust
#[tokio::test]
async fn resend_reuses_valid_unexpired_token() { ... }
#[tokio::test]
async fn resend_rate_limited() { ... }
#[tokio::test]
async fn resend_rejects_already_verified() { ... }
```

**Green:** Handler on `sazinka.auth.resend-verification`. Return generic success (anti-enumeration; see section 16.2).

##### B4. `handle_onboarding_profile` â€” save user profile fields

**Red:**
```rust
#[tokio::test]
async fn onboarding_profile_updates_user() {
    // send name, phone, ico â†’ query user â†’ assert fields set
}
#[tokio::test]
async fn onboarding_profile_rejects_unverified() { ... }
```

**Green:** Handler on `sazinka.onboarding.profile`. On success, set `users.onboarding_step = GREATEST(onboarding_step, 3)`.

##### B5. `handle_onboarding_devices` â€” configure device types

**Red:**
```rust
#[tokio::test]
async fn onboarding_devices_deactivates_unselected_builtins() {
    // select only gas_boiler + chimney â†’ query configs â†’ assert 3 others inactive
}
#[tokio::test]
async fn onboarding_devices_updates_duration_override() {
    // select gas_boiler with duration=90 â†’ query â†’ assert 90
}
#[tokio::test]
async fn onboarding_devices_creates_custom_type() {
    // send custom type "Heat pump" â†’ query â†’ assert exists, is_builtin=false
}
#[tokio::test]
async fn onboarding_devices_rejects_unverified() { ... }
```

**Green:** Handler on `sazinka.onboarding.devices`. On success, set `users.onboarding_step = GREATEST(onboarding_step, 4)`.

##### B6. `handle_onboarding_complete` â€” save depot + create crew

**Red:**
```rust
#[tokio::test]
async fn onboarding_creates_depot_and_crew() {
    // complete with depot â†’ query depots â†’ assert 1 primary
    // query crews â†’ assert "Crew 1" linked to depot
}
#[tokio::test]
async fn onboarding_sets_default_ids() {
    // complete â†’ query user â†’ assert default_crew_id, default_depot_id set
}
#[tokio::test]
async fn onboarding_sets_completed_at() {
    // complete â†’ query user â†’ assert onboarding_completed_at IS NOT NULL
}
#[tokio::test]
async fn onboarding_rejects_unverified() { ... }
```

**Green:** Handler on `sazinka.onboarding.complete`. Wrap in transaction and set `users.onboarding_step = 6`.

##### B7. `handle_waitlist_join`

**Red:**
```rust
#[tokio::test]
async fn waitlist_join_inserts_entry() { ... }
#[tokio::test]
async fn waitlist_join_idempotent() { ... }
#[tokio::test]
async fn waitlist_join_rate_limited() { ... }
```

**Green:** Handler on `sazinka.waitlist.join`.

##### B8. MultiRateLimiter

**Red:**
```rust
#[test]
fn multi_rate_limiter_independent_configs() { ... }
```

**Green:** Extend `RateLimiter` into `MultiRateLimiter`.

---

#### Phase C: Email Abstraction Layer & Resend Integration âœ… DONE (C0, C1)

The current `EmailProcessor` is tightly coupled to JetStream and has no abstraction for the actual send operation. We need a trait-based abstraction so that:

- **Production**: sends via Resend HTTP API.
- **Development**: logs emails to console + writes to a local file (inspectable).
- **Tests**: captures sent emails in memory for assertions.

##### C0. `EmailSender` trait + implementations

**Location:** `worker/src/services/email.rs` (new module, replaces direct Resend coupling in `email_processor.rs`)

**Red:**
```rust
#[test]
fn email_message_builder_sets_all_fields() {
    let msg = EmailMessage::new("to@example.com", "Subject", "<p>Body</p>")
        .with_text("Body")
        .with_from("sender@example.com", "Sender");
    assert_eq!(msg.to, "to@example.com");
    assert_eq!(msg.subject, "Subject");
    assert!(msg.from_email.is_some());
}

#[tokio::test]
async fn fake_sender_captures_emails() {
    let sender = FakeEmailSender::new();
    sender.send(&EmailMessage::new("a@b.com", "Hi", "<p>Hi</p>")).await.unwrap();
    let sent = sender.sent_emails();
    assert_eq!(sent.len(), 1);
    assert_eq!(sent[0].to, "a@b.com");
}

#[tokio::test]
async fn fake_sender_can_simulate_failure() {
    let sender = FakeEmailSender::new().with_failure("Simulated outage");
    let result = sender.send(&EmailMessage::new("a@b.com", "Hi", "<p>Hi</p>")).await;
    assert!(result.is_err());
}

#[tokio::test]
async fn log_sender_does_not_fail() {
    let sender = LogEmailSender::new();
    sender.send(&EmailMessage::new("a@b.com", "Hi", "<p>Hi</p>")).await.unwrap();
    // no panic, email logged to tracing + file
}
```

**Green:**

```rust
/// A single outbound email.
pub struct EmailMessage {
    pub to: String,
    pub subject: String,
    pub body_html: String,
    pub body_text: Option<String>,
    pub from_email: Option<String>,
    pub from_name: Option<String>,
}

/// Result of a send operation.
pub struct SendResult {
    pub message_id: String,
}

/// Abstraction over email delivery.
#[async_trait]
pub trait EmailSender: Send + Sync {
    async fn send(&self, message: &EmailMessage) -> Result<SendResult>;
}

// --- Implementations ---

/// Production: sends via Resend HTTP API.
pub struct ResendEmailSender { api_key: String, from_email: String, from_name: String }

/// Development: logs to tracing (info level) + appends to `logs/emails.jsonl`.
pub struct LogEmailSender { log_dir: PathBuf }

/// Tests: captures emails in Arc<Mutex<Vec<EmailMessage>>>, optionally simulates failures.
pub struct FakeEmailSender { sent: Arc<Mutex<Vec<EmailMessage>>>, fail_with: Option<String> }
```

**Selection logic** (in `main.rs` or config):
```rust
fn create_email_sender() -> Arc<dyn EmailSender> {
    if let Ok(api_key) = std::env::var("RESEND_API_KEY") {
        Arc::new(ResendEmailSender::new(&api_key, ...))
    } else {
        info!("RESEND_API_KEY not set â€” using LogEmailSender (dev mode)");
        Arc::new(LogEmailSender::new("logs"))
    }
}
```

Tests inject `FakeEmailSender` directly.

**Refactor:** `EmailProcessor` receives `Arc<dyn EmailSender>` instead of `Option<EmailConfig>`. The `process_job` method calls `self.sender.send(...)` instead of having a `TODO: Implement actual email sending` comment.

##### C1. Email templates

**Red:**
```rust
#[test]
fn verification_email_renders_en() {
    let html = render_verification_email("https://...", "en");
    assert!(html.contains("Verify your"));
}
#[test]
fn verification_email_renders_cs() {
    let html = render_verification_email("https://...", "cs");
    assert!(html.contains("OvÄ›Å™te"));
}
#[test]
fn verification_email_renders_sk() {
    let html = render_verification_email("https://...", "sk");
    assert!(html.contains("Overte"));
}
#[test]
fn already_registered_email_renders_en() {
    let html = render_already_registered_email("https://...", "en");
    assert!(html.contains("already have an account"));
}
```

**Green:** 
- `render_verification_email(link: &str, locale: &str) -> EmailMessage` â€” returns a fully-formed `EmailMessage` with locale-aware subject + HTML body for new users.
- `render_already_registered_email(link: &str, locale: &str) -> EmailMessage` â€” returns `EmailMessage` for duplicate registration attempts.

##### C2. ResendEmailSender HTTP implementation

**Red:**
```rust
#[tokio::test]
async fn resend_sender_posts_to_api() {
    // Use a mock HTTP server (e.g. wiremock) to verify:
    // - POST to /emails
    // - Authorization: Bearer <api_key>
    // - JSON body contains to, from, subject, html
    // - Returns message_id from mock response
}

#[tokio::test]
async fn resend_sender_returns_error_on_4xx() {
    // Mock returns 422 â†’ assert Result::Err with meaningful message
}
```

**Green:** `ResendEmailSender::send()` â€” HTTP POST to `https://api.resend.com/emails` using `reqwest`. Parses response for `id` field.

##### C3. LogEmailSender for development

**Red:**
```rust
#[tokio::test]
async fn log_sender_writes_to_file() {
    let dir = tempdir().unwrap();
    let sender = LogEmailSender::new(dir.path());
    sender.send(&EmailMessage::new("a@b.com", "Test", "<p>Test</p>")).await.unwrap();
    let content = std::fs::read_to_string(dir.path().join("emails.jsonl")).unwrap();
    assert!(content.contains("a@b.com"));
}
```

**Green:** `LogEmailSender::send()` â€” logs via `tracing::info!`, appends JSON line to `logs/emails.jsonl`. The file is human-readable and can be tailed during development (`tail -f logs/emails.jsonl`).

**Dev workflow:** When a verification email is "sent" in dev mode, the developer sees:

```
INFO  email: [DEV] Email to=user@example.com subject="Verify your Ariadline account"
INFO  email: [DEV] Verification link: https://app.ariadline.cz/verify-email?token=abc123...
```

The full email (HTML, text, headers) is in `logs/emails.jsonl` for inspection.

---

#### Phase D: Frontend â€” Wizard Components âœ… DONE

##### D1. StepIndicator component

**Red:**
```typescript
describe('StepIndicator', () => {
    it('renders 5 steps with labels', () => { ... });
    it('marks completed steps with checkmark', () => { ... });
    it('highlights current step', () => { ... });
    it('makes completed steps clickable', () => { ... });
    it('disables future steps', () => { ... });
    it('works on mobile (labels hidden, circles visible)', () => { ... });
});
```

**Green:** `StepIndicator.tsx` â€” horizontal stepper, localized labels.

##### D2. Wizard shell + state management

**Red:**
```typescript
describe('OnboardingWizard', () => {
    it('renders Landing step by default', () => { ... });
    it('advances to Step1 on "Start free trial" click', () => { ... });
    it('shows StepIndicator on steps 1-5 but not on Landing', () => { ... });
    it('preserves state across steps (country, locale, email)', () => { ... });
    it('allows navigating back to completed steps via StepIndicator', () => { ... });
});
```

**Green:** `OnboardingWizard.tsx` â€” state machine, React context for shared state.

**Refactor:** Update `/register` route to use new wizard.

##### D3. Landing step

**Red:**
```typescript
describe('Landing', () => {
    it('shows CZ as available with "Start free trial" button', () => { ... });
    it('shows SK as "Coming soon" with disabled button', () => { ... });
    it('shows "Different country?" link', () => { ... });
    it('lazy-loads WaitlistForm on "Different country?" click', () => { ... });
    it('shows language switcher (en/cs/sk)', () => { ... });
    it('shows free trial badge', () => { ... });
    it('links to /login', () => { ... });
});
```

**Green:** `Landing.tsx`.

##### D4. WaitlistForm (lazy)

**Red:**
```typescript
describe('WaitlistForm', () => {
    it('renders email input and lazy CountrySelect', () => { ... });
    it('submits to sazinka.waitlist.join', () => { ... });
    it('shows success message after submit', () => { ... });
    it('shows error on rate limit', () => { ... });
});
```

**Green:** `WaitlistForm.tsx`.

##### D5. Step1Account

**Red:**
```typescript
describe('Step1Account', () => {
    it('renders email, password, confirm password fields', () => { ... });
    it('shows password strength indicator', () => { ... });
    it('validates password match before submit', () => { ... });
    it('validates minimum length', () => { ... });
    it('shows ToS + Privacy Policy checkbox with links', () => { ... });
    it('disables Continue until ToS checkbox is checked', () => { ... });
    it('submits to sazinka.auth.register.start', () => { ... });
    it('transitions to VerifyEmail on success (always shows generic success â€” anti-enumeration)', () => { ... });
    it('shows rate limit error', () => { ... });
    it('Back discards form and returns to Landing â€” user starts registration from scratch', () => { ... });
});
```

**Green:** `Step1Account.tsx`.

##### D6. VerifyEmail interstitial

**Red:**
```typescript
describe('VerifyEmail', () => {
    it('shows "Check your inbox" with email address', () => { ... });
    it('shows "Resend" button', () => { ... });
    it('disables "Resend" for 60s after click', () => { ... });
    it('shows countdown timer', () => { ... });
});
```

**Green:** `VerifyEmail.tsx`.

##### D7. `/verify-email` route

**Red:**
```typescript
describe('VerifyEmailRoute', () => {
    it('reads token from URL', () => { ... });
    it('calls sazinka.auth.verify-email', () => { ... });
    it('stores JWT, redirects to step 2 on success', () => { ... });
    it('shows error on invalid/expired token', () => { ... });
});
```

**Green:** New lazy route `/verify-email` â†’ `VerifyEmailCallback.tsx`.

##### D8. Step2Profile

**Red:**
```typescript
describe('Step2Profile', () => {
    it('pre-fills locale and country from wizard state', () => { ... });
    it('requires name', () => { ... });
    it('makes business name, phone, ICO optional', () => { ... });
    it('submits to sazinka.onboarding.profile', () => { ... });
    it('advances to Step3', () => { ... });
});
```

**Green:** `Step2Profile.tsx`.

##### D9. Step3Devices

**Red:**
```typescript
describe('Step3Devices', () => {
    it('fetches builtin device types on mount', () => { ... });
    it('renders checkbox list of 5 builtin types', () => { ... });
    it('shows Chimney first and pre-checked', () => { ... });
    it('shows all other types unchecked by default', () => { ... });
    it('shows duration and interval for each type', () => { ... });
    it('allows expanding a selected type to edit duration/interval', () => { ... });
    it('shows "Add custom device type" button', () => { ... });
    it('allows adding a custom type with label/duration/interval', () => { ... });
    it('requires at least 1 type selected to continue', () => { ... });
    it('disables Continue when all types are unchecked', () => { ... });
    it('submits to sazinka.onboarding.devices', () => { ... });
    it('advances to Step4', () => { ... });
});
```

**Green:** `Step3Devices.tsx`.

##### D10. Step4Depot

**Red:**
```typescript
describe('Step4Depot', () => {
    it('renders depot name, street, city, postal code', () => { ... });
    it('disables "Verify address" until street+city+postal filled', () => { ... });
    it('shows loading spinner during geocoding', () => { ... });
    it('shows verified lat/lng on success', () => { ... });
    it('enables "Continue" only after verification', () => { ... });
    it('shows error + retry on geocode failure', () => { ... });
    it('shows interactive map fallback on geocode failure', () => { ... });
    it('validates pinned coords are within country bounds', () => { ... });
    it('resets verification state when address fields change', () => { ... });
    it('shows rate limit message when too many attempts', () => { ... });
    it('submits to sazinka.onboarding.complete', () => { ... });
    it('advances to Step5', () => { ... });
});
```

**Green:** `Step4Depot.tsx`.

##### D11. Step5Done

**Red:**
```typescript
describe('Step5Done', () => {
    it('shows summary (account, N device types, depot, crew)', () => { ... });
    it('shows free trial message', () => { ... });
    it('navigates to / on button click', () => { ... });
});
```

**Green:** `Step5Done.tsx`.

##### D12. i18n â€” onboarding namespace

**Red:**
```typescript
describe('onboarding translations', () => {
    it('has all keys in en', () => { ... });
    it('has all keys in cs', () => { ... });
    it('has all keys in sk', () => { ... });
    it('has no missing keys vs en baseline', () => { ... });
});
```

**Green:** Create `apps/web/public/locales/{en,cs,sk}/onboarding.json`.

---

#### Phase E: Integration & Auth Guard âœ… DONE

##### E1. Protect app behind email_verified

**Red:**
```rust
#[tokio::test]
async fn unverified_user_cannot_access_protected_endpoints() { ... }
```

**Green:** Add `email_verified` to JWT payload. Frontend `ProtectedRoute` checks `user.emailVerified`. Unverified user redirected to wizard.

##### E2. Existing users backward compat

**Green:** Migration backfills `email_verified = true` for existing users (done in A1). `onboarding_completed_at` backfilled in A3.

##### E3. Incomplete onboarding redirect

**Red:**
```typescript
describe('OnboardingGuard', () => {
    it('redirects to wizard step 2 if profile not complete', () => { ... });
    it('allows access to dashboard if onboarding complete', () => { ... });
});
```

**Green:** `ProtectedRoute` checks `user.onboardingCompletedAt`. If null â†’ redirect to `/register` and resume from `user.onboardingStep`.

---

### 14. Implementation Order (dependency graph)

```
A1 (migration: email_verified)
 â””â”€â–¶ A4 (shared types)
      â”œâ”€â–¶ B1 (register.start)
      â”‚    â””â”€â–¶ B2 (verify-email)
      â”‚         â”œâ”€â–¶ B4 (onboarding.profile)
      â”‚         â”‚    â””â”€â–¶ B5 (onboarding.devices)
      â”‚         â”‚         â””â”€â–¶ B6 (onboarding.complete)
      â”‚         â”‚              â””â”€â–¶ E1 (auth guard)
      â”‚         â””â”€â–¶ B3 (resend-verification)
      â””â”€â–¶ B8 (MultiRateLimiter) â†â”€â”€ used by B1â€“B3, B7

A2 (migration: waitlist + coming_soon) â”€â”€â–¶ B7 (waitlist.join)
A3 (migration: onboarding_completed_at) â”€â”€â–¶ E3 (onboarding guard)

C0 (EmailSender trait + Fake + Log) â”€â”€â–¶ C1 (email template) â”€â”€â–¶ C2 (Resend impl) + C3 (Log impl) â”€â”€â–¶ B1

D1 (StepIndicator) â”€â”€â–¶ D2 (wizard shell) â”€â”€â–¶ D3..D11 (steps)
D12 (i18n) â†â”€â”€ parallel with D1..D11

E2 (backward compat) â†â”€â”€ after A1 + A3
```

Recommended execution order:
1. **A1 + A2 + A3** â€” all migrations (parallel)
2. **A4** â€” shared types
3. **B8** â€” MultiRateLimiter
4. **C0** â€” EmailSender trait + FakeEmailSender + LogEmailSender
5. **C1 + C2 + C3** â€” verification template + ResendEmailSender + LogEmailSender file output
6. **B1 â†’ B2 â†’ B3** â€” registration flow
7. **B4 â†’ B5 â†’ B6** â€” onboarding handlers
8. **B7** â€” waitlist handler
9. **D1 â†’ D2 â†’ D3 â†’ D4 â†’ D5 â†’ D6 â†’ D7 â†’ D8 â†’ D9 â†’ D10 â†’ D11** â€” frontend
10. **D12** â€” translations (overlaps with D-phase)
11. **E1 + E2 + E3** â€” auth guard + backward compat + onboarding guard

### 15. Decisions (resolved)

| # | Question | Decision |
|---|----------|----------|
| Q1 | Auto-delete unverified users after N days? | **Yes.** Background job purges `WHERE email_verified = false AND created_at < now() - interval '7 days'`. |
| Q2 | Allow email change before verification? | **No.** Changing email means abandoning the current registration and starting a new one. |
| Q3 | Verification link target? | **Option A selected.** Open the Ariadline app directly at `/verify-email?token=...`. Frontend reads token, calls backend verification, stores JWT, then continues wizard at Step 2. No intermediate static confirmation page. |
| Q4 | Password strength beyond min 8? | **Enforced.** Minimum 8 characters + at least 1 uppercase + 1 lowercase + 1 digit. Validated on both frontend (real-time indicator) and backend (reject on submit). |
| Q5 | Depot geocoding mandatory? | **Yes.** See section 8.5 for the detailed geocoding UX flow including rate limiting, loading states, and failure handling. |
| Q6 | "Crew 1" name editable in wizard? | **No.** Auto-created with localized label (i18n key `onboarding_default_crew_name`). Editable later in Settings. |
| Q7 | Slovakia: blocked or available with warning? | **Blocked.** Listed under "Coming soon" alongside any other upcoming countries. "Coming soon" is a **dynamic list** of countries where `coming_soon = true`, not just Slovakia. |
| Q8 | Device type labels â€” Czech only or localized? | **Everything localized.** No Czech-specific hardcoding anywhere. Builtin types use i18n keys (`device_type_chimney`, `device_type_gas_boiler`, etc.). This is a multi-country product from day one. |
| Q9 | Can the user skip the Devices step? | **No.** At least 1 type must be selected. Chimney is pre-selected as the default (target audience: chimney sweepers in Czechia first). The wizard says "You can change this later in Settings." |
| Q10 | Should the wizard be resumable? | **Yes.** JWT is stored after email verification (Step 1). If user returns later, `onboarding_completed_at IS NULL` triggers resume. Resume point is driven by explicit onboarding progress (`onboarding_step`), not inferred from seeded data. |

### 16. Additional Decisions & Implementation Notes

#### 16.1 Answers (from review)

| Topic | Decision |
|-------|----------|
| Depot geocoding NATS subject | **New subject.** Use a dedicated subject for onboarding depot geocoding (e.g. `sazinka.onboarding.geocode.depot`), not the existing geocoding subject. |
| Landing country list | **Exposed.** The list of supported + coming-soon countries is available via a public endpoint (no auth required). |
| Verification token storage | **Stored as hash.** Store `verification_token_hash` in DB (like password reset flows), not the raw token. Compare incoming token by hashing and matching. |
| Crew default name | **Localized.** "Crew 1" must use an i18n key (e.g. `onboarding_default_crew_name`) so it displays correctly in en/cs/sk. |
| Step 1 "Back" button | **Discards form and returns to Landing.** User starts registration from scratch. No partial state is preserved. |

#### 16.2 Suggestions (incorporated)

| Suggestion | Implementation |
|------------|----------------|
| **Anti-enumeration** | `register.start` and `resend-verification` return the same generic success message ("If this email can receive the message, we sent it") regardless of whether the email exists. If the email exists, the backend sends an "Already Registered" email with a login link so legitimate users do not get stuck waiting. |
| **LogEmailSender** | Add `logs/emails.jsonl` to `.gitignore`. Optionally add rotation or max-size limit so the file does not grow unbounded in dev. |
| **Verification link base URL** | Make configurable via `APP_BASE_URL` or `VERIFICATION_BASE_URL`. Dev/staging use `http://localhost:5173` etc.; production uses `https://app.ariadline.cz`. |
| **Lazy loading diagram** | Landing renders: CZ card (static) + Coming Soon list (from public API). Full country picker lazy-loaded only when user clicks "Different country?". |
| **Onboarding Telemetry** | We will track where users drop off (e.g., using Plausible, PostHog, or custom DB tracking). The frontend will emit tracking events at key milestones (Step 1 submit, email verified, Step 3 complete, etc.) to measure funnel conversion. |
| **onboarding_step transitions** | See table 16.4 below. |

#### 16.3 Verification token hash (migration)

See **section 7.1** for the DB migration (`verification_token_hash`). Backend: generate random token, send in email, store `hash(token)` in DB. On verify: hash incoming token, lookup by hash, check expiry.

#### 16.4 onboarding_step transitions

| Handler | Sets `onboarding_step` to |
|---------|---------------------------|
| `verify-email` | 2 (About you) |
| `onboarding.profile` | GREATEST(current, 3) (Devices) |
| `onboarding.devices` | GREATEST(current, 4) (Depot) |
| `onboarding.complete` | 6 (completed) |

Semantics: `0` = pre-verify, `2` = at About you, `3` = at Devices, `4` = at Depot, `5` = at All set, `6` = onboarding completed.

---

*Dokument vytvoÅ™en: 2026-01-31*  
*PoslednÃ­ aktualizace: 2026-02-23 (Phase 10: Onboarding Wizard plan v1.6 â€” fixes + ToS, Leaflet lazy-load, unverified duplicate handling)*

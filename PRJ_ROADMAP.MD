# Project Roadmap - Sazinka v1.0 GA

> **Last Updated:** 2026-02-10 (v0.19.0 - Smart Slot Heuristics)

## Current State Analysis

**Backend (Rust Worker):**
- Customer handlers: 100% complete
- Device handlers: 100% complete âœ…
- Revision handlers: 100% complete âœ…
- Route handlers: 100% complete (planning works)

**Frontend (React):**
- Customers/CustomerDetail: Fully functional + Devices + Timeline âœ…
- Planner: Fully functional + drag/drop + save/load âœ…
- Admin: Fully functional + Export UI âœ…
- Settings: Fully functional (work, business, email, depots) âœ…
- Dashboard: Real stats from revision.stats âœ…
- Calendar: Fully functional with real data âœ…

**Database:** Schema complete for all tables including communications and visits âœ…

**Recent delivery (Export+):**
- Async Export+ processing on worker via JetStream (`SAZINKA_EXPORT_JOBS`) âœ…
- Export status streaming into `Ãšlohy` (`sazinka.job.export.status.*`) âœ…
- Manual download action in Jobs history (`StÃ¡hnout export`) for completed export jobs âœ…
- Export ZIP filename standardized to `export-YYYYMMDD-HHMMSS-XX.zip` with user timezone applied âœ…

---

## Roadmap Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PHASE 1: Core Flow âœ… COMPLETE                       â”‚
â”‚   Device CRUD + Revision CRUD + Dashboard Stats                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE 2: Smart Planning âœ… COMPLETE                     â”‚
â”‚   Functional Calendar + Smart Plan Suggestions + Planner UX + Persistence  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PHASE 3: Users & Communication âœ… COMPLETE               â”‚
â”‚   User (mocked) + Settings UI + Export CSV                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PHASE 4: CRM Evidence âœ… COMPLETE                      â”‚
â”‚   Communication Log + Visits Tracking + Customer Timeline                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PHASE 5: Production Readiness ğŸ“‹ PLANNED                   â”‚
â”‚   5A: Auth + Security (MUST) â†’ 5B: Billing + RLS (SHOULD) â†’ 5C: 2FA (NICE) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PHASE 6: UX Workflow âœ… COMPLETE                       â”‚
â”‚   Call Queue + Schedule Dialog + Day Planner + Smart Slots + Workflow UI   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               PHASE 7: JetStream External Services âœ… COMPLETE               â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ 7A: Valhalla â”‚    â”‚ 7B: Import/  â”‚    â”‚ 7C: Email/   â”‚                 â”‚
â”‚   â”‚  JetStream   â”‚â”€â”€â”€â–¶â”‚   Export     â”‚â”€â”€â”€â–¶â”‚   SMS Jobs   â”‚                 â”‚
â”‚   â”‚  (routing)   â”‚    â”‚   Jobs       â”‚    â”‚   (future)   â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                    â”‚ 7D: Jobs Dashboardâ”‚                                   â”‚
â”‚                    â”‚   (monitoring UI) â”‚                                   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PHASE 8: UX/UI Redesign (Route-Aware Planning) âœ… COMPLETED         â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ 8A: Inbox    â”‚    â”‚ 8B: Route-   â”‚    â”‚ 8C: Route-   â”‚                 â”‚
â”‚   â”‚  Layout +    â”‚â”€â”€â”€â–¶â”‚   Aware per  â”‚â”€â”€â”€â–¶â”‚   Aware for  â”‚                 â”‚
â”‚   â”‚  Context     â”‚    â”‚   Candidate  â”‚    â”‚   Full List  â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                  â”‚                          â”‚
â”‚                                                  â–¼                          â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                                        â”‚ 8D: Multi-Crew   â”‚                â”‚
â”‚                                        â”‚   + Draft Mode   â”‚                â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 1: Core Flow (Devices, Revisions, Dashboard) âœ… COMPLETE

> **Completed:** 2026-01-30

### 1.1 Device Handlers âœ…

**Files created:**
- `worker/src/handlers/device.rs` âœ…
- `worker/src/db/queries/device.rs` âœ…
- `worker/src/types/device.rs` âœ…

**NATS subjects (all implemented):**
- `sazinka.device.create` âœ…
- `sazinka.device.list` âœ…
- `sazinka.device.get` âœ…
- `sazinka.device.update` âœ…
- `sazinka.device.delete` âœ…

### 1.2 Revision Handlers âœ…

**Files created:**
- `worker/src/handlers/revision.rs` âœ…
- `worker/src/db/queries/revision.rs` âœ…
- `worker/src/types/revision.rs` âœ…

**NATS subjects (all implemented):**
- `sazinka.revision.create` âœ…
- `sazinka.revision.list` âœ…
- `sazinka.revision.get` âœ…
- `sazinka.revision.update` âœ…
- `sazinka.revision.complete` âœ…
- `sazinka.revision.upcoming` âœ…
- `sazinka.revision.stats` âœ…

### 1.3 Device Management UI âœ…

**Files created:**
- `apps/web/src/services/deviceService.ts` âœ… (with TDD tests)
- `apps/web/src/components/devices/DeviceList.tsx` âœ…
- `apps/web/src/components/devices/DeviceForm.tsx` âœ…
- `apps/web/src/pages/CustomerDetail.tsx` - Devices section added âœ…

### 1.4 Revision Management UI âœ…

**Files created:**
- `apps/web/src/services/revisionService.ts` âœ… (with TDD tests)
- `apps/web/src/components/revisions/RevisionList.tsx` âœ…
- `apps/web/src/components/revisions/RevisionForm.tsx` âœ…
- `apps/web/src/components/revisions/CompleteRevisionDialog.tsx` âœ…

### 1.5 Dashboard with Real Data âœ…

**Stats displayed:**
- Overdue revisions count (red) âœ…
- Due this week count (yellow) âœ…
- Scheduled today count (green) âœ…
- Completed this month count âœ…

---

## Phase 2: Smart Planning (Calendar, Intelligent Suggestions) âœ… COMPLETE

> **Completed:** 2026-01-30

### 2.1 Functional Calendar âœ…

**Files created:**
- `apps/web/src/pages/Calendar.tsx` - Complete rewrite âœ…
- `apps/web/src/components/calendar/CalendarGrid.tsx` âœ…
- `apps/web/src/components/calendar/DayCell.tsx` âœ…
- `apps/web/src/utils/calendarUtils.ts` âœ… (18 TDD tests)

**Features implemented:**
- Month navigation âœ…
- Display scheduled revisions per day âœ…
- Color coding by revision count/status âœ…
- Click day to see details or navigate to planner âœ…

### 2.2 Smart Plan Suggestion âœ…

**Files created/modified:**
- `worker/src/handlers/revision.rs` - Added handle_suggest âœ…
- `worker/src/db/queries/revision.rs` - Added get_revision_suggestions âœ…
- `worker/src/types/revision.rs` - Added suggestion types âœ…
- `apps/web/src/services/revisionService.ts` - Added getSuggestedRevisions (+4 TDD tests) âœ…
- `apps/web/src/pages/Planner.tsx` - Replaced random selection âœ…

**NATS subject:**
- `sazinka.revision.suggest` âœ…

**Priority scoring implemented:**
| Priority | Score | Criteria |
|----------|-------|----------|
| Overdue | 100 | due_date < today |
| Due this week | 80 | due_date <= today + 7 days |
| Due soon | 60 | due_date <= today + 14 days |
| Due this month | 40 | due_date <= today + 30 days |
| Upcoming | 20 | due_date > today + 30 days |

### 2.3 Planner UX Improvements âœ…

**Files created/modified:**
- `apps/web/src/components/planner/SortableStopItem.tsx` âœ…
- `apps/web/src/components/planner/SortableStopItem.module.css` âœ…
- `apps/web/src/pages/Planner.tsx` - Added DndContext âœ…

**Features implemented:**
- Drag and drop reordering with @dnd-kit âœ…
- Lock/unlock individual stops âœ…
- Visual feedback during drag âœ…
- "Manually reordered" indicator âœ…

### 2.4 Route Persistence âœ…

**Files created/modified:**
- `worker/src/handlers/route.rs` - Added handle_save, handle_get âœ…
- `worker/src/db/queries/route.rs` - Added route_stops queries âœ…
- `apps/web/src/services/routeService.ts` âœ…

**NATS subjects:**
- `sazinka.route.save` - Save planned route âœ…
- `sazinka.route.get` - Load route for date âœ…

**Features implemented:**
- Save current route with stops to database âœ…
- Load saved route for selected date âœ…
- "Load" button appears when saved route exists âœ…
- Last saved timestamp display âœ…

---

## Phase 3: Users, Settings, Communication âœ… COMPLETE

### 3.1 User Authentication & Multi-user Support âœ…

**Status:** Implemented â€” see `PROJECT_MULTIUSER.MD` for full details

**Implementation completed (4 phases):**

1. **DB migration + backend auth** âœ… â€” migration (`role`, `owner_id`), JWT (`argon2` + `jsonwebtoken`), auth handler (`register`, `login`, `verify`), rate limiting, `extract_auth` in all 15 handler files
2. **Frontend auth flow** âœ… â€” auth store (Zustand), Login/Register pages, protected routes with role guards, role-based nav
3. **Removed TEMP_USER_ID** âœ… â€” replaced hardcoded UUID in 22+ frontend files with `getToken()` from auth utility, updated all tests
4. **Worker management** âœ… â€” Customer creates Worker accounts in Settings "PracovnÃ­ci" tab

**Roles:** `admin` (system), `customer` (business owner), `worker` (employee)

**Key decisions:**
- JWT token stored in `localStorage` (NATS.ws has no HTTP headers)
- NATS CRUD subjects unchanged; `user_id` derived from JWT on backend via `extract_auth`
- In-memory rate limiting in auth handler (5 attempts / 5 min)
- No password reset / email confirmation in MVP

**Files created:**
- `worker/src/auth.rs` â€” JWT token generation/validation, password hashing (argon2), `extract_auth` helper âœ…
- `worker/src/handlers/auth.rs` â€” register, login, verify + worker CRUD handlers âœ…
- `worker/src/db/queries/user.rs` â€” user queries (get, get_by_email, create, list_workers, delete_worker) âœ…
- `worker/src/types/user.rs` â€” User, UserPublic, AuthResponse types âœ…
- `worker/migrations/002_add_auth_fields.sql` â€” role + owner_id columns âœ…
- `packages/shared-types/src/auth.ts` â€” LoginRequest, RegisterRequest, UserPublic, AuthResponse âœ…
- `apps/web/src/stores/authStore.ts` â€” Zustand auth state (login, register, logout, verify) âœ…
- `apps/web/src/utils/auth.ts` â€” getToken, getUserId, hasRole helpers âœ…
- `apps/web/src/pages/Login.tsx` + `Login.module.css` âœ…
- `apps/web/src/pages/Register.tsx` âœ…
- `apps/web/src/components/ProtectedRoute.tsx` â€” role-based route guard âœ…
- `apps/web/src/services/workerService.ts` â€” worker CRUD frontend service âœ…

**NATS subjects added:**
- `sazinka.auth.register` âœ…
- `sazinka.auth.login` âœ…
- `sazinka.auth.verify` âœ…
- `sazinka.auth.worker.create` âœ…
- `sazinka.auth.worker.list` âœ…
- `sazinka.auth.worker.delete` âœ…

**Before production (security checklist):**
- [ ] TLS everywhere (NATS + HTTPS)
- [ ] JWT secret in secure storage, min 256-bit, rotation plan
- [ ] Edge rate limiting (Cloudflare / Nginx / Traefik)
- [ ] Audit logs for auth and privileged actions
- [x] Admin-only endpoint hardening (all admin handlers check role) âœ…
- [x] Password policy (min 8 chars, argon2 hash) âœ…
- [ ] CORS restriction for NATS.ws origins
- [ ] DB backups + recovery testing
- [ ] Monitoring & alerting (auth failures, error rates)
### 3.2 User Settings UI âœ…

**Files created:**
- `apps/web/src/pages/Settings.tsx` âœ…
- `apps/web/src/pages/Settings.module.css` âœ…

**Features implemented:**
- Tab-based settings UI âœ…
- Work constraints form (hours, max revisions, service duration) âœ…
- Business info form (name, contact, billing) âœ…
- Email templates form âœ…
- Depots manager (list, add, edit, delete, set primary) âœ…

### 3.3 Export CSV âœ…

**Files created:**
- `apps/web/src/services/exportService.ts` âœ…

**Export types implemented:**
- Customers export (CSV format matching import) âœ…
- Revisions export with date range and status filters âœ…
- Export UI in Admin page âœ…

### 3.4 Basic Email Reminders (Stretch Goal)

**Files to create:**
- `worker/src/services/email.rs` - NEW
- `worker/src/handlers/email.rs` - NEW

**Features:**
- Email templates (Handlebars)
- Resend API integration
- Manual send button per revision
- Communications log

---

## Phase 4: CRM Evidence (Communication & Visits) âœ… COMPLETE

> **Completed:** 2026-01-30

### 4.1 Database Migration âœ…

**File:** `worker/migrations/20260130_000001_crm_enhancements.sql`
- Extended communications table with user_id, contact fields, follow-up tracking âœ…
- Created visits table with scheduling, status, and result tracking âœ…

### 4.2 Communication Handlers âœ…

**Files created:**
- `worker/src/types/communication.rs` âœ…
- `worker/src/handlers/communication.rs` âœ…
- `worker/src/db/queries/communication.rs` âœ…
- `packages/shared-types/src/communication.ts` âœ…
- `apps/web/src/services/communicationService.ts` âœ…

**NATS subjects implemented:**
- `sazinka.communication.create` âœ…
- `sazinka.communication.list` âœ…
- `sazinka.communication.update` âœ…
- `sazinka.communication.delete` âœ…

### 4.3 Visit Handlers âœ…

**Files created:**
- `worker/src/types/visit.rs` âœ…
- `worker/src/handlers/visit.rs` âœ…
- `worker/src/db/queries/visit.rs` âœ…
- `packages/shared-types/src/visit.ts` âœ…
- `apps/web/src/services/visitService.ts` âœ…

**NATS subjects implemented:**
- `sazinka.visit.create` âœ…
- `sazinka.visit.list` âœ…
- `sazinka.visit.update` âœ…
- `sazinka.visit.complete` âœ…
- `sazinka.visit.delete` âœ…

**Visit types (`visit_type`):**
| Type | Description |
|------|-------------|
| `revision` | Regular revision (links to revisions table) |
| `service` | Service call |
| `sales` | Sales meeting |
| `complaint` | Complaint handling |
| `consultation` | Consultation |
| `other` | Other |

### 4.4 Communication UI âœ…

**Files created:**
- `apps/web/src/services/communicationService.ts` âœ…
- Communication forms integrated into CustomerTimeline âœ…

### 4.5 Visit UI âœ…

**Files created:**
- `apps/web/src/services/visitService.ts` âœ…
- Visit forms integrated into CustomerTimeline âœ…

### 4.6 Customer Timeline âœ…

**Files created:**
- `apps/web/src/components/timeline/CustomerTimeline.tsx` âœ…
- `apps/web/src/components/timeline/CustomerTimeline.module.css` âœ…
- `apps/web/src/components/timeline/index.ts` âœ…

**Features implemented:**
- Unified chronological view with communications and visits âœ…
- Add communication form (notes, calls, emails, SMS) âœ…
- Add visit form with scheduling âœ…
- Status badges for visit states âœ…
- Icons for communication types âœ…

### 4.7 Dashboard Enhancements

(Stretch goal - deferred)
- Pending follow-ups count + list
- Today's visits count + list
- This week's visits count

---

## Phase 5: Production Readiness (Public SaaS) ğŸ“‹ PLANNED

> **Status:** Planning phase - required before public launch

### Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 5: Production Readiness                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 5A: Pre-Launch (MUST HAVE)                                           â”‚  â”‚
â”‚   â”‚  â”œâ”€ Authentication (JWT)                                             â”‚  â”‚
â”‚   â”‚  â”œâ”€ TLS on WebSocket                                                 â”‚  â”‚
â”‚   â”‚  â”œâ”€ Rate limiting                                                    â”‚  â”‚
â”‚   â”‚  â”œâ”€ Health checks                                                    â”‚  â”‚
â”‚   â”‚  â”œâ”€ Managed PostgreSQL                                               â”‚  â”‚
â”‚   â”‚  â””â”€ Error tracking (Sentry)                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 5B: Launch (SHOULD HAVE)                                             â”‚  â”‚
â”‚   â”‚  â”œâ”€ Row Level Security                                               â”‚  â”‚
â”‚   â”‚  â”œâ”€ Billing integration (Stripe)                                     â”‚  â”‚
â”‚   â”‚  â”œâ”€ Usage metering                                                   â”‚  â”‚
â”‚   â”‚  â”œâ”€ Uptime monitoring                                                â”‚  â”‚
â”‚   â”‚  â””â”€ Terms of Service + Privacy Policy                                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 5C: Post-Launch (NICE TO HAVE)                                       â”‚  â”‚
â”‚   â”‚  â”œâ”€ 2FA/MFA                                                          â”‚  â”‚
â”‚   â”‚  â”œâ”€ OAuth providers                                                  â”‚  â”‚
â”‚   â”‚  â”œâ”€ Full observability stack                                         â”‚  â”‚
â”‚   â”‚  â”œâ”€ GDPR compliance tools                                            â”‚  â”‚
â”‚   â”‚  â””â”€ Advanced audit logging                                           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5A: Pre-Launch (MUST HAVE) ğŸ”´

#### 5A.1 Authentication & Authorization âœ… IMPLEMENTED

**Current state:** JWT-based auth with login/register/verify, role-based access control, TEMP_USER_ID removed

**Files created (see Phase 3.1 for full list):**
- `worker/src/auth.rs` â€” JWT + argon2 password hashing âœ…
- `worker/src/handlers/auth.rs` â€” auth handlers + rate limiting âœ…
- `apps/web/src/pages/Login.tsx` â€” Login form âœ…
- `apps/web/src/pages/Register.tsx` â€” Registration form âœ…
- `apps/web/src/stores/authStore.ts` â€” JWT storage in localStorage âœ…

**Implemented features:**
| Feature | Status | Description |
|---------|--------|-------------|
| JWT login | âœ… | Email + password â†’ JWT token (15 min expiry) |
| Registration | âœ… | Self-service customer registration |
| Token verification | âœ… | Verify stored token on page load |
| Password hashing | âœ… | argon2 |
| Rate limiting | âœ… | In-memory, 5 attempts / 5 min per email |
| Role-based access | âœ… | admin, customer, worker roles |
| Admin hardening | âœ… | All admin endpoints check role |
| Worker management | âœ… | Customer creates/deletes worker accounts |
| Session invalidation | âœ… | Logout clears localStorage token |

**Not in MVP (deferred):**
- JWT refresh token rotation
- Password reset (email-based)
- Email confirmation

#### 5A.2 TLS on WebSocket

**Current state:** NATS WebSocket without encryption (warning in logs)

**Solution options:**
1. **Cloudflare Tunnel** (recommended) - Zero-config TLS termination
2. **nginx reverse proxy** - `proxy_pass` to NATS with SSL cert
3. **Native NATS TLS** - Configure certs in `nats-server.conf`

**Files to modify:**
- `infra/docker-compose.yml` - Add nginx or configure NATS TLS
- `infra/nginx.conf` - NEW (if using nginx)

#### 5A.3 Rate Limiting

**Current state:** Only geocoding has rate limiting

**Implementation:**
- Per-handler rate limits in Rust (token bucket algorithm)
- Or: nginx `limit_req_zone` directive

**Limits to implement:**
| Endpoint | Limit | Window |
|----------|-------|--------|
| `auth.login` | 5 | 1 min |
| `customer.*` | 100 | 1 min |
| `route.plan` | 10 | 1 min |
| `geocode.*` | 20 | 1 min |

#### 5A.4 Health Checks

**Current state:** Only `sazinka.ping` handler exists

**Endpoints to add:**
- `GET /health` - Basic liveness (HTTP, not NATS)
- `GET /ready` - Readiness (DB connected, services up)

**Files to create:**
- `worker/src/http_server.rs` - Minimal HTTP server for health checks

#### 5A.5 Managed PostgreSQL

**Current state:** Local Docker PostgreSQL

**Recommended providers:**
| Provider | Free tier | Backups | Notes |
|----------|-----------|---------|-------|
| **Neon** | 0.5 GB | Daily | Serverless, auto-scaling |
| **Supabase** | 500 MB | Daily | Includes auth (alternative) |
| **Railway** | $5 credit | Manual | Simple setup |

**Migration steps:**
1. Export schema and data
2. Update `DATABASE_URL` in production
3. Test connection from VPS

#### 5A.6 Error Tracking

**Current state:** File-based logging only

**Solution:** Sentry (free tier: 5K errors/month)

**Files to modify:**
- `worker/Cargo.toml` - Add `sentry` crate
- `worker/src/main.rs` - Initialize Sentry
- `apps/web/package.json` - Add `@sentry/react`
- `apps/web/src/main.tsx` - Initialize Sentry

---

### 5B: Launch (SHOULD HAVE) ğŸŸ¡

#### 5B.1 Row Level Security (RLS)

**Purpose:** Database-level tenant isolation

**Migration:**
```sql
-- Enable RLS on all tenant tables
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE devices ENABLE ROW LEVEL SECURITY;
ALTER TABLE revisions ENABLE ROW LEVEL SECURITY;
-- etc.

-- Create policies
CREATE POLICY tenant_isolation ON customers
    USING (user_id = current_setting('app.current_user_id')::uuid);
```

**Worker modification:**
```rust
// Set user context before each query
sqlx::query("SET app.current_user_id = $1")
    .bind(user_id)
    .execute(&pool)
    .await?;
```

#### 5B.2 Billing Integration

**Provider:** Stripe (recommended for simplicity)

**Database tables:**
```sql
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    plan_id VARCHAR(50) NOT NULL, -- 'free', 'basic', 'pro'
    status VARCHAR(20) NOT NULL,  -- 'active', 'canceled', 'past_due'
    current_period_end TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE usage_records (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    metric VARCHAR(50) NOT NULL, -- 'customers', 'geocoding', 'routes'
    count INTEGER NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL
);
```

**Plan limits:**
| Plan | Customers | Routes/day | Geocoding/month |
|------|-----------|------------|-----------------|
| Free | 50 | 5 | 100 |
| Basic | 500 | 20 | 1,000 |
| Pro | Unlimited | Unlimited | 10,000 |

#### 5B.3 Usage Metering

**Metrics to track:**
- `customers_count` - Total customers per user
- `routes_planned` - Routes planned per day
- `geocoding_requests` - Geocoding API calls per month
- `storage_bytes` - Future: attachments storage

**Implementation:**
- Increment counters in handlers
- Check limits before operations
- Return `LIMIT_EXCEEDED` error when over quota

#### 5B.4 Uptime Monitoring

**Services:**
- **UptimeRobot** (free: 50 monitors) - HTTP health checks
- **Better Stack** (free tier) - Incident management

**Monitors to create:**
- Frontend availability
- NATS WebSocket connectivity
- Health endpoint response time

#### 5B.5 Legal Documents

**Required documents:**
- Terms of Service (ToS)
- Privacy Policy
- Cookie Policy (if using cookies)
- Data Processing Agreement (DPA) for B2B

**Implementation:**
- Static pages in frontend
- Consent checkbox on signup

---

### 5C: Post-Launch (NICE TO HAVE) ğŸŸ¢

#### 5C.1 Two-Factor Authentication (2FA)

**Options:**
- TOTP (Google Authenticator, Authy)
- SMS (via Twilio)
- Email OTP

**Files to create:**
- `worker/src/services/totp.rs` - TOTP generation/verification
- `apps/web/src/components/auth/TwoFactorSetup.tsx`

#### 5C.2 OAuth Providers

**Providers to consider:**
- Google (most common)
- Microsoft (for B2B)
- Apple (for future mobile app)

**Library:** `oauth2` crate for Rust

#### 5C.3 Full Observability Stack

**Components:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Observability Stack                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚ Worker      â”‚â”€â”€â”€â–¶â”‚ Vector      â”‚â”€â”€â”€â–¶â”‚ Loki (logs)             â”‚â”‚
â”‚   â”‚ NATS        â”‚    â”‚             â”‚    â”‚ Prometheus (metrics)    â”‚â”‚
â”‚   â”‚ PostgreSQL  â”‚    â”‚             â”‚    â”‚ Tempo (traces)          â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚              â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                          â”‚ Grafana             â”‚   â”‚
â”‚                                          â”‚ - Dashboards        â”‚   â”‚
â”‚                                          â”‚ - Alerting          â”‚   â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Rust crates:**
- `tracing-opentelemetry` - Distributed tracing
- `metrics` + `metrics-exporter-prometheus` - Metrics export

#### 5C.4 GDPR Compliance

**Features to implement:**
- **Data export** - Full user data in JSON/ZIP
- **Data deletion** - "Right to be forgotten" (partial implementation: customer anonymization flow for soft delete + PII anonymization in linked records)
- **Consent management** - Track what user agreed to
- **Audit trail** - Who accessed what when

**Database tables:**
```sql
CREATE TABLE audit_log (
    id UUID PRIMARY KEY,
    user_id UUID,
    action VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50),
    entity_id UUID,
    old_value JSONB,
    new_value JSONB,
    ip_address INET,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE user_consents (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    consent_type VARCHAR(50) NOT NULL,
    granted BOOLEAN NOT NULL,
    granted_at TIMESTAMPTZ,
    revoked_at TIMESTAMPTZ
);
```

---

### Production Architecture Target

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Production Architecture                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚   â”‚ Cloudflare       â”‚  - CDN for static assets                             â”‚
â”‚   â”‚ (Edge)           â”‚  - TLS termination                                   â”‚
â”‚   â”‚                  â”‚  - DDoS protection                                   â”‚
â”‚   â”‚                  â”‚  - WAF rules                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚   â”‚ NATS Cluster     â”‚â—€â”€â”€â”€â”€â–¶â”‚ Worker Cluster   â”‚                           â”‚
â”‚   â”‚ (2+ nodes)       â”‚      â”‚ (2+ instances)   â”‚                           â”‚
â”‚   â”‚ + JetStream      â”‚      â”‚ + Health checks  â”‚                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                      â”‚                                      â”‚
â”‚                                      â–¼                                      â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                            â”‚ Managed PostgreSQLâ”‚                            â”‚
â”‚                            â”‚ (Neon/Supabase)  â”‚                             â”‚
â”‚                            â”‚ + Auto backups   â”‚                             â”‚
â”‚                            â”‚ + RLS enabled    â”‚                             â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚   â”‚ Valhalla         â”‚      â”‚ Nominatim        â”‚                           â”‚
â”‚   â”‚ (self-hosted)    â”‚      â”‚ (self-hosted)    â”‚                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ External Services                                                     â”‚ â”‚
â”‚   â”‚  â”œâ”€ Stripe (billing)                                                 â”‚ â”‚
â”‚   â”‚  â”œâ”€ Sentry (error tracking)                                          â”‚ â”‚
â”‚   â”‚  â”œâ”€ Resend (emails)                                                  â”‚ â”‚
â”‚   â”‚  â””â”€ UptimeRobot (monitoring)                                         â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

---

## Phase 6: UX Workflow (Call Queue, Smart Scheduling) âœ… COMPLETE

> **Status:** All MVP phases complete (6A-6F)
> **Reference:** See `PROJECT_UX.MD` for full wireframes and concepts

### Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE 6: UX Workflow                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6A: Call Queue (MVP)                                                 â”‚  â”‚
â”‚   â”‚  â”œâ”€ Fronta k obvolÃ¡nÃ­ (revize v oknÄ› 11-12 mÄ›sÃ­cÅ¯)                  â”‚  â”‚
â”‚   â”‚  â”œâ”€ Filtry: oblast, typ sluÅ¾by, priorita                            â”‚  â”‚
â”‚   â”‚  â”œâ”€ Quick actions: Zavolat, OdloÅ¾it, Domluvit                       â”‚  â”‚
â”‚   â”‚  â””â”€ snooze_until pole pro odloÅ¾enÃ­                                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6B: Schedule Dialog (MVP)                                            â”‚  â”‚
â”‚   â”‚  â”œâ”€ VÃ½bÄ›r dne + ÄasovÃ©ho okna                                       â”‚  â”‚
â”‚   â”‚  â”œâ”€ PÅ™iÅ™azenÃ­ posÃ¡dky/technika                                      â”‚  â”‚
â”‚   â”‚  â”œâ”€ DÃ©lka Ãºkonu (default z device type)                             â”‚  â”‚
â”‚   â”‚  â””â”€ UloÅ¾enÃ­ do Revision (scheduled_date, time_window)               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6C: Enhanced Day Planner (MVP)                                       â”‚  â”‚
â”‚   â”‚  â”œâ”€ Seznam zastÃ¡vek s ÄasovÃ½mi okny                                 â”‚  â”‚
â”‚   â”‚  â”œâ”€ VarovÃ¡nÃ­ konfliktÅ¯ (ÄervenÃ©/Å¾lutÃ©)                              â”‚  â”‚
â”‚   â”‚  â”œâ”€ Crew tabs (multi-crew)                                           â”‚  â”‚
â”‚   â”‚  â””â”€ Day load indicator                                               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6D: Technician View (MVP)                                            â”‚  â”‚
â”‚   â”‚  â”œâ”€ MÅ¯j dneÅ¡nÃ­ plÃ¡n (mobile-friendly)                               â”‚  â”‚
â”‚   â”‚  â”œâ”€ Per-stop: Navigovat, Volat, Hotovo, NezastiÅ¾en                  â”‚  â”‚
â”‚   â”‚  â””â”€ Export: segmented Google Maps + PDF                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 6E: Smart Slots (V2)                                                 â”‚  â”‚
â”‚   â”‚  â”œâ”€ Insertion heuristic algoritmus                                   â”‚  â”‚
â”‚   â”‚  â”œâ”€ Valhalla matrix cache per den/posÃ¡dka                           â”‚  â”‚
â”‚   â”‚  â”œâ”€ 3-5 doporuÄenÃ½ch slotÅ¯ pÅ™i domluvÄ›                              â”‚  â”‚
â”‚   â”‚  â””â”€ Vizualizace dopadu na trasu (+X min)                            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6A: Call Queue (Fronta k obvolÃ¡nÃ­)

**Database changes:**
```sql
ALTER TABLE revisions ADD COLUMN snooze_until DATE;
ALTER TABLE revisions ADD COLUMN snooze_reason VARCHAR(255);
```

**NATS subjects:**
- `sazinka.revision.queue` - List revisions in due window
- `sazinka.revision.snooze` - Postpone revision

**Files to create:**
- [x] `worker/src/db/queries/revision.rs` - Add queue query âœ…
- [x] `apps/web/src/pages/CallQueue.tsx` - NEW âœ…
- [x] `apps/web/src/pages/CallQueue.module.css` - NEW âœ…
- [x] Queue item inline in CallQueue.tsx (no separate component needed)

**Query logic:**
```sql
SELECT r.*, c.*, d.*
FROM revisions r
JOIN customers c ON r.customer_id = c.id
JOIN devices d ON r.device_id = d.id
WHERE r.user_id = $1
  AND r.status IN ('upcoming', 'scheduled')
  AND r.scheduled_date IS NULL  -- not yet scheduled
  AND (r.snooze_until IS NULL OR r.snooze_until <= CURRENT_DATE)
  AND r.due_date BETWEEN CURRENT_DATE - INTERVAL '30 days' 
                     AND CURRENT_DATE + INTERVAL '60 days'
ORDER BY 
  CASE WHEN r.due_date < CURRENT_DATE THEN 0 ELSE 1 END,  -- overdue first
  r.due_date ASC
```

---

### 6B: Schedule Dialog

**Database changes:**
```sql
ALTER TABLE revisions ADD COLUMN assigned_crew_id UUID;
ALTER TABLE revisions ADD COLUMN route_order INTEGER;

CREATE TABLE crews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  name VARCHAR(100) NOT NULL,
  home_depot_id UUID REFERENCES depots(id),
  preferred_areas TEXT[],
  working_hours_start TIME DEFAULT '08:00',
  working_hours_end TIME DEFAULT '17:00',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**NATS subjects:**
- `sazinka.crew.create` - Create crew
- `sazinka.crew.list` - List crews
- `sazinka.crew.update` - Update crew
- `sazinka.crew.delete` - Delete crew

**Files to create:**
- [x] `worker/src/types/crew.rs` - NEW âœ…
- [x] `worker/src/handlers/crew.rs` - NEW âœ…
- [x] `worker/src/db/queries/crew.rs` - NEW âœ…
- [x] `apps/web/src/services/crewService.ts` - NEW âœ…
- [x] Schedule dialog inline in CallQueue.tsx âœ…

---

### 6C: Enhanced Day Planner

**Enhancements to existing Planner:**
- ~~Crew tabs (select which crew's route to view/edit)~~ (pending)
- ~~Time window display per stop~~ (pending)
- ~~Conflict warnings (time window violations)~~ (pending)
- ~~Day load indicator (total service time + travel time)~~ (pending)
- [x] View tabs: "DoporuÄenÃ©" / "NaplÃ¡novanÃ©" âœ…
- [x] Load scheduled revisions for selected date âœ…

**Files modified:**
- [x] `apps/web/src/pages/Planner.tsx` - Added view tabs, scheduled revisions âœ…
- [x] `apps/web/src/pages/Planner.module.css` - Tab styles âœ…

**Calendar enhancements:**
- [x] View mode toggle: "TermÃ­ny" (due_date) / "NaplÃ¡novanÃ©" (scheduled_date) âœ…
- [x] `apps/web/src/pages/Calendar.tsx` - Added view toggle âœ…
- [x] `apps/web/src/utils/calendarUtils.ts` - groupRevisionsByDay with dateField param âœ…

---

### 6D: Technician View âœ… (MERGED INTO PLANNER)

**Status:** TechnicianDay functionality merged into unified Planner page (`/planner`)

**Files removed:**
- `apps/web/src/pages/TechnicianDay.tsx` - âŒ Deleted (merged into Planner)
- `apps/web/src/pages/TechnicianDay.module.css` - âŒ Deleted
- Route `/today` now redirects to `/planner`
- Navigation link "MÅ¯j den" removed, "PlÃ¡novÃ¡nÃ­" renamed to "PlÃ¡n dne"

**Features now in Planner:**
- [x] Segmented Google Maps links (8 stops per segment) âœ…
- [x] Print/PDF with addresses, phones, time windows âœ…
- [x] Single-stop navigation buttons âœ…
- [x] Mark as done action per stop âœ…
- [x] Call customer action per stop âœ…
- [x] Progress tracking (X/Y done) âœ…

**Backend enhancements:**
- [x] `Revision` type extended with customer info fields âœ…
- [x] `list_revisions` query joins customer table âœ…

---

### 6E: Smart Slots (V2) âœ…

**NATS subject:**
- [x] `sazinka.slots.suggest` - Get best slots for new appointment âœ…

**Algorithm (insertion heuristic) - TDD implemented:**
1. [x] Load existing scheduled revisions for day âœ…
2. [x] Try inserting at each position in route âœ…
3. [x] Calculate delta travel time (Euclidean estimate) âœ…
4. [x] Check feasibility (work hours) âœ…
5. [x] Score: 60% delta time + 25% preferred time + 15% slack âœ…
6. [x] Return top N slots sorted by score âœ…

**Files created:**
- [x] `worker/src/services/slot_suggester.rs` - Algorithm with 8 unit tests âœ…
- [x] `worker/src/handlers/slots.rs` - NATS handler âœ…
- [x] `apps/web/src/services/slotService.ts` - Frontend service âœ…
- [x] CallQueue.tsx - Smart slot suggestions in schedule modal âœ…

---

### 6F: Workflow UI Integration (MVP) âœ…

**Goal:** Connect isolated pages into a single end-to-end flow.

**Completed UI tasks:**
- [x] Dashboard CTA: "Fronta k obvolÃ¡nÃ­" as primary entry âœ…
- [x] Clickable stats on Dashboard â†’ prefiltered Call Queue or Calendar âœ…
- [x] Call Queue: after scheduling, jump to Planner on that date âœ…
- [x] Call Queue: add links to Customer detail + Revision detail âœ…
- [x] Calendar day panel: link each revision to Revision detail âœ…
- [x] Planner: merged with TechnicianDay into unified "PlÃ¡n dne" âœ…
- [x] Planner: show customer + address + time window + actions âœ…
- [x] Planner: call queue preview section âœ…
- [x] RevisionDetail page created as workflow hub âœ…

**New UI surfaces created:**
- [x] `RevisionDetail` page (`/revisions/:id`) - context hub for workflow actions âœ…
- [x] Unified `Planner` page with TechnicianDay features âœ…

**Files created/modified:**
- [x] `apps/web/src/pages/RevisionDetail.tsx` âœ…
- [x] `apps/web/src/pages/RevisionDetail.module.css` âœ…
- [x] `apps/web/src/pages/Planner.tsx` - merged with TechnicianDay âœ…
- [x] `apps/web/src/components/planner/SortableStopItem.tsx` - added actions âœ…
- [x] `apps/web/src/routes/index.tsx` - updated routing âœ…
- [x] `apps/web/src/components/Layout.tsx` - updated navigation âœ…

---

## Phase 7: JetStream External Services ğŸ“‹ PLANNED

> **Status:** Planning - independent of Phase 5, high priority for scalability
> **Goal:** Serialize ALL external service communication through NATS JetStream

### Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PHASE 7: JetStream External Services                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 7A: Valhalla JetStream (Routing)                                     â”‚  â”‚
â”‚   â”‚  â”œâ”€ SAZINKA_ROUTING_MATRIX_JOBS - distance/time matrices            â”‚  â”‚
â”‚   â”‚  â”œâ”€ SAZINKA_ROUTING_GEOMETRY_JOBS - route polylines                 â”‚  â”‚
â”‚   â”‚  â””â”€ Automatic retry on Valhalla timeout (max_deliver: 3)            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 7B: Import/Export Jobs                                               â”‚  â”‚
â”‚   â”‚  â”œâ”€ SAZINKA_IMPORT_JOBS - async CSV imports (device, revision, etc) â”‚  â”‚
â”‚   â”‚  â”œâ”€ SAZINKA_EXPORT_JOBS - async CSV exports with progress           â”‚  â”‚
â”‚   â”‚  â””â”€ Real-time progress updates via status subjects                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 7C: Email/SMS Jobs (Future)                                          â”‚  â”‚
â”‚   â”‚  â”œâ”€ SAZINKA_EMAIL_JOBS - revision reminders, notifications          â”‚  â”‚
â”‚   â”‚  â”œâ”€ SAZINKA_SMS_JOBS - SMS notifications                            â”‚  â”‚
â”‚   â”‚  â””â”€ Prepared skeleton for Resend API / Twilio integration           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 7D: Unified Jobs Dashboard                                           â”‚  â”‚
â”‚   â”‚  â”œâ”€ Admin UI for monitoring all active jobs                         â”‚  â”‚
â”‚   â”‚  â”œâ”€ Cancel/retry actions                                            â”‚  â”‚
â”‚   â”‚  â””â”€ Queue statistics and health                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Motivation

**Current state:**
- Nominatim - already uses JetStream (3 streams) âœ…
- Valhalla - direct HTTP calls (synchronous) âŒ
- Imports - synchronous request/response âŒ
- Exports - synchronous CSV generation âŒ

**Problems with synchronous approach:**
- No backpressure under load â†’ external services overloaded
- No automatic retry on temporary failures
- Cannot horizontally scale workers
- Job loss on worker restart

---

### 7A: Valhalla JetStream (Routing)

**JetStream Streams:**

| Stream | Subject | Consumer | Purpose |
|--------|---------|----------|---------|
| `SAZINKA_ROUTING_MATRIX_JOBS` | `sazinka.jobs.valhalla.matrix` | `matrix_workers` | Distance/time matrices |
| `SAZINKA_ROUTING_GEOMETRY_JOBS` | `sazinka.jobs.valhalla.geometry` | `geometry_workers` | Route polylines |

**Stream Configuration:**
```rust
jetstream::stream::Config {
    name: "SAZINKA_ROUTING_MATRIX_JOBS",
    subjects: vec!["sazinka.jobs.valhalla.matrix"],
    max_messages: 1_000,
    max_bytes: 50 * 1024 * 1024, // 50 MB
    retention: RetentionPolicy::WorkQueue,
    max_deliver: 3, // Retry up to 3 times
}
```

**Files to create:**
- [ ] `worker/src/services/valhalla_processor.rs` - JetStream wrapper for Valhalla
- [ ] `worker/src/types/valhalla_job.rs` - Job types (MatrixJob, GeometryJob)

**Files to modify:**
- [ ] `worker/src/handlers/route.rs` - Use ValhallaProcessor instead of direct calls
- [ ] `worker/src/handlers/mod.rs` - Initialize new processor

**Status subjects:**
- `sazinka.job.valhalla.matrix.status.{job_id}` - Matrix job progress
- `sazinka.job.valhalla.geometry.status.{job_id}` - Geometry job progress

---

### 7B: Import/Export Jobs

**JetStream Streams:**

| Stream | Subject | Consumer | Purpose |
|--------|---------|----------|---------|
| `SAZINKA_IMPORT_JOBS` | `sazinka.jobs.import.*` | `import_workers` | All CSV imports |
| `SAZINKA_EXPORT_JOBS` | `sazinka.jobs.export.*` | `export_workers` | All CSV exports |

**Import job types:**
- `sazinka.jobs.import.device` - Device batch import
- `sazinka.jobs.import.revision` - Revision batch import
- `sazinka.jobs.import.communication` - Communication batch import
- `sazinka.jobs.import.visit` - Visit batch import
- `sazinka.jobs.import.customer` - Customer batch import (new)

**Export job types:**
- `sazinka.jobs.export.customers` - Customer CSV export
- `sazinka.jobs.export.revisions` - Revision CSV export
- `sazinka.jobs.export.report` - Report generation

**Files to create:**
- [ ] `worker/src/services/import_processor.rs` - Async import processor
- [ ] `worker/src/services/export_processor.rs` - Async export processor
- [ ] `worker/src/types/import_job.rs` - Import job types
- [ ] `worker/src/types/export_job.rs` - Export job types

**Files to modify:**
- [ ] `worker/src/handlers/import.rs` - Refactor to async pattern
- [ ] `apps/web/src/services/import/importBatchService.ts` - Use job status subscription

---

### 7C: Email/SMS Jobs (Future)

**JetStream Streams:**

| Stream | Subject | Consumer | Purpose |
|--------|---------|----------|---------|
| `SAZINKA_EMAIL_JOBS` | `sazinka.jobs.email.*` | `email_workers` | Outgoing emails |
| `SAZINKA_SMS_JOBS` | `sazinka.jobs.sms.*` | `sms_workers` | Outgoing SMS |

**Email job types:**
- `sazinka.jobs.email.reminder` - Revision reminder
- `sazinka.jobs.email.confirmation` - Appointment confirmation
- `sazinka.jobs.email.notification` - General notification

**SMS job types:**
- `sazinka.jobs.sms.reminder` - SMS reminder
- `sazinka.jobs.sms.confirmation` - SMS confirmation

**Files to create:**
- [ ] `worker/src/services/email_processor.rs` - Email job processor (Resend API)
- [ ] `worker/src/services/sms_processor.rs` - SMS job processor (Twilio)
- [ ] `worker/src/types/email_job.rs` - Email job types
- [ ] `worker/src/types/sms_job.rs` - SMS job types

---

### 7D: Unified Jobs Dashboard

**Admin UI for job monitoring:**

| Feature | Description |
|---------|-------------|
| Active jobs list | All jobs across all streams |
| Job details | Status, progress, errors |
| Cancel action | Terminate stuck jobs |
| Retry action | Re-queue failed jobs |
| Queue stats | Pending, processing, completed counts |

**NATS subjects:**
- `sazinka.admin.jobs.list` - List all active jobs
- `sazinka.admin.jobs.cancel` - Cancel a job
- `sazinka.admin.jobs.retry` - Retry a failed job
- `sazinka.admin.jobs.stats` - Queue statistics

**Files to create:**
- [ ] `apps/web/src/pages/JobsDashboard.tsx` - Jobs overview page
- [ ] `apps/web/src/components/jobs/JobStatusCard.tsx` - Job status card
- [ ] `apps/web/src/components/jobs/JobQueue.tsx` - Queue list component
- [ ] `apps/web/src/services/jobsAdminService.ts` - Admin service

---

### Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JetStream External Services Architecture                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Frontend                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  UI Component                                                        â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚   â”‚
â”‚   â”‚  â”‚ useJobStatusâ”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€ subscribe to status.{job_id}            â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚   â”‚
â”‚   â”‚        â”‚                                                             â”‚   â”‚
â”‚   â”‚        â”‚ submit job                                                  â”‚   â”‚
â”‚   â”‚        â–¼                                                             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â”‚ NATS request                                                    â”‚
â”‚            â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  NATS JetStream                                                      â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚ ROUTING_MATRIX   â”‚  â”‚ ROUTING_GEOMETRY â”‚  â”‚ GEOCODE_JOBS     â”‚  â”‚   â”‚
â”‚   â”‚  â”‚ _JOBS            â”‚  â”‚ _JOBS            â”‚  â”‚ (existing)       â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚           â”‚                     â”‚                     â”‚            â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚ IMPORT_JOBS      â”‚  â”‚ EXPORT_JOBS      â”‚  â”‚ EMAIL/SMS_JOBS   â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚           â”‚                     â”‚                     â”‚            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â”‚                     â”‚                     â”‚                 â”‚
â”‚               â–¼                     â–¼                     â–¼                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Worker Pool (horizontally scalable)                                â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚ ValhallaProcessorâ”‚  â”‚ ImportProcessor  â”‚  â”‚ EmailProcessor   â”‚  â”‚   â”‚
â”‚   â”‚  â”‚ GeocodeProcessor â”‚  â”‚ ExportProcessor  â”‚  â”‚ SMSProcessor     â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚           â”‚                     â”‚                     â”‚            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â”‚                     â”‚                     â”‚                 â”‚
â”‚               â–¼                     â–¼                     â–¼                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  External Services                                                   â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚ Valhalla     â”‚  â”‚ Nominatim    â”‚  â”‚ Resend API / Twilio      â”‚  â”‚   â”‚
â”‚   â”‚  â”‚ :8002        â”‚  â”‚ :8080        â”‚  â”‚ (external)               â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Benefits

| Benefit | Description |
|---------|-------------|
| **Backpressure** | JetStream queue limits prevent external service overload |
| **Automatic retry** | Failed jobs retry up to 3 times with exponential backoff |
| **Persistence** | Jobs survive worker restart |
| **Horizontal scaling** | Multiple workers can process from the same queue |
| **Observability** | Real-time status updates, unified monitoring |
| **Consistency** | Same pattern for all external services |

---

## Phase 8: UX/UI Redesign (Route-Aware Planning) âœ… COMPLETED

> **Status:** Completed - all components integrated
> **Goal:** "Domluvit nÃ¡vÅ¡tÄ›vu" = jedna Äinnost: vloÅ¾it zakÃ¡zku do trasy s minimem Î”km/Î”min
> **Reference:** See `PROJECT_UX.MD` Phase 8 section for full wireframes and component catalog

### Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PHASE 8: Route-Aware Planning Redesign                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   KlÃ­ÄovÃ¡ zmÄ›na:                                                            â”‚
â”‚   "Domluvit termÃ­n" jiÅ¾ nenÃ­ oddÄ›lenÃ© od plÃ¡novÃ¡nÃ­ trasy.                   â”‚
â”‚   Je to JEDNA Äinnost: vloÅ¾it zakÃ¡zku do dennÃ­ trasy s minimem Î”km/Î”min.   â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 8A: NovÃ½ Inbox Layout + Route Context                                â”‚  â”‚
â”‚   â”‚  â”œâ”€ RouteContextHeader komponenta (den/posÃ¡dka/depo + metriky)      â”‚  â”‚
â”‚   â”‚  â”œâ”€ 3-panel layout (desktop), stack layout (mobil)                  â”‚  â”‚
â”‚   â”‚  â”œâ”€ Mapa s trasou dne                                               â”‚  â”‚
â”‚   â”‚  â””â”€ Metriky kapacity (km, Äas, load, slack)                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 8B: Route-Aware pro vybranÃ©ho kandidÃ¡ta                              â”‚  â”‚
â”‚   â”‚  â”œâ”€ Î”km/Î”min vÃ½poÄet pÅ™i vÃ½bÄ›ru kandidÃ¡ta                           â”‚  â”‚
â”‚   â”‚  â”œâ”€ SlotSuggestions komponenta s dopady                             â”‚  â”‚
â”‚   â”‚  â”œâ”€ InsertionPreview na mapÄ›                                        â”‚  â”‚
â”‚   â”‚  â””â”€ Valhalla 1Ã—K + KÃ—1 matrix strategie                             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 8C: Route-Aware pro celÃ½ list                                        â”‚  â”‚
â”‚   â”‚  â”œâ”€ Lazy loading pro viditelnÃ© Å™Ã¡dky                                â”‚  â”‚
â”‚   â”‚  â”œâ”€ Cache vÃ½sledkÅ¯ (klÃ­Ä: den+posÃ¡dka+kandidÃ¡t+verze_trasy)         â”‚  â”‚
â”‚   â”‚  â”œâ”€ "ProblÃ©my" segment (nelze geo, chybÃ­ tel)                       â”‚  â”‚
â”‚   â”‚  â””â”€ Pre-ranking dle vzdÃ¡lenosti k trase                             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 8D: Multi-Crew + Draft Mode + Polish                                 â”‚  â”‚
â”‚   â”‚  â”œâ”€ Tipy "PosÃ¡dka 2 je lepÅ¡Ã­ o 10 min"                               â”‚  â”‚
â”‚   â”‚  â”œâ”€ Draft mode pro plÃ¡n dne                                         â”‚  â”‚
â”‚   â”‚  â”œâ”€ Optimistic UI                                                   â”‚  â”‚
â”‚   â”‚  â””â”€ KlÃ¡vesovÃ© zkratky pro dispeÄerku                                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 8A: NovÃ½ Inbox Layout + Route Context

**CÃ­l:** DispeÄerka vidÃ­ "plÃ¡novÃ¡nÃ­ s mapou a kapacitou" od zaÄÃ¡tku.

**Komponenty k vytvoÅ™enÃ­:**

| Komponenta | Popis | UmÃ­stÄ›nÃ­ |
|------------|-------|----------|
| `RouteContextHeader` | Sticky header: Den/PosÃ¡dka/Depo + metriky | `components/planner/` |
| `SplitView` | 3-panel layout pro desktop | `components/common/` |
| `CapacityMetrics` | ZobrazenÃ­ km/Äas/load/slack | `components/planner/` |
| `RouteMapPanel` | Mapa s trasou dne | `components/planner/` |

**Files to create:**
- [ ] `apps/web/src/components/planner/RouteContextHeader.tsx`
- [ ] `apps/web/src/components/planner/RouteContextHeader.module.css`
- [ ] `apps/web/src/components/common/SplitView.tsx`
- [ ] `apps/web/src/components/planner/CapacityMetrics.tsx`
- [ ] `apps/web/src/pages/PlanningInbox.tsx` - New unified inbox page
- [ ] `apps/web/src/pages/PlanningInbox.module.css`

**Files to modify:**
- [ ] `apps/web/src/routes/index.tsx` - Add `/inbox` route
- [ ] `apps/web/src/components/Layout.tsx` - Update navigation

**Metriky v headeru:**
```
51 km â€¢ jÃ­zda 1h16 â€¢ servis 5h30 â€¢ vytÃ­Å¾enÃ­ 92% âš  â€¢ rezerva 18 min âš 
```

**ASCII wireframe (desktop):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlÃ¡novacÃ­ inbox  Den[St 5.3] PosÃ¡dka[1] Depo[Brno]  Route-aware[ON]     â”‚
â”‚ 51 km â€¢ jÃ­zda 1h16 â€¢ vytÃ­Å¾enÃ­ 92%âš  â€¢ rezerva 18mâš                         â”‚
â”‚ [Po termÃ­nu(12)] [TÃ½den(18)] [30 dnÃ­(43)] [VÅ¡e] [OdloÅ¾enÃ©] [ProblÃ©my]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ INBOX LIST    â”‚ MAPA + TRASA DNE                           â”‚ DETAIL      â”‚
â”‚ (kandidÃ¡ti)   â”‚ (polyline + piny)                          â”‚ (sloty+CTA) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 8B: Route-Aware pro vybranÃ©ho kandidÃ¡ta

**CÃ­l:** Po kliknutÃ­ na kandidÃ¡ta ukÃ¡zat Î”km/Î”min a doporuÄenÃ© sloty.

**Komponenty k vytvoÅ™enÃ­:**

| Komponenta | Popis | UmÃ­stÄ›nÃ­ |
|------------|-------|----------|
| `CandidateRow` | Å˜Ã¡dek v inboxu s metrikami | `components/planner/` |
| `CandidateDetail` | Detail panel s akcemi | `components/planner/` |
| `SlotSuggestions` | 3-5 doporuÄenÃ½ch slotÅ¯ | `components/planner/` |
| `InsertionPreview` | "VloÅ¾Ã­ se mezi 3â†’4" | `components/planner/` |

**Backend changes:**

| Endpoint | Popis |
|----------|-------|
| `sazinka.slots.suggest.route` | RozÅ¡Ã­Å™it o Î”km/Î”min vÃ½poÄet |
| `sazinka.route.insertion.preview` | NovÃ½ endpoint pro insertion preview |

**Matrix strategie (1Ã—K + KÃ—1):**
```rust
// MÃ­sto KÃ—K matice, pouze:
// - t(Si, X) pro vÅ¡echna Si (many-to-one)
// - t(X, Si) pro vÅ¡echna Si (one-to-many)
// = 2K vÃ½poÄtÅ¯ mÃ­sto KÂ²
```

**Files to create:**
- [ ] `apps/web/src/components/planner/CandidateRow.tsx`
- [ ] `apps/web/src/components/planner/CandidateDetail.tsx`
- [ ] `apps/web/src/components/planner/SlotSuggestions.tsx`
- [ ] `apps/web/src/components/planner/InsertionPreview.tsx`
- [ ] `apps/web/src/services/insertionService.ts`

**Files to modify:**
- [ ] `worker/src/services/slot_suggester.rs` - Add Î”km/Î”min calculation
- [ ] `worker/src/handlers/slots.rs` - Return insertion metrics

---

### 8C: Route-Aware pro celÃ½ list

**CÃ­l:** CelÃ½ inbox seÅ™azenÃ½ dle "best insertion" s lazy loading.

**Strategie:**
1. **LevnÃ½ pre-ranking** pro celÃ½ list (vzdÃ¡lenost k trase)
2. **PÅ™esnÃ½ vÃ½poÄet** jen pro viditelnÃ© Å™Ã¡dky + prefetch
3. **Cache** vÃ½sledkÅ¯ s invalidacÃ­ pÅ™i zmÄ›nÄ› trasy

**Komponenty k vytvoÅ™enÃ­:**

| Komponenta | Popis |
|------------|-------|
| `VirtualizedInboxList` | react-virtuoso pro 500+ Å™Ã¡dkÅ¯ |
| `ProblemsSegment` | KandidÃ¡ti s problÃ©my (geo, tel) |

**Cache implementace:**
```typescript
interface RouteCacheKey {
  date: string;
  crewId: string;
  candidateId: string;
  routeVersion: number;
}
```

**Files to create:**
- [ ] `apps/web/src/components/planner/VirtualizedInboxList.tsx`
- [ ] `apps/web/src/components/planner/ProblemsSegment.tsx`
- [ ] `apps/web/src/stores/routeCacheStore.ts`

**Files to modify:**
- [ ] `apps/web/src/pages/PlanningInbox.tsx` - Integrate virtualization
- [ ] `worker/src/db/queries/revision.rs` - Add pre-ranking query

---

### 8D: Multi-Crew + Draft Mode + Polish

**CÃ­l:** FinÃ¡lnÃ­ polish pro GA release.

**Multi-crew tipy:**
```
PodmÃ­nky pro zobrazenÃ­:
- RozdÃ­l > 10 min NEBO > 5 km
- Jen pro vybranÃ©ho kandidÃ¡ta
- Max 2 alternativnÃ­ posÃ¡dky

UI: "Tip: PosÃ¡dka 2 (+2 min)" - ne spam
```

**Draft mode pro plÃ¡n dne:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš  NeuloÅ¾enÃ© zmÄ›ny                      â”‚
â”‚ [Zahodit zmÄ›ny]  [UloÅ¾it]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**KlÃ¡vesovÃ© zkratky:**

| Zkratka | Akce |
|---------|------|
| `/` | Focus search |
| `â†‘â†“` | Navigace v listu |
| `1-5` | VÃ½bÄ›r slotu |
| `D` | Domluvit |
| `O` | OdloÅ¾it |
| `E` | Opravit adresu |
| `Esc` | ZavÅ™Ã­t panel |

**Files to create:**
- [ ] `apps/web/src/components/planner/MultiCrewTip.tsx`
- [ ] `apps/web/src/components/planner/DraftModeBar.tsx`
- [ ] `apps/web/src/hooks/useKeyboardShortcuts.ts`

**Files to modify:**
- [ ] `apps/web/src/pages/Planner.tsx` - Add draft mode
- [ ] `apps/web/src/pages/PlanningInbox.tsx` - Add keyboard shortcuts

---

### Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Route-Aware Planning Architecture                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Frontend                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  PlanningInbox                                                       â”‚   â”‚
â”‚   â”‚  â”œâ”€ RouteContextHeader (den/posÃ¡dka/depo + metriky)                 â”‚   â”‚
â”‚   â”‚  â”œâ”€ VirtualizedInboxList (kandidÃ¡ti s Î”km/Î”min)                     â”‚   â”‚
â”‚   â”‚  â”œâ”€ RouteMapPanel (polyline + piny + insertion preview)             â”‚   â”‚
â”‚   â”‚  â””â”€ CandidateDetail (sloty + CTA)                                   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â”‚ NATS                                                            â”‚
â”‚            â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Worker                                                              â”‚   â”‚
â”‚   â”‚  â”œâ”€ SlotSuggester (Î”km/Î”min calculation)                            â”‚   â”‚
â”‚   â”‚  â”‚   â””â”€ 1Ã—K + KÃ—1 matrix strategy                                   â”‚   â”‚
â”‚   â”‚  â”œâ”€ InsertionPreview (route recalc)                                 â”‚   â”‚
â”‚   â”‚  â””â”€ RouteCache (invalidation on change)                             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Valhalla                                                            â”‚   â”‚
â”‚   â”‚  â””â”€ sources_to_targets (1Ã—K + KÃ—1, ne KÃ—K)                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Performance Targets

| Operace | CÃ­lovÃ¡ latence | PoznÃ¡mka |
|---------|----------------|----------|
| UI highlight kandidÃ¡ta | â‰¤150ms | Jen UI, bez API |
| Slot suggestions | 400-700ms | Se skeleton loading |
| Full route recalc | â‰¤1200ms | Progressive loading |
| Pre-ranking (50 items) | â‰¤100ms | LokÃ¡lnÃ­ vÃ½poÄet |

---

### Dependencies

| Knihovna | ÃšÄel | Status |
|----------|------|--------|
| `react-virtuoso` | Virtualizace seznamu | Installed |
| `@dnd-kit/core` | Drag & drop | Installed |
| `zustand` | State management | Installed |
| `date-fns` | Date utilities | Installed |

---

## Phase 9: Planner UI Redesign âœ… COMPLETED

> **Status:** Completed
> **Goal:** PÅ™epis strÃ¡nky `/planner` na pÅ™ehled cest s filtrovÃ¡nÃ­m, detailnÃ­ timeline a uÅ¾ivatelskÃ½mi preferencemi

### Overview

KompletnÃ­ pÅ™epis Planner strÃ¡nky z "PlÃ¡n dne" (DnD, queue preview, inbox drawer) na "PÅ™ehled cest" s filtry, seznamem tras a detailnÃ­ timeline.

### 9.1: DB migrace + Backend preferences âœ…

- Migration `003_add_user_preferences.sql`: `default_crew_id` a `default_depot_id` do `users` tabulky
- RozÅ¡Ã­Å™enÃ­ `UserWithSettings` a `UserPreferences` typÅ¯
- Handler `sazinka.settings.preferences.update` pro uklÃ¡dÃ¡nÃ­ preferencÃ­
- Frontend: `updatePreferences()` v `settingsService.ts`

### 9.2: Backend route filtering âœ…

- NovÃ½ SQL dotaz `list_routes` s filtry (`date_from`, `date_to`, `crew_id`, `depot_id`)
- Handler `sazinka.route.list` + registrace v `mod.rs`
- Frontend: `listRoutes()` v `routeService.ts`

### 9.3: Settings - Moje nastavenÃ­ âœ…

- NovÃ¡ zÃ¡loÅ¾ka "Moje nastavenÃ­" na Settings strÃ¡nce
- `PreferencesForm` s vÃ½bÄ›rem defaultnÃ­ posÃ¡dky a depa
- Hodnoty se uklÃ¡dajÃ­ do DB a pouÅ¾Ã­vajÃ­ jako vÃ½chozÃ­ filtry v Planneru

### 9.4: Frontend komponenty âœ…

- `RouteListPanel` â€” seznam tras s kartami (datum, posÃ¡dka, zastÃ¡vky, vzdÃ¡lenost, Äas)
- `RouteListPanel.test.tsx` â€” 7 testÅ¯
- `RouteDetailTimeline` â€” vertikÃ¡lnÃ­ timeline: depo â†’ segment â†’ zastÃ¡vka â†’ ... â†’ depo
- `RouteDetailTimeline.test.tsx` â€” 7 testÅ¯

### 9.5: KompletnÃ­ pÅ™epis Planner.tsx âœ…

- Filtry: datum (s rozsahem), posÃ¡dka, depo
- UÅ¾ivatelskÃ© preference jako vÃ½chozÃ­ filtry
- `RouteListPanel` v hornÃ­ ÄÃ¡sti sidebaru
- `RouteDetailTimeline` v dolnÃ­ ÄÃ¡sti sidebaru
- Mapa s maplibre-gl (piny, segmenty, highlight)
- KliknutÃ­ na zastÃ¡vku/segment â†’ fly-to na mapÄ›
- PÅ™epis `Planner.module.css` pro novÃ½ layout
- Å½Ã¡dnÃ© linter chyby, vÅ¡echny novÃ© testy prochÃ¡zejÃ­

**Files created:**
- `worker/migrations/003_add_user_preferences.sql`
- `apps/web/src/components/planner/RouteListPanel.tsx`
- `apps/web/src/components/planner/RouteListPanel.module.css`
- `apps/web/src/components/planner/RouteListPanel.test.tsx`
- `apps/web/src/components/planner/RouteDetailTimeline.tsx`
- `apps/web/src/components/planner/RouteDetailTimeline.module.css`
- `apps/web/src/components/planner/RouteDetailTimeline.test.tsx`

**Files modified:**
- `apps/web/src/pages/Planner.tsx` â€” kompletnÃ­ pÅ™epis
- `apps/web/src/pages/Planner.module.css` â€” novÃ½ layout
- `apps/web/src/pages/Settings.tsx` â€” "Moje nastavenÃ­" zÃ¡loÅ¾ka
- `apps/web/src/pages/Settings.module.css` â€” styly pro preferences
- `apps/web/src/services/routeService.ts` â€” `listRoutes()`, `updatePreferences()`
- `apps/web/src/services/settingsService.ts` â€” `updatePreferences()`
- `apps/web/src/components/planner/index.ts` â€” export novÃ½ch komponent
- `worker/src/types/settings.rs` â€” `UserWithSettings` rozÅ¡Ã­Å™enÃ­
- `worker/src/db/queries/settings.rs` â€” preference queries
- `worker/src/db/queries/route.rs` â€” `list_routes` query
- `worker/src/handlers/settings.rs` â€” `handle_update_preferences`
- `worker/src/handlers/route.rs` â€” `handle_list`
- `worker/src/handlers/mod.rs` â€” registrace novÃ½ch subscriptions
- `packages/shared-types/src/settings.ts` â€” `UserPreferences` typ

---

## Post-Phase 9: Unified Route Components + VRP Robustness âœ… COMPLETED

> **Status:** Completed (2026-02-09)
> **Goal:** SjednocenÃ­ komponent pro zobrazenÃ­ trasy (Inbox + Planner) a oprava zaseknutÃ© optimalizace

### Frontend: Unified Route Components âœ…

- `RouteDetailTimeline` â€” sdÃ­lenÃ¡ vertikÃ¡lnÃ­ timeline pro Inbox i Planner
  - Props pro editing (onRemoveStop, onOptimize, onDeleteRoute) volitelnÃ©
  - Status badges (Potvrzeno/Nepotvrzeno), dohodnutÃ© vs. vypoÄÃ­tanÃ© Äasy, warning ikony
  - Segmenty mezi zastÃ¡vkami (km, min)
  - Bidirectional highlight s mapou (highlightedSegment, onStopClick, onSegmentClick)
- `RouteMapPanel` â€” sdÃ­lenÃ¡ mapa pro Inbox i Planner
  - VstupnÃ­ typ sjednocen na `SavedRouteStop[]` (odstranÄ›n `MapStop`)
  - Inbox-only props: `selectedCandidate`, `insertionPreview`
  - Fix: MapLibre "Style is not done loading" â€” map init `useEffect` dependency changed to `[]`
  - Fix: `continue` â†’ `return` in `forEach` callback
- `RouteStopList` â€” ODSTRANÄšN (nahrazen `RouteDetailTimeline`)
- `Planner.tsx` â€” inline MapLibre kÃ³d (~250 Å™Ã¡dkÅ¯) nahrazen `<RouteMapPanel />`
- `PlanningInbox.tsx` â€” `insertionPreview` prop nynÃ­ sprÃ¡vnÄ› pÅ™edÃ¡vÃ¡n do `RouteMapPanel`
- **Inbox/Planner parity hardening (post-unification):**
  - `RouteDetailTimeline` akce sjednoceny na obou strÃ¡nkÃ¡ch: `Optimalizovat`, `PÅ™idat pauzu`, `Smazat trasu`
  - Segmenty v timeline zobrazujÃ­ konzistentnÄ› `Äas odâ€“do`, `km`, `trvÃ¡nÃ­`
  - Metriky planneru pro uloÅ¾enÃ© trasy sjednoceny s Inboxem pouÅ¾itÃ­m persisted route totals
  - InformaÄnÃ­ blok doplnÄ›n o sekundÃ¡rnÃ­ Ãºdaj `z toho jÃ­zda`

### Backend: VRP Solver Timeout âœ…

- `VrpSolver::solve()` je nynÃ­ `async`
  - CPU-bound `solve_pragmatic` zabalena do `tokio::task::spawn_blocking`
  - Hard timeout: `tokio::time::timeout(config.max_time_seconds + 10s)`
  - Fallback na nearest-neighbor heuristiku pÅ™i timeout/panic/error
  - `SOLVER_FALLBACK` warning pÅ™idÃ¡n do solution pÅ™i fallbacku
- `VrpProblem`, `DistanceTimeMatrices`, `SolverConfig` implementujÃ­ `Clone`
- `PlannedRouteStop` mÃ¡ pole `stop_index`
- ÄŒasovÃ¡ okna z revizÃ­ (`scheduled_time_start`/`scheduled_time_end`) se nynÃ­ sprÃ¡vnÄ› pÅ™edÃ¡vajÃ­ do VRP solveru
- DuplicitnÃ­ `tokio::time::timeout` wrapper odstranÄ›n z `handlers/route.rs`
- Opraven formÃ¡t break payloadu pro `vrp-pragmatic` (`required break`: `time + duration`), odstranÄ›n parser fail `VehicleBreak` a nechtÄ›nÃ½ fallback na heuristiku v bÄ›Å¾nÃ©m scÃ©nÃ¡Å™i s pauzou

**Files modified:**
- `apps/web/src/components/planner/RouteDetailTimeline.tsx` + `.module.css`
- `apps/web/src/components/planner/RouteMapPanel.tsx`
- `apps/web/src/components/planner/index.ts`
- `apps/web/src/pages/PlanningInbox.tsx`
- `apps/web/src/pages/Planner.tsx`
- `worker/src/services/vrp/mod.rs`
- `worker/src/handlers/route.rs`
- `worker/src/handlers/jobs.rs`

**Files deleted:**
- `apps/web/src/components/planner/RouteStopList.tsx`
- `apps/web/src/components/planner/RouteStopList.module.css`

---

## Post-Phase 9b: VRP Time Window Mapping + Timeline Rendering Fix âœ… COMPLETED

> **Status:** Completed (2026-02-10)
> **Goal:** Opravit mapovÃ¡nÃ­ ÄasovÃ½ch oken pro VRP solver a UI rendering bug v RouteDetailTimeline

### Backend: VRP Point Time Window Mapping âœ…

- ZÃ¡kaznickÃ¡ nÃ¡vÅ¡tÄ›va `scheduled_time_start`/`scheduled_time_end` se nynÃ­ mapuje jako **pracovnÃ­ slot**, nikoliv rozsah pÅ™Ã­jezdu
- VRP solver dostÃ¡vÃ¡ **bodovÃ© ÄasovÃ© okno** `[start, start]` â€” posÃ¡dka musÃ­ pÅ™ijet pÅ™esnÄ› na zaÄÃ¡tek slotu
- `service_duration_minutes` se poÄÃ­tÃ¡ jako `end - start` (skuteÄnÃ¡ dÃ©lka slotu), ne fixnÃ­ default
- `apply_arrival_buffer` pÅ™eskakuje bodovÃ¡ okna (`start == end`), aby nedoÅ¡lo k neÅ¾Ã¡doucÃ­mu posunu
- Solver odjÃ­Å¾dÃ­ z depa co nejpozdÄ›ji, pÅ™ijÃ­Å¾dÃ­ ke kaÅ¾dÃ©mu zÃ¡kaznÃ­ku na zaÄÃ¡tek jeho slotu
- PÅ™idÃ¡ny unit testy:
  - `build_pragmatic_problem_with_point_time_window_is_valid`
  - `apply_arrival_buffer_noop_for_point_window`
  - `solve_pragmatic_with_point_time_window_assigns_stop`

### Frontend: RouteDetailTimeline Rendering Fix âœ…

- Opravena React "falsy zero" chyba v `RouteDetailTimeline.tsx`
- VÃ½raz `(timeDiffStart && timeDiffStart > 15)` vracel ÄÃ­slo `0` mÃ­sto `false`, kdyÅ¾ `timeDiffStart === 0`
- React vykresloval `0` jako text vedle "Dohodnuto" ÄasÅ¯ (ÄernÃ½ ovÃ¡l s nulou)
- Fix: nahrazeno `timeDiffStart != null && timeDiffStart > 15` pro explicitnÃ­ boolean kontrolu

**Files modified:**
- `worker/src/handlers/route.rs` â€” VRP point time window mapping
- `worker/src/handlers/jobs.rs` â€” VRP point time window mapping
- `worker/src/services/vrp/adapter.rs` â€” `apply_arrival_buffer` skip for point windows + tests
- `worker/src/services/vrp/pragmatic.rs` â€” solver integration test
- `apps/web/src/components/planner/RouteDetailTimeline.tsx` â€” falsy zero rendering fix

---

## Post-Phase 9c: VRP Automatic Break Restoration âœ… COMPLETED

> **Status:** Completed (2026-02-10)
> **Goal:** Obnovit automatickÃ© vklÃ¡dÃ¡nÃ­ pauz do optimalizovanÃ½ch tras

### Bug 1: Break stops dropped in jobs handler âœ…

- `worker/src/handlers/jobs.rs` pÅ™i zpracovÃ¡nÃ­ Å™eÅ¡enÃ­ od VRP solveru ignoroval break zastÃ¡vky
- Loop `for stop in &solution.stops` mÄ›l jen `if let Some(customer) = ...` vÄ›tev
- Break stop s `customer_id.is_nil()` nebyl matchovÃ¡n a tiÅ¡e se zahodil
- **Fix:** PÅ™idÃ¡na `else if stop.customer_id.is_nil()` vÄ›tev pro break zastÃ¡vky (analogie s `route.rs`)

### Bug 2: Break activity timing from stop-level schedule âœ…

- `pragmatic.rs::map_solution` pouÅ¾Ã­val stop-level `schedule.arrival`/`departure` pro break aktivity
- Pokud break sdÃ­lel stop s jinÃ½m jobem, pÅ™iÅ™adil se Äas pÅ™Ã­jezdu na lokaci, ne Äas samotnÃ© pauzy
- PÅ™Ã­klad: vozidlo pÅ™ijelo v 09:15, break mÄ›l bÃ½t 11:30â€“12:15, ale v DB se uloÅ¾ilo 09:15
- **Fix:** Break nynÃ­ pouÅ¾Ã­vÃ¡ `activity.time` (Interval s `start`/`end`) pro pÅ™esnÃ© ÄasovÃ¡nÃ­

### Test: Solver verifikace âœ…

- `solve_pragmatic_with_break_config_includes_break_stop` â€” ovÄ›Å™uje, Å¾e solver vracÃ­ break zastÃ¡vku (nil UUID) a break padne do konfigurovanÃ©ho okna (11:30â€“13:00)

**Files modified:**
- `worker/src/handlers/jobs.rs` â€” break stop handling
- `worker/src/services/vrp/pragmatic.rs` â€” activity-level break timing + test

---

## Phase 10: ZÃ¡znam prÃ¡ce (v2+) - Backlog

> **Status:** Planned backlog (post-v1)
> **Goal:** RozÅ¡Ã­Å™it strÃ¡nku `ZÃ¡znam prÃ¡ce` z rychlÃ©ho dennÃ­ho logu na plnohodnotnÃ½ podklad pro vykazovÃ¡nÃ­ a fakturaci, bez zpomalenÃ­ terÃ©nnÃ­ho flow.

### UX + Filtrace

- PokroÄilÃ© filtry (`stav`, `typ nÃ¡vÅ¡tÄ›vy`, fulltext zÃ¡kaznÃ­k/adresa/poznÃ¡mka)
- AlternativnÃ­ pohledy: kalendÃ¡Å™/timeline, agregace podle zÃ¡kaznÃ­ka
- UloÅ¾itelnÃ© pohledy a rychlÃ© pÅ™epÃ­nÃ¡nÃ­ "Dnes / Tento tÃ½den / VÅ¡e otevÅ™enÃ©"

### ZÃ¡znam prÃ¡ce + Produktivita

- Å ablony textÅ¯ "Co se dÄ›lalo" a doporuÄenÃ© pÅ™edvyplnÄ›nÃ­ podle poslednÃ­ nÃ¡vÅ¡tÄ›vy
- HromadnÃ© akce (dokonÄit, zmÄ›na stavu, pÅ™iÅ™azenÃ­ posÃ¡dky)
- PÅ™ipomÃ­nky na konci dne pro nÃ¡vÅ¡tÄ›vy bez zÃ¡znamu

### MobilnÃ­ terÃ©nnÃ­ reÅ¾im

- Offline-first zÃ¡pis s frontou na synchronizaci po pÅ™ipojenÃ­
- MobilnÃ­ quick actions (swipe dokonÄit/duplikovat) a diktovÃ¡nÃ­
- LepÅ¡Ã­ prÃ¡ce s fotkami v terÃ©nu (PÅ™ed/Po/Detail)

### Reporting + Export

- Souhrny prÃ¡ce za obdobÃ­ (Äas, poÄet zÃ¡sahÅ¯, ÃºspÄ›Å¡nost)
- Export zÃ¡znamÅ¯ prÃ¡ce (CSV/XLSX/PDF) pro zÃ¡kaznÃ­ka, posÃ¡dku a depo
- PÅ™Ã­mÃ© napojenÃ­ na podklady pro fakturaci (Äas + materiÃ¡l + doprava)

### RozÅ¡Ã­Å™enÃ­ domÃ©novÃ©ho modelu (po V1)

- MateriÃ¡lovÃ© poloÅ¾ky na nÃ¡vÅ¡tÄ›vu (`nÃ¡zev`, `mnoÅ¾stvÃ­`, `jednotka`, pozdÄ›ji cena/DPH)
- StrukturovanÃ© ÄasovÃ© vykazovÃ¡nÃ­ (`start/stop`, ruÄnÃ­ dÃ©lka, audit zmÄ›n)
- PotvrzenÃ­ zÃ¡kaznÃ­ka/podpis a sdÃ­lenÃ¡ rekapitulace po dokonÄenÃ­

---

## Out of Scope for v1.0

Explicitly excluded:
- Mobile app
- Multi-tenant/team features (multiple users per account)
- Invoice generation
- Document attachments
- Incoming email processing
- Advanced reporting/analytics
- ~~Multi-region support~~ â†’ Internationalization (i18n) is now **in scope** â€” see `PRJ_I18N.MD`
- RTL languages (Arabic, Hebrew)
- Currency conversion
- Per-tenant locale overrides

---

## Implementation Order

```
Phase 1 (Core Flow): âœ… COMPLETE
  1.1 Device handlers + queries âœ…
  1.2 Revision handlers + queries âœ…
  1.3 Device UI in CustomerDetail âœ…
  1.4 Revision UI components âœ…
  1.5 Dashboard stats âœ…

Phase 2 (Smart Planning): âœ… COMPLETE
  2.1 Calendar with real data âœ…
  2.2 Smart plan suggestion algorithm âœ…
  2.3 Drag/drop + lock/unlock âœ…
  2.4 Route persistence âœ…

Phase 3 (Users & Comms): âœ… COMPLETE
  3.1 Authentication (JWT + roles + worker mgmt) âœ…
  3.2 Settings UI âœ…
  3.3 CSV export âœ…
  3.4 Email reminders (stretch goal - deferred)

Phase 4 (CRM Evidence): âœ… COMPLETE
  4.1 Database migration (communications + visits) âœ…
  4.2 Communication handlers (TDD) âœ…
  4.3 Visit handlers (TDD) âœ…
  4.4 Communication UI components âœ…
  4.5 Visit UI components âœ…
  4.6 Customer Timeline âœ…
  4.7 Dashboard enhancements (deferred)

Phase 5 (Production Readiness): ğŸ”„ IN PROGRESS
  5A: Pre-Launch (MUST HAVE) ğŸ”„
    5A.1 JWT Authentication âœ…
    5A.2 TLS on WebSocket
    5A.3 Rate limiting
    5A.4 Health checks
    5A.5 Managed PostgreSQL
    5A.6 Error tracking (Sentry)
    5A.7 Lazy loading of UI pages
  
  5B: Launch (SHOULD HAVE) ğŸŸ¡
    5B.1 Row Level Security
    5B.2 Billing (Stripe)
    5B.3 Usage metering
    5B.4 Uptime monitoring
    5B.5 Legal documents (ToS, Privacy)
  
  5C: Post-Launch (NICE TO HAVE) ğŸŸ¢
    5C.1 Two-Factor Authentication
    5C.2 OAuth providers
    5C.3 Full observability stack
    5C.4 GDPR compliance tools

Phase 6 (UX Workflow): âœ… COMPLETE
  6A: Call Queue (MVP) âœ…
    6A.1 DB migration (snooze_until, snooze_reason) âœ…
    6A.2 revision.queue endpoint (TDD) âœ…
    6A.3 revision.snooze endpoint (TDD) âœ…
    6A.4 CallQueue page UI âœ…
  
  6B: Schedule Dialog (MVP) âœ…
    6B.1 DB migration (crews table, assigned_crew_id) âœ…
    6B.2 Crew CRUD handlers (TDD) âœ…
    6B.3 ScheduleRevisionDialog component âœ…
  
  6C: Enhanced Day Planner (MVP) âœ…
    6C.1 View tabs: DoporuÄenÃ©/NaplÃ¡novanÃ© âœ…
    6C.2 Time window display âœ…
    6C.3 Scheduled revisions view âœ…
  
  6D: Technician View (MVP) âœ… â†’ MERGED INTO PLANNER
    6D.1 Merged into unified Planner page âœ…
    6D.2 Google Maps export (segmented) âœ…
    6D.3 PDF/Print export âœ…
  
  6E: Smart Slots (V2) âœ…
    6E.1 Insertion heuristic algorithm âœ…
    6E.2 Euclidean distance estimation âœ…
    6E.3 slots.suggest endpoint âœ…
    6E.4 UI integration âœ…
    
  6F: Workflow UI Integration (MVP) âœ…
    6F.1 Dashboard â†’ Call Queue entry + clickable stats âœ…
    6F.2 Call Queue â†’ Planner on scheduled date âœ…
    6F.3 Calendar â†’ Revision detail links âœ…
    6F.4 Planner + TechnicianDay â†’ unified "PlÃ¡n dne" âœ…
    6F.5 RevisionDetail page (workflow hub) âœ…
    6F.6 Call queue preview in Planner âœ…

Phase 7 (JetStream External Services): âœ… COMPLETE
  7A: Valhalla JetStream (Routing) âœ…
    7A.1 ValhallaProcessor skeleton + stream setup âœ…
    7A.2 Matrix job submit/process âœ…
    7A.3 Geometry job submit/process âœ…
    7A.4 Integration with handlers/mod.rs âœ…
  
  7B: Import/Export Jobs âœ…
    7B.1 ImportProcessor skeleton âœ…
    7B.2 Import job types for device/revision/communication/visit âœ…
    7B.3 ExportProcessor skeleton âœ…
    7B.4 Export job types with progress tracking âœ…
  
  7C: Email/SMS Jobs (Skeleton) âœ…
    7C.1 EmailProcessor skeleton (Resend API ready) âœ…
    7C.2 SMSProcessor skeleton (Twilio ready) âœ…
    7C.3 notification_job.rs types âœ…
  
  7D: Unified Jobs Dashboard âœ…
    7D.1 Jobs.tsx page with real-time updates âœ…
    7D.2 JobStatusTimeline component âœ…
    7D.3 Admin actions (cancel, retry) handlers âœ…
    7D.4 Jobs route + navigation link âœ…
    7D.5 Export download action in history (`StÃ¡hnout export`) âœ…

Phase 8 (UX/UI Redesign - Route-Aware Planning): âœ… COMPLETED
  8A: NovÃ½ Inbox Layout + Route Context âœ…
    8A.1 RouteContextHeader komponenta âœ…
    8A.2 SplitView 3-panel layout (desktop) âœ…
    8A.3 CapacityMetrics komponenta âœ…
    8A.4 RouteMapPanel s trasou dne âœ…
    8A.5 PlanningInbox page s integracÃ­ âœ…
  
  8B: Route-Aware pro vybranÃ©ho kandidÃ¡ta âœ…
    8B.1 CandidateRow s Î”km/Î”min âœ…
    8B.2 CandidateDetail panel âœ…
    8B.3 SlotSuggestions s dopady âœ…
    8B.4 InsertionPreview na mapÄ› âœ…
    8B.5 Backend: 1Ã—K + KÃ—1 matrix strategie âœ…
  
  8C: Route-Aware pro celÃ½ list âœ…
    8C.1 VirtualizedInboxList (react-virtuoso) âœ…
    8C.2 ProblemsSegment (nelze geo, chybÃ­ tel) âœ…
    8C.3 routeCacheStore pro cache vÃ½sledkÅ¯ âœ…
    8C.4 Pre-ranking query v backendu (client-side) âœ…
  
  8D: Multi-Crew + Draft Mode + Polish âœ…
    8D.1 MultiCrewTip komponenta âœ…
    8D.2 DraftModeBar pro plÃ¡n dne âœ…
    8D.3 useKeyboardShortcuts hook âœ…
    8D.4 Optimistic UI pro domluvenÃ­ âœ…

Phase 9 (Planner UI Redesign): âœ… COMPLETED
  9.1 DB migrace + Backend preferences âœ…
    9.1.1 Migration 003_add_user_preferences.sql âœ…
    9.1.2 UserWithSettings rozÅ¡Ã­Å™enÃ­ âœ…
    9.1.3 sazinka.settings.preferences.update handler âœ…
  
  9.2 Backend route filtering âœ…
    9.2.1 list_routes SQL query s filtry âœ…
    9.2.2 sazinka.route.list handler âœ…
    9.2.3 Frontend listRoutes() + updatePreferences() âœ…
  
  9.3 Settings - Moje nastavenÃ­ âœ…
    9.3.1 PreferencesForm na Settings strÃ¡nce âœ…
  
  9.4 Frontend komponenty âœ…
    9.4.1 RouteListPanel + testy âœ…
    9.4.2 RouteDetailTimeline + testy âœ…
  
  9.5 KompletnÃ­ pÅ™epis Planner.tsx âœ…
    9.5.1 Filtry (datum, posÃ¡dka, depo) âœ…
    9.5.2 RouteListPanel + RouteDetailTimeline integrace âœ…
    9.5.3 Mapa s highlight âœ…
    9.5.4 PÅ™epis Planner.module.css âœ…

Post-Phase 9 (Unified Components + VRP Fix): âœ… COMPLETED
  Frontend: Unified Route Components âœ…
    - RouteDetailTimeline sdÃ­lenÃ¡ mezi Inbox a Planner âœ…
    - RouteMapPanel sdÃ­lenÃ¡ mezi Inbox a Planner âœ…
    - RouteStopList odstranÄ›n âœ…
    - insertionPreview prop opraven v PlanningInbox âœ…
    - MapLibre "Style is not done loading" fix âœ…
    - Bidirectional highlight (timeline â†” map) âœ…
  
  Backend: VRP Solver Robustness âœ…
    - solver.solve() async + spawn_blocking + timeout âœ…
    - Nearest-neighbor heuristic fallback âœ…
    - Time windows from revisions to VRP solver âœ…
    - Redundant timeout wrapper removed from route.rs âœ…

Phase 10: Smart Slot Heuristics (v0.19.0): âœ… COMPLETED
  Backend: Multi-Crew Slot Suggestion âœ…
    - Shared insertion logic extracted to services/insertion.rs âœ…
    - calculate_insertion_positions() shared by route + slots âœ…
    - sazinka.slots.suggest.v2 handler (multi-crew, Valhalla) âœ…
    - Scoring function (travel 40% + fit 25% + preference 20% + balance 15%) âœ…
    - Real customer coordinates from DB (not fake UUID-based) âœ…
    - Per-crew depot resolution âœ…
    - Scheduled revisions without route included in day stops âœ…
  Backend: Slot Validation âœ…
    - sazinka.slots.validate endpoint âœ…
    - Overlap detection (error) âœ…
    - Unreachable time check (error) âœ…
    - Outside working hours check (error) âœ…
    - No slack warning (<15min) âœ…
    - Overloaded day warning (>90%) âœ…
    - Break conflict warning âœ…
  Backend: Tests âœ…
    - 10 insertion logic unit tests âœ…
    - 11 scoring + validation function tests âœ…
  Frontend: CallQueue UI âœ…
    - slotService.ts v2 types + suggestSlotsV2() + validateSlot() âœ…
    - Crew selector in schedule modal âœ…
    - Slots grouped by crew with load indicator âœ…
    - Status badges (OK / Tight / Conflict) âœ…
    - Real-time validation on manual time input (debounced 500ms) âœ…
    - Warning confirmation before scheduling conflicting slots âœ…
    - groupSuggestionsByCrew() + getStatusColor() utilities âœ…

Phase 11: Internationalization (i18n): ğŸ”² PLANNED
  â†’ Full design: PRJ_I18N.MD
  â†’ TDD approach: Red â†’ Green â†’ Refactor for every step
  â†’ Estimated ~685 translation keys, ~12 days
  
  11.0 Infrastructure (i18n lib, formatters, DB migration, key parity script)
  11.1 Auth pages (Login, Register â€” first thing users see)
  11.2 Shell (Navigation, Layout, ErrorBoundary, common components)
  11.3 Core pages (Dashboard, Calendar, Customers, CustomerDetail)
  11.4 Planning (PlanningInbox, Planner, CandidateDetail, RouteDetailTimeline)
  11.5 Secondary pages (Settings, Jobs, Routes, WorkLog, Import/Export)
  11.6 Stores, services, utilities (Zustand stores, service functions)
  11.7 Shared types (label records â†’ key maps, import aliases)
  11.8 Backend key migration (Rust NATS messages â†’ { key, params } shape)
  11.9 Final verification & cleanup (key parity, dead code, visual check)
```
